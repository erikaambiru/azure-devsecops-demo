name: 2ï¸âƒ£ Board App Build & Deploy

on:
  workflow_dispatch:
    inputs:
      redeployTag:
        description: "ACR ã«æ—¢å­˜ã‚¿ã‚°ãŒã‚ã‚‹å ´åˆã«å†ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ (ç©ºãªã‚‰æœ€æ–°ã‚³ãƒŸãƒƒãƒˆã‚’ãƒ“ãƒ«ãƒ‰)"
        required: false
      resourceGroupName:
        description: "æ—¢å®šå€¤ã‚’ä¸Šæ›¸ãã™ã‚‹ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆã®ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—å"
        required: false
      aksClusterName:
        description: "æ—¢å®šå€¤ã‚’ä¸Šæ›¸ãã™ã‚‹ AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å"
        required: false
  push:
    branches:
      - master
    paths:
      - "app/board-app/**"
      - "app/board-api/**"
      - "app/board-app/k8s/**"
      - ".github/workflows/2-board-app-build-deploy.yml"
  workflow_run:
    workflows:
      - "1ï¸âƒ£ Infrastructure Deploy"
    types:
      - completed

permissions:
  contents: read
  id-token: write
  security-events: write

env:
  RESOURCE_GROUP_NAME: ${{ github.event.inputs.resourceGroupName || vars.RESOURCE_GROUP_NAME }}
  AKS_CLUSTER_NAME: ${{ github.event.inputs.aksClusterName || vars.AKS_CLUSTER_NAME }}
  PARAM_FILE: infra/parameters/main-dev.parameters.json
  KUSTOMIZE_DIR: app/board-app/k8s
  ACR_NAME_PREFIX: ${{ vars.ACR_NAME_PREFIX }}
  STORAGE_ACCOUNT_PREFIX: ${{ vars.STORAGE_ACCOUNT_PREFIX }}
  BOARD_IMAGE_NAME: board-app
  BOARD_API_IMAGE_NAME: board-api
  DB_APP_USERNAME: ${{ vars.DB_APP_USERNAME }}
  DB_APP_PASSWORD: ${{ vars.DB_APP_PASSWORD }}
  GH_TOKEN: ${{ github.token }}

jobs:
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã€‘GitGuardian ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œè¨¼
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ç›®çš„: ãƒ“ãƒ«ãƒ‰å‰ã«ã‚³ãƒŸãƒƒãƒˆã•ã‚ŒãŸã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’æ¤œè¨¼ï¼ˆ400+ ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
  # ä¾å­˜: GitGuardian API Key (Variables)
  # å‡ºåŠ›: SARIF å½¢å¼ã§ GitHub Security ã‚¿ãƒ–ã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  gitguardian-scan:
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    outputs:
      gitguardian_issues: ${{ steps.count_issues.outputs.issues }}
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: GitGuardian API Key ã®ç¢ºèª
        id: check_key
        run: |
          if [ -z "${{ vars.GITGUARDIAN_API_KEY }}" ]; then
            echo "âš ï¸ GitGuardian API Key ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆã‚¹ã‚­ãƒ£ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰"
            echo "è¨­å®šæ–¹æ³•:"
            echo "1. https://dashboard.gitguardian.com/api/personal-access-tokens ã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆ"
            echo "2. Settings â†’ Variables â†’ New repository variable"
            echo "3. Name: GITGUARDIAN_API_KEY, Value: <ç”Ÿæˆã—ãŸãƒˆãƒ¼ã‚¯ãƒ³>"
            echo "has_key=false" >> "$GITHUB_OUTPUT"
          else
            echo "âœ… GitGuardian API Key ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™"
            echo "has_key=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Python ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        if: steps.check_key.outputs.has_key == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: GitGuardian ã‚¹ã‚­ãƒ£ãƒ³
        id: gg_scan
        if: steps.check_key.outputs.has_key == 'true'
        continue-on-error: true
        env:
          GITGUARDIAN_API_KEY: ${{ vars.GITGUARDIAN_API_KEY }}
        run: |
          set +e
          pip install --quiet ggshield

          # ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œã¨ã‚¨ãƒ©ãƒ¼æ•æ‰
          SCAN_OUTPUT=$(ggshield secret scan repo . --json --output gitguardian-results.json 2>&1)
          SCAN_EXIT_CODE=$?

          # ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒã‚§ãƒƒã‚¯
          if echo "$SCAN_OUTPUT" | grep -q "Token is missing the required scope"; then
            echo "::error::âŒ GitGuardian API Key ã« 'scan' ã‚¹ã‚³ãƒ¼ãƒ—ãŒä¸è¶³ã—ã¦ã„ã¾ã™"
            echo ""
            echo "ğŸ“‹ è§£æ±ºæ‰‹é †:"
            echo "1. https://dashboard.gitguardian.com/api/personal-access-tokens ã«ã‚¢ã‚¯ã‚»ã‚¹"
            echo "2. æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½œæˆã—ã€ä»¥ä¸‹ã®ã‚¹ã‚³ãƒ¼ãƒ—ã‚’é¸æŠ:"
            echo "   âœ… scan (å¿…é ˆ)"
            echo "   âœ… incident:read"
            echo "   âœ… incident:write"
            echo "3. GitHub ãƒªãƒã‚¸ãƒˆãƒªã® Settings â†’ Secrets and variables â†’ Variables"
            echo "4. GITGUARDIAN_API_KEY ã‚’æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã§æ›´æ–°"
            echo ""
            echo "è©³ç´°: trouble_docs/2025-11-24-gitguardian-api-key-scope.md"
            echo "scan_error=scope_missing" >> "$GITHUB_OUTPUT"
            exit 1
          elif echo "$SCAN_OUTPUT" | grep -q -E "(401|403|Unauthorized|Forbidden)"; then
            echo "::error::âŒ GitGuardian API Key ãŒç„¡åŠ¹ã¾ãŸã¯æ¨©é™ä¸è¶³ã§ã™"
            echo ""
            echo "ğŸ“‹ è§£æ±ºæ‰‹é †:"
            echo "1. API Key ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª"
            echo "2. API Key ã« 'scan' ã‚¹ã‚³ãƒ¼ãƒ—ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª"
            echo "3. https://dashboard.gitguardian.com/api/personal-access-tokens ã§æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆ"
            echo "scan_error=auth_failed" >> "$GITHUB_OUTPUT"
            exit 1
          elif [ $SCAN_EXIT_CODE -ne 0 ] && [ ! -f gitguardian-results.json ]; then
            echo "::warning::âš ï¸ GitGuardian ã‚¹ã‚­ãƒ£ãƒ³ãŒå¤±æ•—ã—ã¾ã—ãŸãŒã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ç¶™ç¶šã—ã¾ã™"
            echo "$SCAN_OUTPUT"
            echo "scan_error=unknown" >> "$GITHUB_OUTPUT"
          else
            echo "âœ… GitGuardian ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†"
            echo "scan_error=none" >> "$GITHUB_OUTPUT"
          fi

          exit 0

      - name: GitGuardian çµæœã‚’ SARIF å¤‰æ›
        if: always()
        run: |
          # API Key ãŒãªã„å ´åˆã¯ç©ºã® SARIF ã‚’ä½œæˆ
          if [ ! -f gitguardian-results.json ]; then
            echo '{"secrets":[]}' > gitguardian-results.json
          fi

          cat > convert-gg-to-sarif.py << 'PYTHON_SCRIPT'
          import json
          import sys
          from pathlib import Path

          gg_file = Path("gitguardian-results.json")
          if not gg_file.exists():
              print("GitGuardian çµæœãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“", file=sys.stderr)
              sys.exit(1)

          with open(gg_file) as f:
              gg_data = json.load(f)

          sarif = {
              "$schema": "https://json.schemastore.org/sarif-2.1.0.json",
              "version": "2.1.0",
              "runs": [{
                  "tool": {
                      "driver": {
                          "name": "GitGuardian",
                          "informationUri": "https://www.gitguardian.com/",
                          "version": "1.0.0",
                          "rules": []
                      }
                  },
                  "results": []
              }]
          }

          rules_map = {}
          results = []

          for secret in gg_data.get("secrets", []):
              for policy_break in secret.get("policy_breaks", []):
                  detector_type = policy_break.get("type", "unknown")
                  rule_id = f"gitguardian/{detector_type}"
                  
                  if rule_id not in rules_map:
                      rules_map[rule_id] = {
                          "id": rule_id,
                          "name": detector_type,
                          "shortDescription": {"text": f"GitGuardian detected {detector_type}"},
                          "helpUri": "https://docs.gitguardian.com/secrets-detection/detectors"
                      }
                  
                  for match in policy_break.get("matches", []):
                      result = {
                          "ruleId": rule_id,
                          "level": "error",
                          "message": {"text": f"Detected {detector_type} in repository"},
                          "locations": [{
                              "physicalLocation": {
                                  "artifactLocation": {
                                      "uri": match.get("match", "unknown")
                                  },
                                  "region": {
                                      "startLine": match.get("line_start", 1),
                                      "startColumn": 1
                                  }
                              }
                          }],
                          "properties": {
                              "severity": "HIGH"
                          }
                      }
                      results.append(result)

          sarif["runs"][0]["tool"]["driver"]["rules"] = list(rules_map.values())
          sarif["runs"][0]["results"] = results

          with open("gitguardian-repo.sarif", "w") as f:
              json.dump(sarif, f, indent=2)

          print(f"âœ… GitGuardian çµæœã‚’ SARIF ã«å¤‰æ›: {len(results)} ä»¶ã®æ¤œå‡º")
          PYTHON_SCRIPT

          python convert-gg-to-sarif.py

      - name: æ¤œå‡ºæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
        id: count_issues
        if: always()
        run: |
          if [ -f gitguardian-repo.sarif ]; then
            ISSUES=$(jq '.runs[0].results | length' gitguardian-repo.sarif 2>/dev/null || echo "0")
          else
            ISSUES=0
          fi
          echo "issues=$ISSUES" >> "$GITHUB_OUTPUT"
          echo "GitGuardian: $ISSUES ä»¶ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œå‡º"

          # ã‚¹ã‚­ãƒ£ãƒ³ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Œã°ã‚µãƒãƒªã«è¡¨ç¤º
          SCAN_ERROR="${{ steps.gg_scan.outputs.scan_error || 'none' }}"
          HAS_KEY="${{ steps.check_key.outputs.has_key }}"

          if [ -n "${GITHUB_STEP_SUMMARY:-}" ]; then
            if [ "$HAS_KEY" != "true" ]; then
              {
                echo "## âš ï¸ GitGuardian ã‚¹ã‚­ãƒ£ãƒ³: API Key æœªè¨­å®š"
                echo ""
                echo "GitGuardian API Key ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ãŸã‚ã€ã‚¹ã‚­ãƒ£ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚"
                echo ""
                echo "### ğŸ“‹ è¨­å®šæ‰‹é †"
                echo "1. [GitGuardian Dashboard](https://dashboard.gitguardian.com/api/personal-access-tokens) ã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆ"
                echo "2. å¿…è¦ãªã‚¹ã‚³ãƒ¼ãƒ—: **scan** (å¿…é ˆ), incident:read, incident:write"
                echo "3. GitHub ãƒªãƒã‚¸ãƒˆãƒªã® Settings â†’ Secrets and variables â†’ Variables"
                echo "4. Name: \`GITGUARDIAN_API_KEY\`, Value: ç”Ÿæˆã—ãŸãƒˆãƒ¼ã‚¯ãƒ³"
              } >> "$GITHUB_STEP_SUMMARY"
            elif [ "$SCAN_ERROR" = "scope_missing" ]; then
              {
                echo "## âŒ GitGuardian ã‚¹ã‚­ãƒ£ãƒ³: 'scan' ã‚¹ã‚³ãƒ¼ãƒ—ä¸è¶³"
                echo ""
                echo "API Key ã«å¿…é ˆã® **scan** ã‚¹ã‚³ãƒ¼ãƒ—ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚"
                echo ""
                echo "### ğŸ“‹ è§£æ±ºæ‰‹é †"
                echo "1. [GitGuardian Dashboard](https://dashboard.gitguardian.com/api/personal-access-tokens) ã«ã‚¢ã‚¯ã‚»ã‚¹"
                echo "2. æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½œæˆã—ã€ä»¥ä¸‹ã®ã‚¹ã‚³ãƒ¼ãƒ—ã‚’é¸æŠ:"
                echo "   - âœ… **scan** (å¿…é ˆ)"
                echo "   - âœ… incident:read"
                echo "   - âœ… incident:write"
                echo "3. GitHub ãƒªãƒã‚¸ãƒˆãƒªã® Settings â†’ Variables ã§ \`GITGUARDIAN_API_KEY\` ã‚’æ›´æ–°"
                echo ""
                echo "ğŸ“– è©³ç´°: \`trouble_docs/2025-11-24-gitguardian-api-key-scope.md\`"
              } >> "$GITHUB_STEP_SUMMARY"
            elif [ "$SCAN_ERROR" = "auth_failed" ]; then
              {
                echo "## âŒ GitGuardian ã‚¹ã‚­ãƒ£ãƒ³: èªè¨¼ã‚¨ãƒ©ãƒ¼"
                echo ""
                echo "API Key ãŒç„¡åŠ¹ã¾ãŸã¯æ¨©é™ä¸è¶³ã§ã™ã€‚"
                echo ""
                echo "### ğŸ“‹ è§£æ±ºæ‰‹é †"
                echo "1. API Key ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª"
                echo "2. [GitGuardian Dashboard](https://dashboard.gitguardian.com/api/personal-access-tokens) ã§æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆ"
                echo "3. **scan** ã‚¹ã‚³ãƒ¼ãƒ—ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª"
                echo "4. GitHub Variables ã§ \`GITGUARDIAN_API_KEY\` ã‚’æ›´æ–°"
              } >> "$GITHUB_STEP_SUMMARY"
            elif [ "$SCAN_ERROR" != "none" ]; then
              {
                echo "## âš ï¸ GitGuardian ã‚¹ã‚­ãƒ£ãƒ³: ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ"
                echo ""
                echo "ã‚¹ã‚­ãƒ£ãƒ³ä¸­ã«äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸãŒã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ç¶™ç¶šã—ã¾ã™ã€‚"
              } >> "$GITHUB_STEP_SUMMARY"
            fi
          fi

      - name: GitGuardian SARIF ã‚’ GitHub Security ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: steps.check_key.outputs.has_key == 'true'
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: gitguardian-repo.sarif
          category: gitguardian

      - name: GitGuardian çµæœã‚’ Artifact ã¨ã—ã¦ä¿å­˜
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gitguardian-results
          path: |
            gitguardian-repo.sarif
            gitguardian-results.json
          retention-days: 7

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ã€æº–å‚™ãƒ•ã‚§ãƒ¼ã‚ºã€‘ãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆåé›†
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ç›®çš„: ãƒ‡ãƒ—ãƒ­ã‚¤ã«å¿…è¦ãªå…¨ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã‚’ Azure ã‹ã‚‰å‹•çš„ã«åé›†ãƒ»æ¤œè¨¼
  # å‡ºåŠ›: ACRåã€DB endpointã€Ingress IPã€ãƒãƒ¼ãƒ‰RGã€FQDN ãªã©
  # ä¾å­˜: Azure CLI, jq, gh CLI
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  prepare-context:
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    outputs:
      checkout_ref: ${{ steps.detect_ref.outputs.checkout_ref }}
      image_tag: ${{ steps.detect_ref.outputs.image_tag }}
      build_required: ${{ steps.detect_ref.outputs.build_required }}
      acr_name: ${{ steps.resolve_acr.outputs.acr_name }}
      acr_login_server: ${{ steps.resolve_acr.outputs.acr_login_server }}
      resource_group_name: ${{ steps.resolve_rg.outputs.resource_group_name }}
      db_endpoint: ${{ steps.mysql_endpoint.outputs.db_endpoint }}
      aks_location: ${{ steps.aks_info.outputs.aks_location }}
      node_resource_group: ${{ steps.aks_info.outputs.node_resource_group }}
    env:
      REDEPLOY_TAG: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.redeployTag || '' }}
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
        uses: actions/checkout@v4

      - name: ãƒ“ãƒ«ãƒ‰å¯¾è±¡ã‚³ãƒŸãƒƒãƒˆã¨ã‚¿ã‚°ã‚’æ±ºå®š
        id: detect_ref
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            REF='${{ github.event.workflow_run.head_sha }}'
          else
            REF='${{ github.sha }}'
          fi
          BUILD_REQUIRED=true
          IMAGE_TAG=""
          if [ -n "${REDEPLOY_TAG}" ]; then
            BUILD_REQUIRED=false
            IMAGE_TAG="${REDEPLOY_TAG}"
          fi
          if [ -z "$IMAGE_TAG" ]; then
            SHORT_REF="${REF:0:12}"
            IMAGE_TAG="$SHORT_REF"
          fi
          echo "checkout_ref=$REF" >> "$GITHUB_OUTPUT"
          echo "image_tag=$IMAGE_TAG" >> "$GITHUB_OUTPUT"
          echo "build_required=$BUILD_REQUIRED" >> "$GITHUB_OUTPUT"
          echo "ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚³ãƒŸãƒƒãƒˆ: $REF (tag=$IMAGE_TAG, build_required=$BUILD_REQUIRED)"

      - name: Azure ã« Service Principal ã§ãƒ­ã‚°ã‚¤ãƒ³
        uses: azure/login@v2
        with:
          creds: >-
            {"clientId":"${{ vars.AZURE_CLIENT_ID }}","tenantId":"${{ vars.AZURE_TENANT_ID }}","clientSecret":"${{ vars.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}"}

      - name: ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’è§£æ±º
        id: resolve_rg
        run: |
          set -euo pipefail
          RG_NAME="${RESOURCE_GROUP_NAME}"
          if [ -z "$RG_NAME" ]; then
            RG_NAME=$(jq -r '.parameters.resourceGroupName.value // empty' "$PARAM_FILE" || true)
          fi
          if [ -z "$RG_NAME" ]; then
            echo "ResourceGroup ã‚’ç‰¹å®šã§ãã¾ã›ã‚“" >&2
            exit 1
          fi
          if ! az group show --name "$RG_NAME" &>/dev/null; then
            echo "æŒ‡å®š RG ($RG_NAME) ãŒå­˜åœ¨ã—ã¾ã›ã‚“" >&2
            az group list --query '[].name' -o tsv >&2 || true
            exit 2
          fi
          echo "resource_group_name=$RG_NAME" >> "$GITHUB_OUTPUT"

      - name: ACR åã‚’è§£æ±º
        id: resolve_acr
        env:
          RESOLVED_RG: ${{ steps.resolve_rg.outputs.resource_group_name }}
        run: |
          set -euo pipefail
          if [ -z "$ACR_NAME_PREFIX" ] || [ -z "$RESOLVED_RG" ]; then
            echo "ACR ã‚’è§£æ±ºã™ã‚‹ãŸã‚ã®å¤‰æ•°ãŒä¸è¶³ã—ã¦ã„ã¾ã™" >&2
            exit 1
          fi
          ACR_NAME=$(az acr list --resource-group "$RESOLVED_RG" --query "[?starts_with(name, '${ACR_NAME_PREFIX}')].name | [0]" -o tsv)
          if [ -z "$ACR_NAME" ]; then
            echo "ACR ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚infra-deploy ã‚’å…ˆã«å®Ÿè¡Œã—ã¦ãã ã•ã„" >&2
            exit 1
          fi
          echo "acr_name=$ACR_NAME" >> "$GITHUB_OUTPUT"
          echo "acr_login_server=${ACR_NAME}.azurecr.io" >> "$GITHUB_OUTPUT"
          echo "resource_group_name=$RESOLVED_RG" >> "$GITHUB_OUTPUT"

      - name: AKS ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆä¸¦åˆ—åŒ–æœ€é©åŒ–ï¼‰
        id: aks_info
        env:
          RESOLVED_RG: ${{ steps.resolve_rg.outputs.resource_group_name }}
        run: |
          set -euo pipefail
          if [ -z "$AKS_CLUSTER_NAME" ]; then
            echo "AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼åãŒæœªè¨­å®šã§ã™" >&2
            exit 1
          fi
          # è¤‡æ•°ã‚¯ã‚¨ãƒªã‚’1å›ã®JMESPathã§ä¸¦åˆ—å–å¾—ï¼ˆé«˜é€ŸåŒ–ï¼‰
          AKS_JSON=$(az aks show --resource-group "$RESOLVED_RG" --name "$AKS_CLUSTER_NAME" \
            --query '{location: location, nodeResourceGroup: nodeResourceGroup}' -o json 2>/dev/null || true)

          if [ -z "$AKS_JSON" ] || [ "$AKS_JSON" = "null" ]; then
            echo "AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ $AKS_CLUSTER_NAME ã‚’ RG=$RESOLVED_RG ã§å–å¾—ã§ãã¾ã›ã‚“" >&2
            exit 1
          fi

          # JSON ã‹ã‚‰å€¤ã‚’æŠ½å‡º
          NODE_RG=$(echo "$AKS_JSON" | jq -r '.nodeResourceGroup // empty')
          AKS_LOCATION=$(echo "$AKS_JSON" | jq -r '.location // empty')

          if [ -z "$NODE_RG" ]; then
            echo "AKS ãƒãƒ¼ãƒ‰ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’è§£æ±ºã§ãã¾ã›ã‚“" >&2
            exit 1
          fi

          echo "âœ… å–å¾—ã—ãŸãƒãƒ¼ãƒ‰ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—: $NODE_RG"
          echo "âœ… AKS ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³: $AKS_LOCATION"

          # ãƒãƒ¼ãƒ‰ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã®å­˜åœ¨ç¢ºèª
          if ! az group show --name "$NODE_RG" --query 'name' -o tsv &>/dev/null; then
            echo "âš ï¸ ãƒãƒ¼ãƒ‰ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ— '$NODE_RG' ãŒå­˜åœ¨ã—ã¾ã›ã‚“" >&2
            echo "åˆ©ç”¨å¯èƒ½ãªãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ä¸€è¦§:" >&2
            az group list --query '[].name' -o tsv >&2
            exit 1
          fi

          echo "node_resource_group=$NODE_RG" >> "$GITHUB_OUTPUT"
          if [ -n "$AKS_LOCATION" ]; then
            echo "aks_location=$AKS_LOCATION" >> "$GITHUB_OUTPUT"
          fi

      - name: ã‚¤ãƒ³ãƒ•ãƒ©å‡ºåŠ›ã‹ã‚‰ MySQL Private IP ã‚’å–å¾—ï¼ˆä¸¦åˆ—åŒ–æœ€é©åŒ–ï¼‰
        id: mysql_endpoint
        env:
          INFRA_WORKFLOW_NAME: "1ï¸âƒ£ Infrastructure Deploy"
          RESOLVED_RG: ${{ steps.resolve_rg.outputs.resource_group_name }}
          NODE_RESOURCE_GROUP: ${{ steps.aks_info.outputs.node_resource_group }}
        run: |
          set -euo pipefail
          mkdir -p infra-output
          MYSQL_IP=""
          OUTPUT_FILE=""
          if [ "${{ github.event_name }}" = "workflow_run" ] && [ "${{ github.event.workflow_run.name }}" = "$INFRA_WORKFLOW_NAME" ]; then
            TARGET_RUN_ID='${{ github.event.workflow_run.id }}'
          else
            TARGET_RUN_ID=$(curl -s -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/repos/${{ github.repository }}/actions/workflows/1-infra-deploy.yml/runs?status=success&per_page=1" \
              | jq -r '.workflow_runs[0].id')
          fi
          if [ -n "$TARGET_RUN_ID" ] && [ "$TARGET_RUN_ID" != "null" ]; then
            if gh run download "$TARGET_RUN_ID" --name infra-outputs --dir infra-output >/dev/null 2>&1; then
              OUTPUT_FILE=$(find infra-output -name '*.json' | head -n1)
              if [ -n "$OUTPUT_FILE" ]; then
                MYSQL_IP=$(jq -r '.mysqlPrivateIp.value // empty' "$OUTPUT_FILE")
              fi
            fi
          fi
          if [ -z "$MYSQL_IP" ]; then
            echo "infra-outputs ã‹ã‚‰ MySQL IP ã‚’å–å¾—ã§ããªã‹ã£ãŸãŸã‚ Azure ãƒªã‚½ãƒ¼ã‚¹ã‹ã‚‰è§£æ±ºã—ã¾ã™" >&2
            VM_NAME=$(jq -r '.parameters.vmName.value // empty' "$PARAM_FILE")
            if [ -z "$VM_NAME" ]; then
              echo "parameters ãƒ•ã‚¡ã‚¤ãƒ«ã« vmName ãŒå­˜åœ¨ã—ã¾ã›ã‚“" >&2
              exit 1
            fi
            # JMESPathã§å¿…è¦ãªå€¤ã®ã¿å–å¾—ï¼ˆé«˜é€ŸåŒ–ï¼‰
            MYSQL_IP=$(az vm list-ip-addresses --resource-group "$RESOLVED_RG" --name "$VM_NAME" \
              --query "[0].virtualMachine.network.privateIpAddresses[0]" -o tsv || true)
          fi
          MYSQL_PORT=$(jq -r '.parameters.mysqlPort.value // 3306' "$PARAM_FILE")
          if [ -z "$MYSQL_IP" ] || [ "$MYSQL_IP" = "null" ]; then
            echo "MySQL Private IP ã‚’ Azure ã‹ã‚‰å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ" >&2
            exit 1
          fi
          echo "db_endpoint=${MYSQL_IP}:${MYSQL_PORT}" >> "$GITHUB_OUTPUT"
          echo "Resolved MySQL endpoint: ${MYSQL_IP}:${MYSQL_PORT}"

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã€‘ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ™ãƒ«ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ç›®çš„: Gitleaks (ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ) + Trivy FS (è„†å¼±æ€§) ã®æ¤œå‡º
  # æˆæœç‰©: SARIF ãƒ¬ãƒãƒ¼ãƒˆ â†’ GitHub Security ã‚¿ãƒ–
  # ã‚¿ã‚¤ãƒŸãƒ³ã‚°: prepare-contextã«ä¾å­˜ã™ã‚‹ãŒãƒ“ãƒ«ãƒ‰ã¨ã¯ä¸¦åˆ—å®Ÿè¡Œå¯èƒ½
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  code-security-scans:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write # SARIF ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§å¿…è¦
    needs: prepare-context
    # å®Ÿè¡Œæ¡ä»¶: prepare-contextæˆåŠŸæ™‚ï¼ˆãƒ“ãƒ«ãƒ‰ä¸è¦ã§ã‚‚å®Ÿè¡Œã—ã¦ä¸¦åˆ—åŒ–ï¼‰
    if: ${{ needs.prepare-context.result == 'success' }}
    outputs:
      gitleaks_issues: ${{ steps.scan_summary.outputs.gitleaks_issues }}
      trivy_fs_critical: ${{ steps.scan_summary.outputs.trivy_fs_critical }}
      trivy_fs_high: ${{ steps.scan_summary.outputs.trivy_fs_high }}
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare-context.outputs.checkout_ref }}

      - name: Gitleaks ã§ç§˜å¯†æƒ…å ±ã‚’æ¤œå‡º
        continue-on-error: true
        run: |
          set +e
          VERSION="8.18.4"
          curl -sSL "https://github.com/gitleaks/gitleaks/releases/download/v${VERSION}/gitleaks_${VERSION}_linux_x64.tar.gz" -o gitleaks.tgz
          tar -xzf gitleaks.tgz gitleaks
          sudo install -m 755 gitleaks /usr/local/bin/gitleaks
          gitleaks detect --no-banner --report-format sarif --report-path gitleaks-board.sarif
          echo "Gitleaks completed (exit code=$?)"

      - name: ã‚½ãƒ¼ã‚¹/è¨­å®š/ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç·åˆã‚¹ã‚­ãƒ£ãƒ³ (Trivy FS)
        continue-on-error: true
        run: |
          set -euo pipefail
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b ./trivy-bin
          ./trivy-bin fs --scanners vuln,secret,config --ignore-unfixed --severity CRITICAL,HIGH \
            --format sarif --output trivy-fs-board.sarif app/board-app || echo "è„†å¼±æ€§æ¤œå‡ºã‚ã‚Š"

      - name: Trivy FS ãƒ¬ãƒãƒ¼ãƒˆã‚’ä¿è¨¼
        if: always()
        run: |
          set -euo pipefail
          if [ ! -f trivy-fs-board.sarif ]; then
            MESSAGE="Trivy FS ãŒå¤±æ•—/çµæœãªã—ã§ã‚‚ SARIF ã‚’æ¬ ã‹ã•ãšã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãŸã‚ç©ºãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¾ã—ãŸ (Board App)"
            echo "$MESSAGE"
            printf '%s\n' \
              '{' \
              '  "version": "2.1.0",' \
              '  "runs": [' \
              '    {' \
              '      "tool": {' \
              '        "driver": {' \
              '          "name": "trivy",' \
              '          "informationUri": "https://github.com/aquasecurity/trivy"' \
              '        }' \
              '      },' \
              '      "results": []' \
              '    }' \
              '  ]' \
              '}' > trivy-fs-board.sarif
          fi

      - name: Trivy FS ã‚¹ã‚­ãƒ£ãƒ³çµæœã‚µãƒãƒª
        if: always()
        run: |
          set -euo pipefail
          if [ ! -f trivy-fs-board.sarif ]; then
            echo "âš ï¸ SARIF ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 0
          fi

          # æ¤œå‡ºä»¶æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
          TOTAL=$(jq '[.runs[]?.results[]?] | length' trivy-fs-board.sarif 2>/dev/null || echo "0")

          echo "## ğŸ›¡ï¸ Trivy FS ã‚¹ã‚­ãƒ£ãƒ³çµæœ (Board App)"
          if [ "$TOTAL" = "0" ]; then
            echo "âœ… æ¤œå‡ºãªã— - è„†å¼±æ€§ãƒ»ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒ»è¨­å®šãƒŸã‚¹ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
          else
            echo "âš ï¸ $TOTAL ä»¶ã®å•é¡Œã‚’æ¤œå‡º"

            # æ·±åˆ»åº¦åˆ¥ã‚«ã‚¦ãƒ³ãƒˆ
            CRITICAL=$(jq '[.runs[]?.results[]? | select(.properties.severity == "CRITICAL" or .properties["security-severity"] == "10.0")] | length' trivy-fs-board.sarif 2>/dev/null || echo "0")
            HIGH=$(jq '[.runs[]?.results[]? | select(.properties.severity == "HIGH" or (.properties["security-severity"] | tonumber) >= 7.0)] | length' trivy-fs-board.sarif 2>/dev/null || echo "0")
            MEDIUM=$(jq '[.runs[]?.results[]? | select(.properties.severity == "MEDIUM" or ((.properties["security-severity"] | tonumber) >= 4.0 and (.properties["security-severity"] | tonumber) < 7.0))] | length' trivy-fs-board.sarif 2>/dev/null || echo "0")

            echo "ğŸ“Š æ·±åˆ»åº¦åˆ¥"
            echo "- CRITICAL: $CRITICAL ä»¶"
            echo "- HIGH: $HIGH ä»¶"
            echo "- MEDIUM: $MEDIUM ä»¶"

            echo "ğŸ” ä¸»ãªæ¤œå‡ºé …ç›®ï¼ˆä¸Šä½5ä»¶ï¼‰"
            jq -r '.runs[]?.results[0:5]? | .[] | 
              "- **\(.properties.severity // "UNKNOWN")** / `\(.ruleId // "ä¸æ˜")`\n" +
              "  - `\(.locations[0].physicalLocation.artifactLocation.uri // "ä¸æ˜"):\(.locations[0].physicalLocation.region.startLine // 0)`\n" +
              "  - \(.message.text // "è©³ç´°ãªã—" | gsub("\n"; " "))\n"' \
              trivy-fs-board.sarif 2>/dev/null || echo "- (è©³ç´°å–å¾—å¤±æ•—)"
          fi

          echo "ğŸ“ ã‚¹ã‚­ãƒ£ãƒ³ç¯„å›²: app/board-app"
          echo "ğŸ” æ¤œå‡ºç¨®åˆ¥: vuln + secret + config"
          echo "âš™ï¸ æ¡ä»¶: CRITICAL/HIGH (unfixed é™¤å¤–)"

      - name: Trivy SARIF ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (FS)
        if: always()
        continue-on-error: true
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-fs-board.sarif
          category: board-app-trivy-fs

      - name: Gitleaks SARIF ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: always()
        continue-on-error: true
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: gitleaks-board.sarif
          category: board-app-gitleaks

      - name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµæœã‚’é›†è¨ˆ
        id: scan_summary
        if: always()
        run: |
          set +e
          # Gitleaksçµæœ
          GITLEAKS_ISSUES=0
          if [ -f gitleaks-board.sarif ]; then
            GITLEAKS_ISSUES=$(jq '[.runs[].results // []] | add | length' gitleaks-board.sarif 2>/dev/null || echo "0")
          fi
          echo "gitleaks_issues=$GITLEAKS_ISSUES" >> "$GITHUB_OUTPUT"

          # Trivy FSçµæœ
          TRIVY_FS_CRITICAL=0
          TRIVY_FS_HIGH=0
          if [ -f trivy-fs-board.sarif ]; then
            TRIVY_FS_CRITICAL=$(jq '[.runs[].results[] | select(.level == "error")] | length' trivy-fs-board.sarif 2>/dev/null || echo "0")
            TRIVY_FS_HIGH=$(jq '[.runs[].results[] | select(.level == "warning")] | length' trivy-fs-board.sarif 2>/dev/null || echo "0")
          fi
          echo "trivy_fs_critical=$TRIVY_FS_CRITICAL" >> "$GITHUB_OUTPUT"
          echo "trivy_fs_high=$TRIVY_FS_HIGH" >> "$GITHUB_OUTPUT"

      - name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ SARIF ã‚’ Artifact ã¨ã—ã¦ä¿å­˜
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-security-scans-sarif
          path: |
            gitleaks-board.sarif
            trivy-fs-board.sarif
          retention-days: 7
          if-no-files-found: warn

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ã€ãƒ“ãƒ«ãƒ‰ãƒ•ã‚§ãƒ¼ã‚ºã€‘Board App ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ & ACR ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆä¸¦åˆ—åŒ–ï¼‰
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ç›®çš„: Board App ã®ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ ACR ã«ãƒ—ãƒƒã‚·ãƒ¥
  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: Trivy ã§ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¹ã‚­ãƒ£ãƒ³ã€SBOM ç”Ÿæˆ
  # æˆæœç‰©: ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã€SBOM (CycloneDX)ã€SARIF ãƒ¬ãƒãƒ¼ãƒˆ
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  build-board-app:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write # SARIF ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§å¿…è¦
    needs: prepare-context
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # å®Ÿè¡Œæ¡ä»¶: prepare-contextæˆåŠŸæ™‚ï¼ˆBoard APIã¨ä¸¦åˆ—å®Ÿè¡Œï¼‰
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    if: ${{ needs.prepare-context.outputs.build_required == 'true' }}
    outputs:
      board_image_full: ${{ steps.metadata.outputs.board_image_full }}
      board_image_critical: ${{ steps.image_scan_summary.outputs.board_image_critical }}
      board_image_high: ${{ steps.image_scan_summary.outputs.board_image_high }}
    env:
      CHECKOUT_REF: ${{ needs.prepare-context.outputs.checkout_ref }}
      IMAGE_TAG: ${{ needs.prepare-context.outputs.image_tag }}
      ACR_NAME: ${{ needs.prepare-context.outputs.acr_name }}
      ACR_LOGIN_SERVER: ${{ needs.prepare-context.outputs.acr_login_server }}
      BUILD_REQUIRED: ${{ needs.prepare-context.outputs.build_required }}
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
        uses: actions/checkout@v4
        with:
          ref: ${{ env.CHECKOUT_REF }}

      - name: ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        id: metadata
        run: |
          IMAGE_FULL="$ACR_LOGIN_SERVER/$BOARD_IMAGE_NAME:$IMAGE_TAG"
          echo "board_image_full=$IMAGE_FULL" >> "$GITHUB_OUTPUT"
          echo "IMAGE_FULL=$IMAGE_FULL" >> "$GITHUB_ENV"

      - name: Azure ã« Service Principal ã§ãƒ­ã‚°ã‚¤ãƒ³
        uses: azure/login@v2
        with:
          creds: >-
            {"clientId":"${{ vars.AZURE_CLIENT_ID }}","tenantId":"${{ vars.AZURE_TENANT_ID }}","clientSecret":"${{ vars.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}"}

      - name: ACR ç®¡ç†è€…èªè¨¼ã‚’æœ‰åŠ¹åŒ–
        run: az acr update --name "$ACR_NAME" --admin-enabled true

      - name: ACR ç®¡ç†è€…è³‡æ ¼æƒ…å ±ã‚’å–å¾—
        id: acr_creds
        run: |
          set -euo pipefail
          USERNAME=$(az acr credential show --name "$ACR_NAME" --query username -o tsv)
          PASSWORD=$(az acr credential show --name "$ACR_NAME" --query "passwords[0].value" -o tsv)
          echo "::add-mask::$PASSWORD"
          echo "username=$USERNAME" >> "$GITHUB_OUTPUT"
          echo "password=$PASSWORD" >> "$GITHUB_OUTPUT"

      - name: Docker ã«ãƒ­ã‚°ã‚¤ãƒ³ (ACR)
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_LOGIN_SERVER }}
          username: ${{ steps.acr_creds.outputs.username }}
          password: ${{ steps.acr_creds.outputs.password }}

      - name: Docker Buildx ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: docker/setup-buildx-action@v3

      - name: Board App ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰&ãƒ—ãƒƒã‚·ãƒ¥ (ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹)
        uses: docker/build-push-action@v5
        with:
          context: app/board-app
          file: app/board-app/Dockerfile
          push: true
          tags: |
            ${{ steps.metadata.outputs.board_image_full }}
            ${{ env.ACR_LOGIN_SERVER }}/${{ env.BOARD_IMAGE_NAME }}:latest
          cache-from: type=gha,scope=board-app
          cache-to: type=gha,scope=board-app,mode=max

      - name: Trivy DB ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¾©å…ƒ
        uses: actions/cache@v4
        with:
          path: ~/.cache/trivy
          key: trivy-db-${{ runner.os }}-${{ hashFiles('app/board-app/package.json') }}
          restore-keys: |
            trivy-db-${{ runner.os }}-

      - name: ã‚³ãƒ³ãƒ†ãƒŠ SBOM ç”Ÿæˆ (Board)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ steps.metadata.outputs.board_image_full }}
          format: "cyclonedx"
          output: "sbom-board.cdx.json"
          hide-progress: true
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH"
          exit-code: "0"

      - name: Trivy ã§ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¹ã‚­ãƒ£ãƒ³ (Board)
        uses: aquasecurity/trivy-action@0.28.0
        continue-on-error: true
        with:
          image-ref: ${{ steps.metadata.outputs.board_image_full }}
          format: "sarif"
          output: "trivy-image-board.sarif"
          hide-progress: true
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH"
          exit-code: "0"

      - name: Trivy SARIF ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: always()
        continue-on-error: true
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-image-board.sarif
          category: board-app-trivy-image

      - name: ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¹ã‚­ãƒ£ãƒ³çµæœã‚’é›†è¨ˆ
        id: image_scan_summary
        if: always()
        run: |
          set +e
          BOARD_IMAGE_CRITICAL=0
          BOARD_IMAGE_HIGH=0
          if [ -f trivy-image-board.sarif ]; then
            BOARD_IMAGE_CRITICAL=$(jq '[.runs[].results[] | select(.level == "error")] | length' trivy-image-board.sarif 2>/dev/null || echo "0")
            BOARD_IMAGE_HIGH=$(jq '[.runs[].results[] | select(.level == "warning")] | length' trivy-image-board.sarif 2>/dev/null || echo "0")
          fi
          echo "board_image_critical=$BOARD_IMAGE_CRITICAL" >> "$GITHUB_OUTPUT"
          echo "board_image_high=$BOARD_IMAGE_HIGH" >> "$GITHUB_OUTPUT"

      - name: æˆæœãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        uses: actions/upload-artifact@v4
        with:
          name: board-app-image
          path: |
            sbom-board.cdx.json
            trivy-image-board.sarif

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ã€ãƒ“ãƒ«ãƒ‰ãƒ•ã‚§ãƒ¼ã‚ºã€‘Board API ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ & ACR ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆä¸¦åˆ—åŒ–ï¼‰
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ç›®çš„: Board API ã®ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ ACR ã«ãƒ—ãƒƒã‚·ãƒ¥
  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: Trivy ã§ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¹ã‚­ãƒ£ãƒ³ã€SBOM ç”Ÿæˆ
  # æˆæœç‰©: ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã€SBOM (CycloneDX)ã€SARIF ãƒ¬ãƒãƒ¼ãƒˆ
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  build-board-api:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write # SARIF ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§å¿…è¦
    needs: prepare-context
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # å®Ÿè¡Œæ¡ä»¶: prepare-contextæˆåŠŸæ™‚ï¼ˆBoard Appã¨ä¸¦åˆ—å®Ÿè¡Œï¼‰
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    if: ${{ needs.prepare-context.outputs.build_required == 'true' }}
    outputs:
      board_api_image_full: ${{ steps.metadata.outputs.board_api_image_full }}
      api_image_critical: ${{ steps.image_scan_summary.outputs.api_image_critical }}
      api_image_high: ${{ steps.image_scan_summary.outputs.api_image_high }}
    env:
      CHECKOUT_REF: ${{ needs.prepare-context.outputs.checkout_ref }}
      IMAGE_TAG: ${{ needs.prepare-context.outputs.image_tag }}
      ACR_NAME: ${{ needs.prepare-context.outputs.acr_name }}
      ACR_LOGIN_SERVER: ${{ needs.prepare-context.outputs.acr_login_server }}
      BUILD_REQUIRED: ${{ needs.prepare-context.outputs.build_required }}
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
        uses: actions/checkout@v4
        with:
          ref: ${{ env.CHECKOUT_REF }}

      - name: ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        id: metadata
        run: |
          BOARD_API_IMAGE_FULL="$ACR_LOGIN_SERVER/$BOARD_API_IMAGE_NAME:$IMAGE_TAG"
          echo "board_api_image_full=$BOARD_API_IMAGE_FULL" >> "$GITHUB_OUTPUT"
          echo "BOARD_API_IMAGE_FULL=$BOARD_API_IMAGE_FULL" >> "$GITHUB_ENV"

      - name: Azure ã« Service Principal ã§ãƒ­ã‚°ã‚¤ãƒ³
        uses: azure/login@v2
        with:
          creds: >-
            {"clientId":"${{ vars.AZURE_CLIENT_ID }}","tenantId":"${{ vars.AZURE_TENANT_ID }}","clientSecret":"${{ vars.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}"}

      - name: ACR ç®¡ç†è€…èªè¨¼ã‚’æœ‰åŠ¹åŒ–
        run: az acr update --name "$ACR_NAME" --admin-enabled true

      - name: ACR ç®¡ç†è€…è³‡æ ¼æƒ…å ±ã‚’å–å¾—
        id: acr_creds
        run: |
          set -euo pipefail
          USERNAME=$(az acr credential show --name "$ACR_NAME" --query username -o tsv)
          PASSWORD=$(az acr credential show --name "$ACR_NAME" --query "passwords[0].value" -o tsv)
          echo "::add-mask::$PASSWORD"
          echo "username=$USERNAME" >> "$GITHUB_OUTPUT"
          echo "password=$PASSWORD" >> "$GITHUB_OUTPUT"

      - name: Docker ã«ãƒ­ã‚°ã‚¤ãƒ³ (ACR)
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_LOGIN_SERVER }}
          username: ${{ steps.acr_creds.outputs.username }}
          password: ${{ steps.acr_creds.outputs.password }}

      - name: Docker Buildx ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: docker/setup-buildx-action@v3

      - name: Board API ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰&ãƒ—ãƒƒã‚·ãƒ¥ (ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹)
        uses: docker/build-push-action@v5
        with:
          context: app/board-api
          file: app/board-api/Dockerfile
          push: true
          tags: |
            ${{ steps.metadata.outputs.board_api_image_full }}
            ${{ env.ACR_LOGIN_SERVER }}/${{ env.BOARD_API_IMAGE_NAME }}:latest
          cache-from: type=gha,scope=board-api
          cache-to: type=gha,scope=board-api,mode=max

      - name: Trivy DB ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¾©å…ƒ
        uses: actions/cache@v4
        with:
          path: ~/.cache/trivy
          key: trivy-db-${{ runner.os }}-${{ hashFiles('app/board-api/package.json') }}
          restore-keys: |
            trivy-db-${{ runner.os }}-

      - name: ã‚³ãƒ³ãƒ†ãƒŠ SBOM ç”Ÿæˆ (Board API)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ steps.metadata.outputs.board_api_image_full }}
          format: "cyclonedx"
          output: "sbom-board-api.cdx.json"
          hide-progress: true
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH"
          exit-code: "0"

      - name: Trivy ã§ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¹ã‚­ãƒ£ãƒ³ (Board API)
        uses: aquasecurity/trivy-action@0.28.0
        continue-on-error: true
        with:
          image-ref: ${{ steps.metadata.outputs.board_api_image_full }}
          format: "sarif"
          output: "trivy-image-board-api.sarif"
          hide-progress: true
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH"
          exit-code: "0"

      - name: Trivy SARIF (Board API) ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: always()
        continue-on-error: true
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-image-board-api.sarif
          category: board-api-trivy-image

      - name: ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¹ã‚­ãƒ£ãƒ³çµæœã‚’é›†è¨ˆ
        id: image_scan_summary
        if: always()
        run: |
          set +e
          API_IMAGE_CRITICAL=0
          API_IMAGE_HIGH=0
          if [ -f trivy-image-board-api.sarif ]; then
            API_IMAGE_CRITICAL=$(jq '[.runs[].results[] | select(.level == "error")] | length' trivy-image-board-api.sarif 2>/dev/null || echo "0")
            API_IMAGE_HIGH=$(jq '[.runs[].results[] | select(.level == "warning")] | length' trivy-image-board-api.sarif 2>/dev/null || echo "0")
          fi
          echo "api_image_critical=$API_IMAGE_CRITICAL" >> "$GITHUB_OUTPUT"
          echo "api_image_high=$API_IMAGE_HIGH" >> "$GITHUB_OUTPUT"

      - name: æˆæœãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        uses: actions/upload-artifact@v4
        with:
          name: board-api-image
          path: |
            sbom-board-api.cdx.json
            trivy-image-board-api.sarif

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ã€äº’æ›æ€§ãƒ¬ã‚¤ãƒ¤ãƒ¼ã€‘æ—§çµ±åˆãƒ“ãƒ«ãƒ‰ã‚¸ãƒ§ãƒ–ï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ä¿æŒï¼‰
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ç›®çš„: æ—¢å­˜ã®deployã‚¸ãƒ§ãƒ–ã¨ã®äº’æ›æ€§ç¶­æŒï¼ˆå‡ºåŠ›å€¤ã‚’é›†ç´„ï¼‰
  # å®Ÿæ…‹: build-board-app / build-board-apiã®çµæœã‚’é›†ç´„ã™ã‚‹ã ã‘
  # æ³¨æ„: å®Ÿéš›ã®ãƒ“ãƒ«ãƒ‰ã¯è¡Œã‚ãªã„ï¼ˆä¸¦åˆ—å®Ÿè¡Œæ¸ˆã¿ï¼‰
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  build-and-push:
    runs-on: ubuntu-latest
    needs:
      - prepare-context
      - build-board-app
      - build-board-api
    if: ${{ always() && needs.prepare-context.outputs.build_required == 'true' }}
    outputs:
      image_tag: ${{ needs.prepare-context.outputs.image_tag }}
      board_image_full: ${{ needs.build-board-app.outputs.board_image_full }}
      board_api_image_full: ${{ needs.build-board-api.outputs.board_api_image_full }}
      board_image_critical: ${{ needs.build-board-app.outputs.board_image_critical }}
      board_image_high: ${{ needs.build-board-app.outputs.board_image_high }}
      api_image_critical: ${{ needs.build-board-api.outputs.api_image_critical }}
      api_image_high: ${{ needs.build-board-api.outputs.api_image_high }}
    steps:
      - name: ãƒ“ãƒ«ãƒ‰çµæœã‚’é›†ç´„ï¼ˆäº’æ›æ€§ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼‰
        run: |
          echo "âœ… Board App Build: ${{ needs.build-board-app.result }}"
          echo "âœ… Board API Build: ${{ needs.build-board-api.result }}"
          echo "ã“ã®ã‚¸ãƒ§ãƒ–ã¯äº’æ›æ€§ã®ãŸã‚å‡ºåŠ›å€¤ã‚’é›†ç´„ã™ã‚‹ã ã‘ã§ã™"

          # ã©ã¡ã‚‰ã‹ãŒå¤±æ•—ã—ã¦ã„ãŸã‚‰çµ‚äº†ã‚³ãƒ¼ãƒ‰1
          if [ "${{ needs.build-board-app.result }}" != "success" ] || [ "${{ needs.build-board-api.result }}" != "success" ]; then
            echo "âŒ ãƒ“ãƒ«ãƒ‰ãŒå¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ã€ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ã‚§ãƒ¼ã‚ºã€‘AKS ã¸ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ç›®çš„: Board App/API ã‚’ AKS ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã€Ingress çµŒç”±ã§å…¬é–‹
  # å‡¦ç†:
  #   1. NGINX Ingress Controller ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«/æ›´æ–°
  #   2. LoadBalancer IP å‰²ã‚Šå½“ã¦å¾…æ©Ÿ
  #   3. Board App/API Deployment é©ç”¨
  #   4. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ & æ¥ç¶šç¢ºèª
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  deploy:
    runs-on: ubuntu-latest
    needs:
      - prepare-context
      - gitguardian-scan
      - code-security-scans
      - build-and-push
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # å®Ÿè¡Œæ¡ä»¶:
    #   - prepare-context ãŒæˆåŠŸ
    #   AND
    #   - build-and-push ãŒæˆåŠŸ OR ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæ—¢å­˜ã‚¤ãƒ¡ãƒ¼ã‚¸ä½¿ç”¨æ™‚ï¼‰
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    if: ${{ needs.prepare-context.result == 'success' && (needs.build-and-push.result == 'success' || needs.build-and-push.result == 'skipped') }}
    env:
      RESOURCE_GROUP_NAME: ${{ needs.prepare-context.outputs.resource_group_name }}
      ACR_NAME: ${{ needs.prepare-context.outputs.acr_name }}
      ACR_LOGIN_SERVER: ${{ needs.prepare-context.outputs.acr_login_server }}
      DB_ENDPOINT: ${{ needs.prepare-context.outputs.db_endpoint }}
      IMAGE_TAG: ${{ needs.build-and-push.outputs.image_tag || needs.prepare-context.outputs.image_tag }}
      CHECKOUT_REF: ${{ needs.prepare-context.outputs.checkout_ref }}
      NODE_RESOURCE_GROUP: ${{ needs.prepare-context.outputs.node_resource_group }}
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
        uses: actions/checkout@v4
        with:
          ref: ${{ env.CHECKOUT_REF }}

      - name: Azure ã« Service Principal ã§ãƒ­ã‚°ã‚¤ãƒ³
        uses: azure/login@v2
        with:
          creds: >-
            {"clientId":"${{ vars.AZURE_CLIENT_ID }}","tenantId":"${{ vars.AZURE_TENANT_ID }}","clientSecret":"${{ vars.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}"}

      - name: kubectl ã‚’æº–å‚™
        run: az aks install-cli

      - name: Namespace/Ingress ã®å€¤ã‚’åŒæœŸ
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          & ./scripts/sync-board-vars.ps1 `
            -ParametersFile "infra/parameters/main-dev.parameters.json" `
            -OutputFile "app/board-app/k8s/vars.env"

      - name: AKS è³‡æ ¼æƒ…å ±ã‚’å–å¾—
        run: |
          az aks get-credentials \
            --name "$AKS_CLUSTER_NAME" \
            --resource-group "$RESOURCE_GROUP_NAME" \
            --overwrite-existing

      - name: AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®çŠ¶æ…‹ã‚’ç¢ºèª
        run: |
          set -euo pipefail

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼çŠ¶æ…‹ç¢ºèª"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼æƒ…å ±ã‚’å–å¾—
          AKS_INFO=$(az aks show \
            --resource-group "$RESOURCE_GROUP_NAME" \
            --name "$AKS_CLUSTER_NAME" \
            --query '{
              provisioningState: provisioningState,
              powerState: powerState.code,
              fqdn: fqdn,
              privateFqdn: privateFqdn,
              kubernetesVersion: kubernetesVersion
            }' \
            -o json)

          echo "AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼æƒ…å ±:"
          echo "$AKS_INFO" | jq '.'

          POWER_STATE=$(echo "$AKS_INFO" | jq -r '.powerState // "Unknown"')
          PROVISIONING_STATE=$(echo "$AKS_INFO" | jq -r '.provisioningState // "Unknown"')
          FQDN=$(echo "$AKS_INFO" | jq -r '.fqdn // "Unknown"')

          echo ""
          echo "ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°çŠ¶æ…‹: $PROVISIONING_STATE"
          echo "é›»æºçŠ¶æ…‹: $POWER_STATE"
          echo "FQDN: $FQDN"

          # ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãŒåœæ­¢ã—ã¦ã„ã‚‹å ´åˆã¯é–‹å§‹
          if [ "$POWER_STATE" = "Stopped" ]; then
            echo ""
            echo "âš ï¸ AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãŒåœæ­¢ä¸­ã§ã™ã€‚èµ·å‹•ã‚’é–‹å§‹ã—ã¾ã™..."
            az aks start \
              --resource-group "$RESOURCE_GROUP_NAME" \
              --name "$AKS_CLUSTER_NAME" \
              --no-wait
            
            echo "â³ ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®èµ·å‹•ã‚’å¾…æ©Ÿã—ã¦ã„ã¾ã™ï¼ˆæœ€å¤§ 10 åˆ†ï¼‰..."
            
            # èµ·å‹•å®Œäº†ã‚’å¾…æ©Ÿï¼ˆæœ€å¤§ 10 åˆ†ï¼‰
            MAX_WAIT_SECONDS=600
            WAIT_INTERVAL=15
            ELAPSED=0
            CURRENT_POWER_STATE="Stopped"
            
            while [ $ELAPSED -lt $MAX_WAIT_SECONDS ]; do
              CURRENT_POWER_STATE=$(az aks show \
                --resource-group "$RESOURCE_GROUP_NAME" \
                --name "$AKS_CLUSTER_NAME" \
                --query 'powerState.code' -o tsv)
              
              if [ "$CURRENT_POWER_STATE" = "Running" ]; then
                echo "âœ… AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãŒèµ·å‹•ã—ã¾ã—ãŸ"
                break
              fi
              
              echo "  ç¾åœ¨ã®çŠ¶æ…‹: $CURRENT_POWER_STATE ï¼ˆçµŒé: ${ELAPSED}ç§’/${MAX_WAIT_SECONDS}ç§’ï¼‰"
              sleep $WAIT_INTERVAL
              ELAPSED=$((ELAPSED + WAIT_INTERVAL))
            done
            
            if [ "$CURRENT_POWER_STATE" != "Running" ]; then
              echo "âŒ AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®èµ·å‹•ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ" >&2
              exit 1
            fi
            
            # èµ·å‹•å¾Œã€DNS ãŒä¼æ’­ã™ã‚‹ã¾ã§è¿½åŠ ã§å¾…æ©Ÿ
            echo "â³ DNS ä¼æ’­ã‚’å¾…æ©Ÿã—ã¦ã„ã¾ã™ï¼ˆ30ç§’ï¼‰..."
            sleep 30
          elif [ "$POWER_STATE" != "Running" ]; then
            echo "âŒ AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãŒäºˆæœŸã—ãªã„çŠ¶æ…‹ã§ã™: $POWER_STATE" >&2
            exit 1
          else
            echo "âœ… AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã¯å®Ÿè¡Œä¸­ã§ã™"
          fi

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: AKS æ¥ç¶šã‚’æ¤œè¨¼
        env:
          # DNS è§£æ±ºãƒªãƒˆãƒ©ã‚¤è¨­å®šï¼ˆDNS ä¼æ’­é…å»¶ã«å¯¾å¿œã™ã‚‹ãŸã‚ï¼‰
          MAX_DNS_RETRIES: "5" # æœ€å¤§ 5 å›ã¾ã§è©¦è¡Œ
          DNS_RETRY_INTERVAL: "10" # 10 ç§’é–“éš”ã§ãƒªãƒˆãƒ©ã‚¤
          # ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼æ¥ç¶šãƒªãƒˆãƒ©ã‚¤è¨­å®šï¼ˆä¸€æ™‚çš„ãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å•é¡Œã«å¯¾å¿œã™ã‚‹ãŸã‚ï¼‰
          MAX_CLUSTER_RETRIES: "3" # æœ€å¤§ 3 å›ã¾ã§è©¦è¡Œ
          CLUSTER_RETRY_INTERVAL: "5" # 5 ç§’é–“éš”ã§ãƒªãƒˆãƒ©ã‚¤
        run: |
          set -euo pipefail

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” AKS æ¥ç¶šæ¤œè¨¼"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          echo ""
          echo "=== 1. kubeconfig ã®ç¢ºèª ==="
          kubectl config view --minify

          echo ""
          echo "=== 2. API ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ç¢ºèª ==="
          API_SERVER=$(kubectl config view --minify -o jsonpath='{.clusters[0].cluster.server}')
          echo "API Server: $API_SERVER"

          echo ""
          echo "=== 3. DNS è§£æ±ºãƒ†ã‚¹ãƒˆ ==="
          API_HOST=$(echo "$API_SERVER" | sed 's|https://||' | sed 's|:.*||')
          echo "Hostname: $API_HOST"

          # DNS è§£æ±ºã‚’è¤‡æ•°å›ãƒªãƒˆãƒ©ã‚¤ï¼ˆDNS ä¼æ’­å¾…ã¡ï¼‰
          DNS_RESOLVED=false

          for i in $(seq 1 $MAX_DNS_RETRIES); do
            echo "DNS è§£æ±ºè©¦è¡Œ [$i/$MAX_DNS_RETRIES]"
            if nslookup "$API_HOST"; then
              DNS_RESOLVED=true
              echo "âœ… DNS è§£æ±ºæˆåŠŸ"
              break
            fi
            if [ $i -lt $MAX_DNS_RETRIES ]; then
              echo "â³ DNS ä¼æ’­ã‚’å¾…æ©Ÿä¸­... (${DNS_RETRY_INTERVAL}ç§’)"
              sleep $DNS_RETRY_INTERVAL
            fi
          done

          if [ "$DNS_RESOLVED" != "true" ]; then
            echo "âŒ DNS è§£æ±ºã«å¤±æ•—ã—ã¾ã—ãŸ" >&2
            echo ""
            echo "è€ƒãˆã‚‰ã‚Œã‚‹åŸå› :" >&2
            echo "1. AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãŒå‰Šé™¤ã¾ãŸã¯å†ä½œæˆã•ã‚Œã¦ã„ã‚‹" >&2
            echo "2. DNS ã®ä¼æ’­ã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã‚‹ï¼ˆé€šå¸¸ã¯èµ·å‹•å¾Œ 1-2 åˆ†ï¼‰" >&2
            echo "3. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹æˆã«å•é¡ŒãŒã‚ã‚‹" >&2
            echo ""
            echo "=== Azure AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼è©³ç´°æƒ…å ± ===" >&2
            az aks show \
              --resource-group "$RESOURCE_GROUP_NAME" \
              --name "$AKS_CLUSTER_NAME" \
              --query '{
                id: id,
                provisioningState: provisioningState,
                powerState: powerState.code,
                fqdn: fqdn,
                privateFqdn: privateFqdn,
                kubernetesVersion: kubernetesVersion,
                networkProfile: networkProfile.networkPlugin,
                apiServerAccessProfile: apiServerAccessProfile
              }' \
              -o json >&2 || echo "AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ" >&2
            echo ""
            echo "=== /etc/resolv.conf ã®å†…å®¹ ===" >&2
            cat /etc/resolv.conf >&2
            echo ""
            echo "=== Google DNS ãƒ†ã‚¹ãƒˆï¼ˆDNS ã‚µãƒ¼ãƒãƒ¼è‡ªä½“ã®å‹•ä½œç¢ºèªï¼‰===" >&2
            nslookup google.com >&2 || true
            echo ""
            echo "æ¨å¥¨å¯¾å¿œ:" >&2
            echo "- AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãŒèµ·å‹•ã™ã‚‹ã¾ã§ 1-2 åˆ†å¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„" >&2
            echo "- Azure Portal ã§ AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„" >&2
            echo "- å¿…è¦ã«å¿œã˜ã¦ Infrastructure Deploy ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å†å®Ÿè¡Œã—ã¦ãã ã•ã„" >&2
            exit 1
          fi

          echo ""
          echo "=== 4. ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼æ¥ç¶šãƒ†ã‚¹ãƒˆ ==="
          # ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼æ¥ç¶šã‚‚è¤‡æ•°å›ãƒªãƒˆãƒ©ã‚¤
          CLUSTER_CONNECTED=false

          for i in $(seq 1 $MAX_CLUSTER_RETRIES); do
            echo "ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼æ¥ç¶šè©¦è¡Œ [$i/$MAX_CLUSTER_RETRIES]"
            if kubectl cluster-info; then
              CLUSTER_CONNECTED=true
              echo "âœ… ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼æ¥ç¶šæˆåŠŸ"
              break
            fi
            if [ $i -lt $MAX_CLUSTER_RETRIES ]; then
              echo "â³ ãƒªãƒˆãƒ©ã‚¤å¾…æ©Ÿä¸­... (${CLUSTER_RETRY_INTERVAL}ç§’)"
              sleep $CLUSTER_RETRY_INTERVAL
            fi
          done

          if [ "$CLUSTER_CONNECTED" != "true" ]; then
            echo "âŒ ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ" >&2
            echo ""
            echo "=== kubectl ãƒãƒ¼ã‚¸ãƒ§ãƒ³ ===" >&2
            kubectl version --client >&2 || true
            echo ""
            echo "=== Azure AKS è¨ºæ–­æƒ…å ± ===" >&2
            az aks show \
              --resource-group "$RESOURCE_GROUP_NAME" \
              --name "$AKS_CLUSTER_NAME" \
              --query '{
                provisioningState: provisioningState,
                powerState: powerState.code,
                fqdn: fqdn,
                privateFqdn: privateFqdn,
                apiServerAccessProfile: apiServerAccessProfile
              }' \
              -o json >&2 || true
            exit 1
          fi

          echo ""
          echo "=== 5. ãƒãƒ¼ãƒ‰ä¸€è¦§ã®å–å¾— ==="
          kubectl get nodes -o wide

          echo ""
          echo "âœ… AKS æ¥ç¶šæ¤œè¨¼å®Œäº†"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: NSG ã« Load Balancer é€šä¿¡ç”¨ãƒ«ãƒ¼ãƒ«ã‚’é©ç”¨
        run: |
          set -euo pipefail
          NODE_RG="${NODE_RESOURCE_GROUP}"
          NSG_NAME=$(az network nsg list --resource-group "$NODE_RG" --query "[?contains(name, 'aks-agentpool')].name | [0]" -o tsv)
          if [ -z "$NSG_NAME" ]; then
            echo "NSG ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: rg=$NODE_RG" >&2
            exit 1
          fi
          ensure_rule() {
            local rule_name=$1
            local source_prefix=$2
            local ports=$3
            local priority=$4
            if az network nsg rule show --resource-group "$NODE_RG" --nsg-name "$NSG_NAME" --name "$rule_name" &>/dev/null; then
              az network nsg rule update --resource-group "$NODE_RG" --nsg-name "$NSG_NAME" --name "$rule_name" \
                --source-address-prefixes "$source_prefix" --destination-port-ranges "$ports" \
                --access Allow --direction Inbound --protocol Tcp --priority "$priority" >/dev/null
            else
              az network nsg rule create --resource-group "$NODE_RG" --nsg-name "$NSG_NAME" --name "$rule_name" \
                --source-address-prefixes "$source_prefix" --destination-port-ranges "$ports" \
                --access Allow --direction Inbound --protocol Tcp --priority "$priority" >/dev/null
            fi
          }
          ensure_rule "allow-azure-lb-probes" AzureLoadBalancer 30000-32767 300
          ensure_rule "allow-nodeport-from-internet" Internet 30000-32767 310

      - name: Ingress Controller (nginx) ã‚’ç¢ºèª/ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        env:
          NODE_RESOURCE_GROUP: ${{ env.NODE_RESOURCE_GROUP }}
        run: |
          set -euo pipefail

          # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          # Ingress Controller ã®æ—¢å­˜ç¢ºèªï¼ˆNodePort å¤‰æ›´é˜²æ­¢ï¼‰
          # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          # ç†ç”±: helm upgrade ã§ Service ã‚’å†ä½œæˆã™ã‚‹ã¨ NodePort ãŒå¤‰ã‚ã‚Šã€
          #       Azure LoadBalancer ã®ãƒ˜ãƒ«ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ–ã¨ãƒãƒ¼ãƒˆä¸ä¸€è‡´ãŒç™ºç”Ÿã™ã‚‹
          # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          INGRESS_EXISTS=$(helm list -n ingress-nginx -q 2>/dev/null | grep -c "^ingress-nginx$" || echo "0")
          CONTROLLER_SVC=$(kubectl get svc -n ingress-nginx ingress-nginx-controller -o name 2>/dev/null || true)
          SHOULD_INSTALL=false

          if [ "$INGRESS_EXISTS" != "0" ] && [ -n "$CONTROLLER_SVC" ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… Ingress Controller ã¯æ—¢ã«å­˜åœ¨ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # æ—¢å­˜è¨­å®šã®ç¢ºèª
            echo "ğŸ“Š ç¾åœ¨ã® Ingress Controller æƒ…å ±:"
            HELM_STATUS_RAW=$(helm status ingress-nginx -n ingress-nginx 2>&1 || true)
            if [ -n "$HELM_STATUS_RAW" ]; then
              echo "$HELM_STATUS_RAW"
              HELM_STATUS=$(echo "$HELM_STATUS_RAW" | awk -F': ' '/^STATUS:/ {print $2; exit}' | tr -d '\r' || true)
            fi
            if [ -z "${HELM_STATUS:-}" ]; then
              echo "âš ï¸ helm status æƒ…å ±ã‚’æ­£ã—ãå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆã‚µãƒãƒªãƒ¼ã¯ unknown ã¨ã—ã¦ç¶™ç¶šã—ã¾ã™ï¼‰" >&2
              HELM_STATUS="unknown"
            fi

            CHART_VERSION=$(helm list -n ingress-nginx --filter '^ingress-nginx$' 2>/dev/null | awk 'NR==2 {print $6}' || true)
            if [ -z "$CHART_VERSION" ]; then
              CHART_VERSION="unknown"
            fi
            HTTP_NODEPORT=$(kubectl get svc -n ingress-nginx ingress-nginx-controller -o jsonpath='{.spec.ports[?(@.name=="http")].nodePort}' 2>/dev/null || echo "N/A")
            HTTPS_NODEPORT=$(kubectl get svc -n ingress-nginx ingress-nginx-controller -o jsonpath='{.spec.ports[?(@.name=="https")].nodePort}' 2>/dev/null || echo "N/A")
            HEALTH_NODEPORT=$(kubectl get svc -n ingress-nginx ingress-nginx-controller -o jsonpath='{.spec.healthCheckNodePort}' 2>/dev/null || echo "N/A")
            LB_IP=$(kubectl get svc -n ingress-nginx ingress-nginx-controller -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "<pending>")
            
            echo "  - Helm Status: $HELM_STATUS"
            echo "  - Chart: $CHART_VERSION"
            echo "  - HTTP NodePort: $HTTP_NODEPORT"
            echo "  - HTTPS NodePort: $HTTPS_NODEPORT"
            echo "  - Health Check NodePort: $HEALTH_NODEPORT"
            echo "  - LoadBalancer IP: $LB_IP"
            echo ""
            
            # pending ã‚„ failed çŠ¶æ…‹ã®å ´åˆã¯è­¦å‘Š
            if [ "$HELM_STATUS" = "pending-install" ] || [ "$HELM_STATUS" = "pending-upgrade" ] || [ "$HELM_STATUS" = "failed" ]; then
              echo "âš ï¸ è­¦å‘Š: Helm Release ãŒç•°å¸¸çŠ¶æ…‹ã§ã™ï¼ˆ$HELM_STATUSï¼‰"
              echo "   æ‰‹å‹•ã§ä¿®å¾©ãŒå¿…è¦ãªå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
              echo "   ä¿®å¾©æ–¹æ³•: helm uninstall ingress-nginx -n ingress-nginx && 1ï¸âƒ£ Infrastructure Deploy ã‚’å†å®Ÿè¡Œ"
            fi
            
            # Pod ã®çŠ¶æ…‹ç¢ºèª
            kubectl get pods -n ingress-nginx -l app.kubernetes.io/component=controller
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          else
            if [ "$INGRESS_EXISTS" != "0" ] && [ -z "$CONTROLLER_SVC" ]; then
              echo "âš ï¸ Helm ãƒªãƒªãƒ¼ã‚¹ã¯å­˜åœ¨ã—ã¾ã™ãŒ Service ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¦å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™" >&2
              helm uninstall ingress-nginx -n ingress-nginx || true
            fi
            SHOULD_INSTALL=true
          fi

          if [ "$SHOULD_INSTALL" = "true" ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸš€ Ingress Controller ãŒå­˜åœ¨ã—ãªã„ãŸã‚æ–°è¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx || true
            helm repo update
            INGRESS_APP_VERSION=$(helm show chart ingress-nginx/ingress-nginx | awk -F': ' '/^appVersion:/ {print $2}' | tr -d '[:space:]')
            if [ -z "$INGRESS_APP_VERSION" ] || [ "$INGRESS_APP_VERSION" = "null" ]; then
              echo "appVersion ã‚’å–å¾—ã§ãã¾ã›ã‚“" >&2
              exit 1
            fi
            if [[ "$INGRESS_APP_VERSION" == v* ]]; then
              CONTROLLER_TAG="$INGRESS_APP_VERSION"
            else
              CONTROLLER_TAG="v${INGRESS_APP_VERSION}"
            fi
            CONTROLLER_IMAGE="ingress-nginx/controller"
            export CONTROLLER_IMAGE CONTROLLER_TAG
            az acr import --name "$ACR_NAME" --source "registry.k8s.io/${CONTROLLER_IMAGE}:${CONTROLLER_TAG}" --image "${CONTROLLER_IMAGE}:${CONTROLLER_TAG}" --force || \
              az acr import --name "$ACR_NAME" --source "mcr.microsoft.com/oss/kubernetes/${CONTROLLER_IMAGE}:${CONTROLLER_TAG}" --image "${CONTROLLER_IMAGE}:${CONTROLLER_TAG}" --force

            VALUES_FILE="app/board-app/k8s/ingress-nginx-values.yaml"
            OVERRIDE_FILE=$(mktemp)
            export OVERRIDE_FILE

            # å›ºå®š Public IP æŒ‡å®šã‚’å‰Šé™¤ã—ã€AKS ã«è‡ªå‹•ä½œæˆã•ã›ã‚‹
            # ç†ç”±: æŒ‡å®šã—ãŸ IP ãŒå­˜åœ¨ã—ãªã„ã¨ LoadBalancer ãŒ <pending> ã®ã¾ã¾å›ºã¾ã‚‹
            python -c 'import os, pathlib; content = "controller:\n  image:\n    registry: \"{ACR_LOGIN_SERVER}\"\n    image: \"{CONTROLLER_IMAGE}\"\n    tag: \"{CONTROLLER_TAG}\"\n  service:\n    annotations:\n      service.beta.kubernetes.io/azure-load-balancer-resource-group: \"{NODE_RESOURCE_GROUP}\"\n".format(**os.environ); pathlib.Path(os.environ["OVERRIDE_FILE"]).write_text(content)'

            # Namespace ã‚’äº‹å‰ä½œæˆï¼ˆå†ªç­‰æ€§ã‚’ç¢ºä¿ï¼‰
            kubectl create namespace ingress-nginx --dry-run=client -o yaml | kubectl apply -f -

            # helm upgrade --install --atomic ã§å†ªç­‰ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«/ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰
            # --atomic: å¤±æ•—æ™‚ã«è‡ªå‹•ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€Service å‰Šé™¤ãªã—ã§å®‰å…¨ã«æ›´æ–°
            # --cleanup-on-fail: å¤±æ•—æ™‚ã®ãƒªã‚½ãƒ¼ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            if ! helm upgrade ingress-nginx ingress-nginx/ingress-nginx \
              --install \
              --namespace ingress-nginx \
              --create-namespace \
              --values "$VALUES_FILE" \
              --values "$OVERRIDE_FILE" \
              --atomic \
              --cleanup-on-fail \
              --wait \
              --timeout=15m; then
              
              echo "âš ï¸ Helm upgrade ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’åé›†ã—ã¾ã™..." >&2
              
              # ãƒ‡ãƒãƒƒã‚°æƒ…å ±åé›†
              echo "--- Webhook è¨­å®š ---"
              kubectl get validatingwebhookconfigurations | grep ingress-nginx || true
              
              echo "--- Ingress Nginx ãƒªã‚½ãƒ¼ã‚¹ ---"
              kubectl -n ingress-nginx get svc,deploy,po || true
              
              echo "--- æœ€æ–°ã‚¤ãƒ™ãƒ³ãƒˆ ---"
              kubectl -n ingress-nginx get events --sort-by=.metadata.creationTimestamp | tail -30 || true
              
              echo "--- Service è©³ç´° ---"
              kubectl -n ingress-nginx describe svc ingress-nginx-controller || true
              kubectl -n ingress-nginx describe svc ingress-nginx-controller-admission || true
              
              echo "--- Helm ãƒªãƒªãƒ¼ã‚¹çŠ¶æ…‹ ---"
              helm list -n ingress-nginx || true
              helm history ingress-nginx -n ingress-nginx || true
              
              exit 1
            fi

            rm -f "$OVERRIDE_FILE"

            kubectl rollout status deployment/ingress-nginx-controller -n ingress-nginx --timeout=600s
            echo "âœ… Ingress Controller ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          fi

          # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          # LoadBalancer IP å‰²ã‚Šå½“ã¦å¾…æ©Ÿ
          # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          readonly LB_IP_TIMEOUT_MINUTES=12
          readonly LB_IP_POLL_INTERVAL=10
          LB_IP_ATTEMPTS=$((LB_IP_TIMEOUT_MINUTES * 60 / LB_IP_POLL_INTERVAL))

          for i in $(seq 1 $LB_IP_ATTEMPTS); do
            LB_IP=$(kubectl get svc -n ingress-nginx ingress-nginx-controller -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || true)
            if [ -n "$LB_IP" ]; then
              echo "ACTUAL_LB_IP=$LB_IP" >> "$GITHUB_ENV"
              echo "âœ… LoadBalancer IP ã‚’å–å¾—: $LB_IP"
              break
            fi
            echo "[$i/$LB_IP_ATTEMPTS] LoadBalancer IP å‰²ã‚Šå½“ã¦å¾…æ©Ÿä¸­... (æœ€å¤§${LB_IP_TIMEOUT_MINUTES}åˆ†)"
            sleep $LB_IP_POLL_INTERVAL
          done

          if [ -z "${LB_IP:-}" ]; then
            echo "âŒ LoadBalancer IP ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸ" >&2
            kubectl get svc -n ingress-nginx ingress-nginx-controller
            exit 1
          fi

      - name: LoadBalancer Rule ã® BackendPort ã‚’æ¤œè¨¼ãƒ»ä¿®æ­£
        env:
          NODE_RESOURCE_GROUP: ${{ env.NODE_RESOURCE_GROUP }}
        run: |
          set -euo pipefail
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”§ LoadBalancer Rule ã® BackendPort ã‚’æ¤œè¨¼ãƒ»ä¿®æ­£"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # ã‚¹ãƒ†ãƒƒãƒ—1: Ingress Controller ã® NodePort ã‚’å–å¾—
          HTTP_NODEPORT=$(kubectl get svc -n ingress-nginx ingress-nginx-controller \
            -o jsonpath='{.spec.ports[?(@.name=="http")].nodePort}' 2>/dev/null || echo "")
          HTTPS_NODEPORT=$(kubectl get svc -n ingress-nginx ingress-nginx-controller \
            -o jsonpath='{.spec.ports[?(@.name=="https")].nodePort}' 2>/dev/null || echo "")
          
          if [ -z "$HTTP_NODEPORT" ] || [ -z "$HTTPS_NODEPORT" ]; then
            echo "âŒ Ingress Controller ã® NodePort ã‚’å–å¾—ã§ãã¾ã›ã‚“" >&2
            kubectl get svc -n ingress-nginx ingress-nginx-controller
            exit 1
          fi
          
          echo "ğŸ“Š Ingress Controller NodePort:"
          echo "  - HTTP: $HTTP_NODEPORT"
          echo "  - HTTPS: $HTTPS_NODEPORT"
          
          # ã‚¹ãƒ†ãƒƒãƒ—2: LoadBalancer Rule ã‚’å–å¾—
          NODE_RG="${NODE_RESOURCE_GROUP}"
          LB_NAME="kubernetes"
          
          echo ""
          echo "ğŸ“Š LoadBalancer Rule ã®ç¾åœ¨ã®è¨­å®š:"
          LB_RULES=$(az network lb rule list --resource-group "$NODE_RG" --lb-name "$LB_NAME" \
            --query "[?frontendPort==\`80\` || frontendPort==\`443\`]" -o json)
          
          if [ -z "$LB_RULES" ] || [ "$LB_RULES" = "[]" ]; then
            echo "âš ï¸ LoadBalancer Rule ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆä½œæˆä¸­ã®å¯èƒ½æ€§ã‚ã‚Šï¼‰"
            echo "   30ç§’å¾…æ©Ÿã—ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¾ã™..."
            sleep 30
            LB_RULES=$(az network lb rule list --resource-group "$NODE_RG" --lb-name "$LB_NAME" \
              --query "[?frontendPort==\`80\` || frontendPort==\`443\`]" -o json)
          fi
          
          if [ -z "$LB_RULES" ] || [ "$LB_RULES" = "[]" ]; then
            echo "âŒ LoadBalancer Rule ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“" >&2
            exit 1
          fi
          
          echo "$LB_RULES" | jq -r '.[] | "  - \(.name): FrontendPort=\(.frontendPort), BackendPort=\(.backendPort)"'
          
          # ã‚¹ãƒ†ãƒƒãƒ—3: BackendPort ãŒ NodePort ã¨ä¸€è‡´ã—ãªã„å ´åˆã¯ä¿®æ­£
          FIXED_COUNT=0
          
          for rule in $(echo "$LB_RULES" | jq -r '.[] | @base64'); do
            _jq() {
              echo "$rule" | base64 --decode | jq -r "$1"
            }
            
            RULE_NAME=$(_jq '.name')
            FRONTEND_PORT=$(_jq '.frontendPort')
            BACKEND_PORT=$(_jq '.backendPort')
            
            NEEDS_UPDATE=false
            NEW_BACKEND_PORT=""
            
            if [ "$FRONTEND_PORT" = "80" ] && [ "$BACKEND_PORT" != "$HTTP_NODEPORT" ]; then
              echo ""
              echo "âš ï¸ HTTP Rule ã® BackendPort ãŒä¸ä¸€è‡´:"
              echo "   Rule: $RULE_NAME"
              echo "   ç¾åœ¨ã® BackendPort: $BACKEND_PORT"
              echo "   æ­£ã—ã„ NodePort: $HTTP_NODEPORT"
              NEEDS_UPDATE=true
              NEW_BACKEND_PORT="$HTTP_NODEPORT"
            fi
            
            if [ "$FRONTEND_PORT" = "443" ] && [ "$BACKEND_PORT" != "$HTTPS_NODEPORT" ]; then
              echo ""
              echo "âš ï¸ HTTPS Rule ã® BackendPort ãŒä¸ä¸€è‡´:"
              echo "   Rule: $RULE_NAME"
              echo "   ç¾åœ¨ã® BackendPort: $BACKEND_PORT"
              echo "   æ­£ã—ã„ NodePort: $HTTPS_NODEPORT"
              NEEDS_UPDATE=true
              NEW_BACKEND_PORT="$HTTPS_NODEPORT"
            fi
            
            if [ "$NEEDS_UPDATE" = "true" ]; then
              echo "   ğŸ”§ LoadBalancer Rule ã‚’ä¿®æ­£ä¸­..."
              az network lb rule update \
                --resource-group "$NODE_RG" \
                --lb-name "$LB_NAME" \
                --name "$RULE_NAME" \
                --backend-port "$NEW_BACKEND_PORT" \
                --output none
              echo "   âœ… ä¿®æ­£å®Œäº†: BackendPort â†’ $NEW_BACKEND_PORT"
              FIXED_COUNT=$((FIXED_COUNT + 1))
            fi
          done
          
          echo ""
          if [ "$FIXED_COUNT" -gt 0 ]; then
            echo "âœ… LoadBalancer Rule ã‚’ ${FIXED_COUNT} ä»¶ä¿®æ­£ã—ã¾ã—ãŸ"
            echo "   ä¿®æ­£å†…å®¹ãŒåæ˜ ã•ã‚Œã‚‹ã¾ã§ 60 ç§’å¾…æ©Ÿã—ã¾ã™..."
            sleep 60
            
            echo ""
            echo "ğŸ“Š ä¿®æ­£å¾Œã® LoadBalancer Rule:"
            az network lb rule list --resource-group "$NODE_RG" --lb-name "$LB_NAME" \
              --query "[?frontendPort==\`80\` || frontendPort==\`443\`]" -o json | \
              jq -r '.[] | "  - \(.name): FrontendPort=\(.frontendPort), BackendPort=\(.backendPort)"'
            
            echo ""
            echo "ğŸ” LoadBalancer ã®åæ˜ ã‚’å¾…æ©Ÿä¸­..."
            for i in $(seq 1 12); do
              if timeout 3 bash -c "echo > /dev/tcp/localhost/80" 2>/dev/null; then
                echo "   âœ… [$i/12] LoadBalancer ãŒå¿œç­”ã‚’é–‹å§‹ã—ã¾ã—ãŸ"
                break
              fi
              echo "   â³ [$i/12] LoadBalancer ã®åæ˜ å¾…æ©Ÿä¸­... (5ç§’é–“éš”)"
              sleep 5
            done
          else
            echo "âœ… LoadBalancer Rule ã¯æ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã¾ã™ï¼ˆä¿®æ­£ä¸è¦ï¼‰"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: LoadBalancer å¥åº·ãƒã‚§ãƒƒã‚¯
        run: |
          set -euo pipefail
          LB_IP=${ACTUAL_LB_IP:-}
          if [ -z "$LB_IP" ]; then
            echo "LoadBalancer IP ãŒå–å¾—ã§ãã¾ã›ã‚“" >&2
            exit 1
          fi

          # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          # Ingress Controller ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ (/healthz ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆç¢ºèª)
          # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          echo "LoadBalancer ($LB_IP) ã®ãƒ˜ãƒ«ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ–ã‚’æ¤œè¨¼ã—ã¾ã™"

          readonly HEALTH_CHECK_TIMEOUT_MINUTES=3
          readonly HEALTH_CHECK_INTERVAL=5
          HEALTH_CHECK_ATTEMPTS=$((HEALTH_CHECK_TIMEOUT_MINUTES * 60 / HEALTH_CHECK_INTERVAL))
          HEALTH_CHECK_SUCCESS=false

          for i in $(seq 1 $HEALTH_CHECK_ATTEMPTS); do
            if kubectl exec -n ingress-nginx deployment/ingress-nginx-controller -- curl -s -o /dev/null -w "%{http_code}" http://localhost:10254/healthz | grep -q "200"; then
              echo "âœ… [$i/$HEALTH_CHECK_ATTEMPTS] Ingress Controller ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æˆåŠŸ"
              HEALTH_CHECK_SUCCESS=true
              break
            fi
            echo "[$i/$HEALTH_CHECK_ATTEMPTS] ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¾…æ©Ÿä¸­... (æœ€å¤§${HEALTH_CHECK_TIMEOUT_MINUTES}åˆ†)"
            sleep $HEALTH_CHECK_INTERVAL
          done

          if [ "$HEALTH_CHECK_SUCCESS" != "true" ]; then
            echo "âš ï¸ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸã—ã¾ã›ã‚“ã§ã—ãŸãŒã€ç¶šè¡Œã—ã¾ã™" >&2
            kubectl get pods -n ingress-nginx
            kubectl logs -n ingress-nginx deployment/ingress-nginx-controller --tail=50 || true
          fi

          NODE_RG="${NODE_RESOURCE_GROUP}"
          if [ -n "$NODE_RG" ]; then
            PROBE_INFO=$(az network lb probe list --resource-group "$NODE_RG" --lb-name kubernetes --query "[].{Name:name,Port:port}" -o json 2>/dev/null || echo "[]")
            echo "ç¾åœ¨ã®ãƒ˜ãƒ«ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ–:" && echo "$PROBE_INFO" | jq '.'
          fi

          # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          # LoadBalancer ãƒãƒ¼ãƒˆ 80 æ¥ç¶šç¢ºèªï¼ˆå¤–éƒ¨ã‹ã‚‰ã®ç–é€šãƒ†ã‚¹ãƒˆï¼‰
          # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          readonly CONNECTIVITY_TIMEOUT_MINUTES=6
          readonly CONNECTIVITY_INTERVAL=10
          CONNECTIVITY_ATTEMPTS=$((CONNECTIVITY_TIMEOUT_MINUTES * 60 / CONNECTIVITY_INTERVAL))
          CONNECTIVITY_SUCCESS=false

          for i in $(seq 1 $CONNECTIVITY_ATTEMPTS); do
            if timeout 5 bash -c "echo > /dev/tcp/$LB_IP/80" 2>/dev/null; then
              echo "âœ… [$i/$CONNECTIVITY_ATTEMPTS] LoadBalancer ãƒãƒ¼ãƒˆ 80 ã¸ã®æ¥ç¶šæˆåŠŸ"
              CONNECTIVITY_SUCCESS=true
              break
            fi
            echo "[$i/$CONNECTIVITY_ATTEMPTS] LoadBalancer ãƒãƒ¼ãƒˆ 80 æ¥ç¶šå¾…æ©Ÿä¸­... (æœ€å¤§${CONNECTIVITY_TIMEOUT_MINUTES}åˆ†)"
            sleep $CONNECTIVITY_INTERVAL
          done

          if [ "$CONNECTIVITY_SUCCESS" != "true" ]; then
            echo "âš ï¸ LoadBalancer ãƒãƒ¼ãƒˆ 80 ã¸ã®æ¥ç¶šãŒç¢ºèªã§ãã¾ã›ã‚“ã§ã—ãŸãŒã€ç¶šè¡Œã—ã¾ã™" >&2
            az network lb probe list --resource-group "$NODE_RG" --lb-name kubernetes -o table || true
          fi

      - name: ACR Pull æ¨©é™ã‚’å†ç¢ºèª
        run: |
          if az aks check-acr --name "$AKS_CLUSTER_NAME" --resource-group "$RESOURCE_GROUP_NAME" --acr "$ACR_LOGIN_SERVER" &>/dev/null; then
            echo "ACR Pull æ¨©é™ã¯æœ‰åŠ¹ã§ã™"
          else
            az aks update --name "$AKS_CLUSTER_NAME" --resource-group "$RESOURCE_GROUP_NAME" --attach-acr "$ACR_NAME"
          fi

      - name: AKS ã« ACR èªè¨¼ Secret ã‚’ç”¨æ„
        run: |
          BOARD_NS=$(grep kubernetesNamespace "$KUSTOMIZE_DIR/vars.env" | cut -d'=' -f2)
          kubectl create namespace "$BOARD_NS" --dry-run=client -o yaml | kubectl apply -f -
          ACR_USERNAME=$(az acr credential show --name "$ACR_NAME" --query username -o tsv)
          ACR_PASSWORD=$(az acr credential show --name "$ACR_NAME" --query "passwords[0].value" -o tsv)
          kubectl create secret docker-registry acr-secret \
            --docker-server="$ACR_LOGIN_SERVER" \
            --docker-username="$ACR_USERNAME" \
            --docker-password="$ACR_PASSWORD" \
            -n "$BOARD_NS" \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: DB æ¥ç¶š Secret(board-db-conn) ã‚’ç”¨æ„
        run: |
          set -euo pipefail
          BOARD_NS=$(grep kubernetesNamespace "$KUSTOMIZE_DIR/vars.env" | cut -d'=' -f2)
          kubectl create namespace "$BOARD_NS" --dry-run=client -o yaml | kubectl apply -f -
          cat <<EOF | kubectl apply -f -
          apiVersion: v1
          kind: Secret
          metadata:
            name: board-db-conn
            namespace: ${BOARD_NS}
          type: Opaque
          stringData:
            db-endpoint: "${DB_ENDPOINT}"
            db-username: "${DB_APP_USERNAME}"
            db-password: "${DB_APP_PASSWORD}"
          EOF

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ã‚¤ãƒ¡ãƒ¼ã‚¸å‚ç…§ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        run: |
          echo "IMAGE_FULL=$ACR_LOGIN_SERVER/$BOARD_IMAGE_NAME:$IMAGE_TAG" >> "$GITHUB_ENV"
          echo "BOARD_API_IMAGE_FULL=$ACR_LOGIN_SERVER/$BOARD_API_IMAGE_NAME:$IMAGE_TAG" >> "$GITHUB_ENV"

      - name: Kustomize ã‚’é©ç”¨ã—ã¦ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆ
        run: |
          set -euo pipefail
          BOARD_NS=$(grep kubernetesNamespace "$KUSTOMIZE_DIR/vars.env" | cut -d'=' -f2)
          kubectl kustomize "$KUSTOMIZE_DIR" \
            | sed "s#acr-placeholder.azurecr.io/board-app:latest#${IMAGE_FULL}#g" \
            | sed "s#acr-placeholder.azurecr.io/board-api:latest#${BOARD_API_IMAGE_FULL}#g" \
            | kubectl apply -f -

          wait_rollout() {
            local deploy=$1
            local timeout=$2
            local mode=${3:-fail}
            echo "ğŸ“¦ Deployment $deploy ã®ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆã‚’ç›£è¦–ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: ${timeout}ç§’ï¼‰"
            if ! kubectl rollout status deployment/"$deploy" -n "$BOARD_NS" --timeout="${timeout}s"; then
              echo "âŒ Deployment $deploy ã®ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ" >&2
              kubectl get pods -n "$BOARD_NS" -l app="$deploy" -o wide || true
              kubectl describe deployment "$deploy" -n "$BOARD_NS" || true
              echo "ç›´è¿‘ã®ãƒ­ã‚°:"
              kubectl logs -n "$BOARD_NS" -l app="$deploy" --tail=50 --all-containers=true || true
              if [ "$mode" = "fail" ]; then
                exit 1
              else
                echo "âš ï¸ è­¦å‘Šãƒ¢ãƒ¼ãƒ‰ã®ãŸã‚ç¶šè¡Œã—ã¾ã™"
              fi
            fi
          }

          wait_rollout "board-app" 600 fail
          wait_rollout "board-api" 600 warn
          kubectl get ingress -n "$BOARD_NS"

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®ç–é€šç¢ºèª
        run: |
          set -euo pipefail
          BOARD_NS=$(grep kubernetesNamespace "$KUSTOMIZE_DIR/vars.env" | cut -d'=' -f2)
          LB_IP=${ACTUAL_LB_IP:-$INGRESS_STATIC_IP}

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®ç–é€šç¢ºèª"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # ã‚¯ãƒ©ã‚¹ã‚¿å†…ã‹ã‚‰ Service ã¸ã®ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ
          echo "\n[1/4] ã‚¯ãƒ©ã‚¹ã‚¿å†…ã‹ã‚‰ board-app Service ã¸ã‚¢ã‚¯ã‚»ã‚¹"
          if kubectl run tmp-curl --rm -i --restart=Never --image=curlimages/curl -n "$BOARD_NS" -- curl -sI http://board-app.board-app.svc.cluster.local/ | head -n1; then
            echo "âœ… board-app Service ç–é€šæˆåŠŸ"
          else
            echo "âš ï¸ board-app Service ç–é€šå¤±æ•—ï¼ˆè­¦å‘Šï¼‰"
          fi

          echo "\n[2/4] ã‚¯ãƒ©ã‚¹ã‚¿å†…ã‹ã‚‰ board-api Service ã¸ã‚¢ã‚¯ã‚»ã‚¹"
          if kubectl run tmp-curl2 --rm -i --restart=Never --image=curlimages/curl -n "$BOARD_NS" -- curl -sI http://board-api.board-app.svc.cluster.local:3000/api/posts | head -n1; then
            echo "âœ… board-api Service ç–é€šæˆåŠŸ"
          else
            echo "âš ï¸ board-api Service ç–é€šå¤±æ•—ï¼ˆè­¦å‘Šï¼‰"
          fi

          # LoadBalancer çµŒç”±ã®å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ
          echo "\n[3/4] LoadBalancer çµŒç”±ã§ HTML ã‚’å–å¾—"
          if curl -sf "http://${LB_IP}/" -o /dev/null; then
            echo "âœ… HTML é…ä¿¡æˆåŠŸ"
            curl -s "http://${LB_IP}/" | grep -o '<title>.*</title>' || echo "ã‚¿ã‚¤ãƒˆãƒ«ã‚¿ã‚°ãªã—"
          else
            echo "âŒ HTML é…ä¿¡å¤±æ•—"
            exit 1
          fi

          echo "\n[4/4] LoadBalancer çµŒç”±ã§ API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ç¢ºèª"
          API_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "http://${LB_IP}/api/posts" || echo "000")
          echo "API ãƒ¬ã‚¹ãƒãƒ³ã‚¹: $API_STATUS"
          if [ "$API_STATUS" = "200" ] || [ "$API_STATUS" = "304" ]; then
            echo "âœ… API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆç–é€šæˆåŠŸ"
          else
            echo "âš ï¸ API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå¿œç­”ç•°å¸¸ (HTTP $API_STATUS)ã€‚Ingress ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„"
          fi

          echo "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤ã‚µãƒãƒªã‚’å‡ºåŠ›
        run: |
          BOARD_NS=$(grep kubernetesNamespace "$KUSTOMIZE_DIR/vars.env" | cut -d'=' -f2)
          LB_IP=${ACTUAL_LB_IP:-}
          echo "## ğŸ¯ æ²ç¤ºæ¿ã‚¢ãƒ—ãƒª AKS ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Namespace**: \`$BOARD_NS\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¿ã‚°**: \`$IMAGE_TAG\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ACR**: \`$ACR_LOGIN_SERVER\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ ã‚¢ã‚¯ã‚»ã‚¹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -n "$LB_IP" ]; then
            echo "- **Load Balancer IP**: http://$LB_IP" >> $GITHUB_STEP_SUMMARY
            echo "- **ãƒ€ãƒŸãƒ¼ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ**: http://$LB_IP/dummy-secret.txt" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ LoadBalancer IP å–å¾—å¾…æ©Ÿä¸­" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµæœ (GitGuardian + Gitleaks + Trivy)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # GitGuardian çµæœï¼ˆè©³ç´°è¡¨ç¤ºï¼‰
          GG_ISSUES="${{ needs.gitguardian-scan.outputs.gitguardian_issues || '0' }}"
          if [ "$GG_ISSUES" = "0" ]; then
            echo "- âœ… **GitGuardian**: ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãªã— (400+ ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œè¨¼)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ **GitGuardian**: $GG_ISSUES ä»¶ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œå‡º (400+ ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œè¨¼)" >> $GITHUB_STEP_SUMMARY
            
            # GitGuardian ã®è©³ç´°ã‚’å–å¾—ï¼ˆartifact ã‹ã‚‰ SARIF ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰
            if gh run download "${{ github.run_id }}" --name gitguardian-results --dir temp-gg 2>/dev/null; then
              if [ -f temp-gg/gitguardian-repo.sarif ]; then
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "  **æ¤œå‡ºã•ã‚ŒãŸã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆï¼ˆä¸Šä½5ä»¶ï¼‰:**" >> $GITHUB_STEP_SUMMARY
                jq -r '.runs[0].results[0:5] | .[] | "  - \(.ruleId): \(.message.text) (\(.locations[0].physicalLocation.artifactLocation.uri):\(.locations[0].physicalLocation.region.startLine))"' \
                  temp-gg/gitguardian-repo.sarif >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "  - (è©³ç´°å–å¾—å¤±æ•—)" >> $GITHUB_STEP_SUMMARY
                rm -rf temp-gg
              fi
            fi
          fi

          # code-security-scans job ã®çµæœ
          GITLEAKS="${{ needs.code-security-scans.outputs.gitleaks_issues || '0' }}"
          FS_CRITICAL="${{ needs.code-security-scans.outputs.trivy_fs_critical || '0' }}"
          FS_HIGH="${{ needs.code-security-scans.outputs.trivy_fs_high || '0' }}"

          # build-and-push job ã®çµæœ
          IMG_CRITICAL="${{ needs.build-and-push.outputs.board_image_critical || '0' }}"
          IMG_HIGH="${{ needs.build-and-push.outputs.board_image_high || '0' }}"
          API_CRITICAL="${{ needs.build-and-push.outputs.api_image_critical || '0' }}"
          API_HIGH="${{ needs.build-and-push.outputs.api_image_high || '0' }}"

          # Gitleaks
          if [ "$GITLEAKS" = "0" ]; then
            echo "- âœ… **Gitleaks**: ç§˜å¯†æƒ…å ±ãªã—" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ **Gitleaks**: $GITLEAKS ä»¶ã®ç§˜å¯†æƒ…å ±æ¤œå‡º" >> $GITHUB_STEP_SUMMARY
            
            # Gitleaks ã®è©³ç´°ã‚’å–å¾—ï¼ˆartifact ã‹ã‚‰ SARIF ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰
            if gh run download "${{ github.run_id }}" --name code-security-scans-sarif --dir temp-gitleaks 2>/dev/null; then
              if [ -f temp-gitleaks/gitleaks-board.sarif ]; then
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "  **æ¤œå‡ºã•ã‚ŒãŸç§˜å¯†æƒ…å ±ï¼ˆä¸Šä½3ä»¶ï¼‰:**" >> $GITHUB_STEP_SUMMARY
                jq -r '.runs[0].results[0:3] | .[] | 
                  "  - `\(.ruleId)` - \(.locations[0].physicalLocation.artifactLocation.uri):\(.locations[0].physicalLocation.region.startLine)"' \
                  temp-gitleaks/gitleaks-board.sarif >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "  - (è©³ç´°å–å¾—å¤±æ•—)" >> $GITHUB_STEP_SUMMARY
                rm -rf temp-gitleaks
              fi
            fi
          fi

          # Trivy FS
          if [ "$FS_CRITICAL" = "0" ] && [ "$FS_HIGH" = "0" ]; then
            echo "- âœ… **Trivy FS** (ã‚½ãƒ¼ã‚¹): CRITICAL 0ä»¶ã€HIGH 0ä»¶" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ **Trivy FS** (ã‚½ãƒ¼ã‚¹): CRITICAL $FS_CRITICAL ä»¶ã€HIGH $FS_HIGH ä»¶" >> $GITHUB_STEP_SUMMARY
          fi

          # Trivy Image (Board)
          if [ "$IMG_CRITICAL" = "0" ] && [ "$IMG_HIGH" = "0" ]; then
            echo "- âœ… **Trivy Image** (Board App): CRITICAL 0ä»¶ã€HIGH 0ä»¶" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ **Trivy Image** (Board App): CRITICAL $IMG_CRITICAL ä»¶ã€HIGH $IMG_HIGH ä»¶" >> $GITHUB_STEP_SUMMARY
            
            # Trivy Image (Board) ã®è©³ç´°ã‚’å–å¾—
            if gh run download "${{ github.run_id }}" --name board-app-image --dir temp-trivy-board 2>/dev/null; then
              if [ -f temp-trivy-board/trivy-image-board.sarif ]; then
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "  **ä¸»ãªè„†å¼±æ€§ï¼ˆä¸Šä½3ä»¶ï¼‰:**" >> $GITHUB_STEP_SUMMARY
                jq -r '.runs[0].results[0:3] | .[] | 
                  "  - **\(.level | ascii_upcase)** `\(.ruleId)` - \(.message.text | split("\n")[0] | .[0:80])"' \
                  temp-trivy-board/trivy-image-board.sarif >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "  - (è©³ç´°å–å¾—å¤±æ•—)" >> $GITHUB_STEP_SUMMARY
                rm -rf temp-trivy-board
              fi
            fi
          fi

          # Trivy Image (Board API)
          if [ "$API_CRITICAL" = "0" ] && [ "$API_HIGH" = "0" ]; then
            echo "- âœ… **Trivy Image** (Board API): CRITICAL 0ä»¶ã€HIGH 0ä»¶" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ **Trivy Image** (Board API): CRITICAL $API_CRITICAL ä»¶ã€HIGH $API_HIGH ä»¶" >> $GITHUB_STEP_SUMMARY
            
            # Trivy Image (Board API) ã®è©³ç´°ã‚’å–å¾—
            if gh run download "${{ github.run_id }}" --name board-api-image --dir temp-trivy-api 2>/dev/null; then
              if [ -f temp-trivy-api/trivy-image-board-api.sarif ]; then
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "  **ä¸»ãªè„†å¼±æ€§ï¼ˆä¸Šä½3ä»¶ï¼‰:**" >> $GITHUB_STEP_SUMMARY
                jq -r '.runs[0].results[0:3] | .[] | 
                  "  - **\(.level | ascii_upcase)** `\(.ruleId)` - \(.message.text | split("\n")[0] | .[0:80])"' \
                  temp-trivy-api/trivy-image-board-api.sarif >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "  - (è©³ç´°å–å¾—å¤±æ•—)" >> $GITHUB_STEP_SUMMARY
                rm -rf temp-trivy-api
              fi
            fi
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> è©³ç´°ã¯ [Security ã‚¿ãƒ–](https://github.com/${{ github.repository }}/security/code-scanning) ã‚’ç¢ºèªã—ã¦ãã ã•ã„" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¦ Pod çŠ¶æ…‹" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n "$BOARD_NS" -o wide >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸŒ Ingress çŠ¶æ…‹" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          kubectl get ingress -n "$BOARD_NS" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ” ç–é€šç¢ºèª" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          API_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "http://${LB_IP}/api/posts" || echo "000")
          if [ "$API_STATUS" = "200" ] || [ "$API_STATUS" = "304" ]; then
            echo "- âœ… API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: HTTP $API_STATUS" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: HTTP $API_STATUS (è¦ç¢ºèª)" >> $GITHUB_STEP_SUMMARY
          fi

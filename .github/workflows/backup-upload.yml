name: üîÑ MySQL Backup Upload (Scheduled)

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  RESOURCE_GROUP_NAME: ${{ vars.RESOURCE_GROUP_NAME }}
  VM_NAME: ${{ vars.VM_NAME }}
  STORAGE_ACCOUNT_PREFIX: ${{ vars.STORAGE_ACCOUNT_PREFIX }}
  BACKUP_CONTAINER_NAME: ${{ vars.BACKUP_CONTAINER_NAME }}

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: Azure „Å´ Service Principal „Åß„É≠„Ç∞„Ç§„É≥
        uses: azure/login@v2
        with:
          creds: >-
            {"clientId":"${{ vars.AZURE_CLIENT_ID }}","tenantId":"${{ vars.AZURE_TENANT_ID }}","clientSecret":"${{ vars.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}"}

      - name: „Çπ„Éà„É¨„Éº„Ç∏„Ç¢„Ç´„Ç¶„É≥„ÉàÂêç„ÇíËß£Ê±∫
        run: |
          set -euo pipefail
          if [ -z "$STORAGE_ACCOUNT_PREFIX" ] || [ -z "$RESOURCE_GROUP_NAME" ]; then
            echo "„Çπ„Éà„É¨„Éº„Ç∏„Ç¢„Ç´„Ç¶„É≥„ÉàÂêç„ÇíÊ±∫ÂÆö„Åô„Çã„Åü„ÇÅ„ÅÆÂ§âÊï∞„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô" >&2
            exit 1
          fi
          STORAGE_ACCOUNT_NAME=$(az storage account list \
            --resource-group "$RESOURCE_GROUP_NAME" \
            --query "[?starts_with(name, '${STORAGE_ACCOUNT_PREFIX}')].name | [0]" \
            -o tsv)
          if [ -z "$STORAGE_ACCOUNT_NAME" ]; then
            echo "ÊåáÂÆö„Éó„É¨„Éï„Ç£„ÉÉ„ÇØ„Çπ„ÅÆ„Çπ„Éà„É¨„Éº„Ç∏„Ç¢„Ç´„Ç¶„É≥„Éà„ÅåÂ≠òÂú®„Åó„Åæ„Åõ„Çì„ÄÇinfra-deploy „ÇíÂÖà„Å´ÂÆüË°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ" >&2
            exit 1
          fi
          echo "STORAGE_ACCOUNT_NAME=$STORAGE_ACCOUNT_NAME" >> "$GITHUB_ENV"

      - name: VM ‰∏ä„Åß„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÇíÂÆüË°å„Åó„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ (Managed Identity)
        env:
          MYSQL_ROOT_PASSWORD: ${{ vars.MYSQL_ROOT_PASSWORD }}
        run: |
          set -euo pipefail
          SCRIPT_PATH="$RUNNER_TEMP/mysql-backup.sh"
          MYSQL_PASSWORD_B64=$(printf '%s' "$MYSQL_ROOT_PASSWORD" | base64 -w0)
          cat <<'SCRIPT' > "$SCRIPT_PATH"
          #!/bin/bash
          set -euo pipefail

          : "${storageAccountName:?storageAccountName is required}"
          : "${backupContainerName:?backupContainerName is required}"
          : "${mysqlPasswordB64:?mysqlPasswordB64 is required}"

          STORAGE_ACCOUNT_NAME="$storageAccountName"
          BACKUP_CONTAINER_NAME="$backupContainerName"
          MYSQL_ROOT_PASSWORD=$(printf '%s' "$mysqlPasswordB64" | base64 -d)

          TIMESTAMP=$(date -u +%Y%m%d%H%M%S)
          BACKUP_DIR=/tmp/mysql-backups
          mkdir -p "$BACKUP_DIR"
          BACKUP_FILE="$BACKUP_DIR/backup-$TIMESTAMP.sql"

          # Azure CLI „Åå„Ç§„É≥„Çπ„Éà„Éº„É´„Åï„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç
          if ! command -v az >/dev/null 2>&1; then
            echo "Azure CLI „Åå„Ç§„É≥„Çπ„Éà„Éº„É´„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì" >&2
            exit 1
          fi

          # Managed Identity „Åß Azure „Å´„É≠„Ç∞„Ç§„É≥
          echo "Managed Identity „Åß„É≠„Ç∞„Ç§„É≥‰∏≠..."
          az login --identity --allow-no-subscriptions >/dev/null 2>&1

          # „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Ç≥„É≥„ÉÜ„Éä„ÅÆÂ≠òÂú®Á¢∫Ë™ç„Å®‰ΩúÊàê
          echo "„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Ç≥„É≥„ÉÜ„Éä„ÇíÁ¢∫Ë™ç‰∏≠..."
          EXISTS=$(az storage container exists \
            --account-name "$STORAGE_ACCOUNT_NAME" \
            --name "$BACKUP_CONTAINER_NAME" \
            --auth-mode login \
            --query exists -o tsv 2>/dev/null || echo "false")
          
          if [ "$EXISTS" != "true" ]; then
            echo "„Ç≥„É≥„ÉÜ„Éä $BACKUP_CONTAINER_NAME „Çí‰ΩúÊàê‰∏≠..."
            az storage container create \
              --account-name "$STORAGE_ACCOUNT_NAME" \
              --name "$BACKUP_CONTAINER_NAME" \
              --auth-mode login \
              --public-access off >/dev/null
            echo "„Ç≥„É≥„ÉÜ„Éä $BACKUP_CONTAINER_NAME „Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü"
          else
            echo "„Ç≥„É≥„ÉÜ„Éä $BACKUP_CONTAINER_NAME „ÅØÊó¢„Å´Â≠òÂú®„Åó„Å¶„ÅÑ„Åæ„Åô"
          fi

          # MySQL „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÂÆüË°å
          echo "MySQL „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÇíÂÆüË°å‰∏≠..."
          mysqldump --all-databases --single-transaction --quick --lock-tables=false -u root -p"$MYSQL_ROOT_PASSWORD" > "$BACKUP_FILE"

          # azcopy „ÅÆ„Ç§„É≥„Çπ„Éà„Éº„É´Á¢∫Ë™ç
          if ! command -v azcopy >/dev/null 2>&1; then
            echo "azcopy „Çí„Ç§„É≥„Çπ„Éà„Éº„É´‰∏≠..."
            TMPDIR=$(mktemp -d)
            curl -sSL https://aka.ms/downloadazcopy-v10-linux | tar -xz -C "$TMPDIR"
            AZCOPY_PATH=$(find "$TMPDIR" -name azcopy -type f | head -n 1)
            sudo install -m 755 "$AZCOPY_PATH" /usr/local/bin/azcopy
          fi

          # Managed Identity „ÅßË™çË®º„Åó„Å¶„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
          echo "„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Éï„Ç°„Ç§„É´„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ‰∏≠..."
          export AZCOPY_AUTO_LOGIN_TYPE=MSI
          DEST_URL="https://${STORAGE_ACCOUNT_NAME}.blob.core.windows.net/${BACKUP_CONTAINER_NAME}/backup-${TIMESTAMP}.sql"
          azcopy copy "$BACKUP_FILE" "$DEST_URL" --from-to=LocalBlob --overwrite ifSourceNewer --log-level INFO
          if [ $? -eq 0 ]; then
            echo "„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÂÆå‰∫Ü: backup-${TIMESTAMP}.sql"
            logger "mysql-backup-upload success $TIMESTAMP (Managed Identity)"
          else
            logger "mysql-backup-upload failed $TIMESTAMP"
            cat ~/.azcopy/*.log 2>/dev/null | tail -n 50 >&2 || true
            exit 1
          fi
          SCRIPT
          chmod +x "$SCRIPT_PATH"

          az vm run-command invoke \
            --resource-group "$RESOURCE_GROUP_NAME" \
            --name "$VM_NAME" \
            --command-id RunShellScript \
            --scripts @"$SCRIPT_PATH" \
            --parameters storageAccountName="$STORAGE_ACCOUNT_NAME" \
                         backupContainerName="$BACKUP_CONTAINER_NAME" \
                         mysqlPasswordB64="$MYSQL_PASSWORD_B64"

      - name: „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Çµ„Éû„É™„ÇíÂá∫Âäõ
        if: success()
        run: |
          TIMESTAMP=$(date -u +%Y%m%d%H%M%S)
          BACKUP_URL="https://${STORAGE_ACCOUNT_NAME}.blob.core.windows.net/${BACKUP_CONTAINER_NAME}/backup-${TIMESTAMP}.sql"

          echo "## üîÑ MySQL „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÂÆå‰∫Ü" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì¶ „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÊÉÖÂ†±" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **VM Âêç**: \`$VM_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "- **„Çπ„Éà„É¨„Éº„Ç∏„Ç¢„Ç´„Ç¶„É≥„Éà**: \`$STORAGE_ACCOUNT_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "- **„Ç≥„É≥„ÉÜ„Éä**: \`$BACKUP_CONTAINER_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "- **„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Éï„Ç°„Ç§„É´**: \`backup-${TIMESTAMP}.sql\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìç „Ç¢„ÇØ„Çª„ÇπÊÉÖÂ†±" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Blob URL**: \`$BACKUP_URL\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> üí° Azure Portal „ÅÆ Storage Account „Åã„ÇâÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÂÆüË°åÊó•ÊôÇ: $(date +'%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
          echo "üîÑ Ê¨°ÂõûÂÆöÊúüÂÆüË°å: 1ÊôÇÈñì„Åî„Å®" >> $GITHUB_STEP_SUMMARY

name: 2ï¸âƒ£ Admin App Build & Deploy

on:
  workflow_dispatch:
    inputs:
      redeployTag:
        description: "ACR ã«æ—¢å­˜ã‚¿ã‚°ãŒã‚ã‚‹å ´åˆã«å†ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ (ç©ºãªã‚‰æœ€æ–°ã‚³ãƒŸãƒƒãƒˆã‚’ãƒ“ãƒ«ãƒ‰)"
        required: false
  push:
    branches:
      - master
    paths:
      - "app/admin-app/**"
      - ".github/workflows/2-admin-app-build-deploy.yml"
  workflow_run:
    workflows:
      - "1ï¸âƒ£ Infrastructure Deploy"
    types:
      - completed

permissions:
  contents: read
  id-token: write
  security-events: write

env:
  RESOURCE_GROUP_NAME: ${{ vars.RESOURCE_GROUP_NAME }}
  ACA_ENVIRONMENT_NAME: ${{ vars.ACA_ENVIRONMENT_NAME }}
  CONTAINER_APP_NAME: ${{ vars.ADMIN_CONTAINER_APP_NAME }}
  ACR_NAME_PREFIX: ${{ vars.ACR_NAME_PREFIX }}
  STORAGE_ACCOUNT_PREFIX: ${{ vars.STORAGE_ACCOUNT_PREFIX }}
  ADMIN_IMAGE_NAME: admin-app
  ADMIN_TARGET_PORT: 8000
  BACKUP_CONTAINER: ${{ vars.BACKUP_CONTAINER_NAME }}
  DB_APP_USERNAME: ${{ vars.DB_APP_USERNAME }}
  DB_APP_PASSWORD: ${{ vars.DB_APP_PASSWORD }}
  ACA_ADMIN_USERNAME: ${{ vars.ACA_ADMIN_USERNAME }}
  ACA_ADMIN_PASSWORD: ${{ vars.ACA_ADMIN_PASSWORD }}
  PARAM_FILE: infra/parameters/main-dev.parameters.json
  GH_TOKEN: ${{ github.token }}

jobs:
  prepare-context:
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    outputs:
      checkout_ref: ${{ steps.detect_ref.outputs.checkout_ref }}
      image_tag: ${{ steps.detect_ref.outputs.image_tag }}
      build_required: ${{ steps.detect_ref.outputs.build_required }}
      acr_name: ${{ steps.resolve_acr.outputs.acr_name }}
      acr_login_server: ${{ steps.resolve_acr.outputs.acr_login_server }}
      resource_group_name: ${{ steps.resolve_rg.outputs.resource_group_name }}
      storage_account_name: ${{ steps.resolve_storage.outputs.storage_account_name }}
      aca_environment_name: ${{ steps.resolve_env.outputs.aca_environment_name }}
      db_endpoint: ${{ steps.mysql_endpoint.outputs.db_endpoint }}
    env:
      REDEPLOY_TAG: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.redeployTag || '' }}
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
        uses: actions/checkout@v4

      - name: ãƒ“ãƒ«ãƒ‰å¯¾è±¡ã‚³ãƒŸãƒƒãƒˆã¨ã‚¿ã‚°ã‚’æ±ºå®š
        id: detect_ref
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            REF='${{ github.event.workflow_run.head_sha }}'
          else
            REF='${{ github.sha }}'
          fi
          BUILD_REQUIRED=true
          IMAGE_TAG=""
          if [ -n "${REDEPLOY_TAG}" ]; then
            BUILD_REQUIRED=false
            IMAGE_TAG="${REDEPLOY_TAG}"
          fi
          if [ -z "$IMAGE_TAG" ]; then
            IMAGE_TAG="${REF:0:12}"
          fi
          echo "checkout_ref=$REF" >> "$GITHUB_OUTPUT"
          echo "image_tag=$IMAGE_TAG" >> "$GITHUB_OUTPUT"
          echo "build_required=$BUILD_REQUIRED" >> "$GITHUB_OUTPUT"

      - name: Azure ã« Service Principal ã§ãƒ­ã‚°ã‚¤ãƒ³
        uses: azure/login@v2
        with:
          creds: >-
            {"clientId":"${{ vars.AZURE_CLIENT_ID }}","tenantId":"${{ vars.AZURE_TENANT_ID }}","clientSecret":"${{ vars.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}"}

      - name: ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’è§£æ±º
        id: resolve_rg
        run: |
          set -euo pipefail
          RG_NAME="${RESOURCE_GROUP_NAME}"
          if [ -z "$RG_NAME" ]; then
            echo "ResourceGroup ã‚’ç‰¹å®šã§ãã¾ã›ã‚“" >&2
            exit 1
          fi
          if ! az group show --name "$RG_NAME" &>/dev/null; then
            echo "æŒ‡å®š RG ($RG_NAME) ãŒå­˜åœ¨ã—ã¾ã›ã‚“" >&2
            az group list --query '[].name' -o tsv >&2 || true
            exit 2
          fi
          echo "resource_group_name=$RG_NAME" >> "$GITHUB_OUTPUT"

      - name: ACR åã‚’è§£æ±º
        id: resolve_acr
        env:
          RESOLVED_RG: ${{ steps.resolve_rg.outputs.resource_group_name }}
        run: |
          set -euo pipefail
          ACR_NAME=$(az acr list --resource-group "$RESOLVED_RG" --query "[?starts_with(name, '${ACR_NAME_PREFIX}')].name | [0]" -o tsv)
          if [ -z "$ACR_NAME" ]; then
            echo "ACR ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" >&2
            exit 1
          fi
          echo "acr_name=$ACR_NAME" >> "$GITHUB_OUTPUT"
          echo "acr_login_server=${ACR_NAME}.azurecr.io" >> "$GITHUB_OUTPUT"

      - name: Storage Account åã‚’è§£æ±º
        id: resolve_storage
        env:
          RESOLVED_RG: ${{ steps.resolve_rg.outputs.resource_group_name }}
        run: |
          set -euo pipefail
          STORAGE_NAME=$(az storage account list --resource-group "$RESOLVED_RG" --query "[?starts_with(name, '${STORAGE_ACCOUNT_PREFIX}')].name | [0]" -o tsv)
          if [ -z "$STORAGE_NAME" ]; then
            echo "Storage Account ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" >&2
            exit 1
          fi
          echo "storage_account_name=$STORAGE_NAME" >> "$GITHUB_OUTPUT"

      - name: Container Apps Environment åã‚’è§£æ±º
        id: resolve_env
        env:
          RESOLVED_RG: ${{ steps.resolve_rg.outputs.resource_group_name }}
        run: |
          set -euo pipefail
          ENV_NAME=$(az containerapp env list --resource-group "$RESOLVED_RG" --query "[0].name" -o tsv)
          if [ -z "$ENV_NAME" ]; then
            echo "Container Apps Environment ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" >&2
            exit 1
          fi
          echo "aca_environment_name=$ENV_NAME" >> "$GITHUB_OUTPUT"

      - name: ã‚¤ãƒ³ãƒ•ãƒ©å‡ºåŠ›ã‹ã‚‰ MySQL Private IP ã‚’å–å¾—
        id: mysql_endpoint
        env:
          INFRA_WORKFLOW_NAME: "1ï¸âƒ£ Infrastructure Deploy"
          RESOLVED_RG: ${{ steps.resolve_rg.outputs.resource_group_name }}
        run: |
          set -euo pipefail
          mkdir -p infra-output
          MYSQL_IP=""
          if [ "${{ github.event_name }}" = "workflow_run" ] && [ "${{ github.event.workflow_run.name }}" = "$INFRA_WORKFLOW_NAME" ]; then
            TARGET_RUN_ID='${{ github.event.workflow_run.id }}'
          else
            TARGET_RUN_ID=$(curl -s -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/repos/${{ github.repository }}/actions/workflows/1-infra-deploy.yml/runs?status=success&per_page=1" \
              | jq -r '.workflow_runs[0].id')
          fi
          if [ -n "$TARGET_RUN_ID" ] && [ "$TARGET_RUN_ID" != "null" ]; then
            if gh run download "$TARGET_RUN_ID" --name infra-outputs --dir infra-output >/dev/null 2>&1; then
              OUTPUT_FILE=$(find infra-output -name '*.json' | head -n1)
              if [ -n "$OUTPUT_FILE" ]; then
                MYSQL_IP=$(jq -r '.mysqlPrivateIp.value // empty' "$OUTPUT_FILE")
                echo "infra_output_path=$OUTPUT_FILE" >> "$GITHUB_OUTPUT"
              fi
            fi
          fi
          if [ -z "$MYSQL_IP" ]; then
            echo "infra-outputs ã‹ã‚‰ MySQL IP ã‚’å–å¾—ã§ããªã‹ã£ãŸãŸã‚ Azure ãƒªã‚½ãƒ¼ã‚¹ã‹ã‚‰è§£æ±ºã—ã¾ã™" >&2
            VM_NAME=$(jq -r '.parameters.vmName.value // empty' "$PARAM_FILE")
            if [ -z "$VM_NAME" ]; then
              echo "parameters ãƒ•ã‚¡ã‚¤ãƒ«ã« vmName ãŒå­˜åœ¨ã—ã¾ã›ã‚“" >&2
              exit 1
            fi
            MYSQL_IP=$(az vm list-ip-addresses --resource-group "$RESOLVED_RG" --name "$VM_NAME" --query "[0].virtualMachine.network.privateIpAddresses[0]" -o tsv || true)
          fi
          MYSQL_PORT=$(jq -r '.parameters.mysqlPort.value // 3306' "$PARAM_FILE")
          if [ -z "$MYSQL_IP" ] || [ "$MYSQL_IP" = "null" ]; then
            echo "MySQL Private IP ã‚’ Azure ã‹ã‚‰å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ" >&2
            exit 1
          fi
          echo "db_endpoint=${MYSQL_IP}:${MYSQL_PORT}" >> "$GITHUB_OUTPUT"

  code-security-scans:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write # SARIF ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§å¿…è¦
    needs: prepare-context
    if: ${{ needs.prepare-context.outputs.build_required == 'true' }}
    outputs:
      gitleaks_issues: ${{ steps.scan_summary.outputs.gitleaks_issues }}
      trivy_fs_critical: ${{ steps.scan_summary.outputs.trivy_fs_critical }}
      trivy_fs_high: ${{ steps.scan_summary.outputs.trivy_fs_high }}
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare-context.outputs.checkout_ref }}

      - name: Gitleaks ã§ç§˜å¯†æƒ…å ±ã‚’æ¤œå‡º
        continue-on-error: true
        run: |
          set +e
          VERSION="8.18.4"
          curl -sSL "https://github.com/gitleaks/gitleaks/releases/download/v${VERSION}/gitleaks_${VERSION}_linux_x64.tar.gz" -o gitleaks.tgz
          tar -xzf gitleaks.tgz gitleaks
          sudo install -m 755 gitleaks /usr/local/bin/gitleaks
          gitleaks detect --no-banner --report-format sarif --report-path gitleaks-admin.sarif
          echo "Gitleaks completed (exit code=$?)"

      - name: ã‚½ãƒ¼ã‚¹/è¨­å®š/ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç·åˆã‚¹ã‚­ãƒ£ãƒ³ (Trivy FS)
        continue-on-error: true
        run: |
          set -euo pipefail
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b ./trivy-bin
          ./trivy-bin fs --scanners vuln,secret,config --ignore-unfixed --severity CRITICAL,HIGH \
            --format sarif --output trivy-fs-admin.sarif app/admin-app || echo "è„†å¼±æ€§æ¤œå‡ºã‚ã‚Š"

      - name: Trivy FS ãƒ¬ãƒãƒ¼ãƒˆã‚’ä¿è¨¼
        if: always()
        run: |
          set -euo pipefail
          if [ ! -f trivy-fs-admin.sarif ]; then
            # Python ã§ç©ºã® SARIF ã‚’ç”Ÿæˆã—ã¦ YAML ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆå´©ã‚Œã‚’å›žé¿
            python -c 'import json, pathlib; payload = {"version": "2.1.0", "runs": [{"tool": {"driver": {"name": "trivy", "informationUri": "https://github.com/aquasecurity/trivy"}}, "results": []}]}; pathlib.Path("trivy-fs-admin.sarif").write_text(json.dumps(payload, indent=2))'
          fi

      - name: Trivy SARIF ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (FS)
        if: always()
        continue-on-error: true
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-fs-admin.sarif

      - name: Gitleaks SARIF ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: always()
        continue-on-error: true
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: gitleaks-admin.sarif

      - name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµæžœã‚’é›†è¨ˆ
        id: scan_summary
        if: always()
        run: |
          set +e
          # Gitleaksçµæžœ
          GITLEAKS_ISSUES=0
          if [ -f gitleaks-admin.sarif ]; then
            GITLEAKS_ISSUES=$(jq '[.runs[].results // []] | add | length' gitleaks-admin.sarif 2>/dev/null || echo "0")
          fi
          echo "gitleaks_issues=$GITLEAKS_ISSUES" >> "$GITHUB_OUTPUT"
          
          # Trivy FSçµæžœ
          TRIVY_FS_CRITICAL=0
          TRIVY_FS_HIGH=0
          if [ -f trivy-fs-admin.sarif ]; then
            TRIVY_FS_CRITICAL=$(jq '[.runs[].results[] | select(.level == "error")] | length' trivy-fs-admin.sarif 2>/dev/null || echo "0")
            TRIVY_FS_HIGH=$(jq '[.runs[].results[] | select(.level == "warning")] | length' trivy-fs-admin.sarif 2>/dev/null || echo "0")
          fi
          echo "trivy_fs_critical=$TRIVY_FS_CRITICAL" >> "$GITHUB_OUTPUT"
          echo "trivy_fs_high=$TRIVY_FS_HIGH" >> "$GITHUB_OUTPUT"

  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write # SARIF ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§å¿…è¦
    needs:
      - prepare-context
      - code-security-scans
    if: ${{ needs.prepare-context.result == 'success' && (needs.code-security-scans.result == 'success' || needs.code-security-scans.result == 'skipped') }}
    outputs:
      image_tag: ${{ steps.metadata.outputs.image_tag }}
      admin_image_full: ${{ steps.metadata.outputs.admin_image_full }}
      admin_image_critical: ${{ steps.image_scan_summary.outputs.admin_image_critical }}
      admin_image_high: ${{ steps.image_scan_summary.outputs.admin_image_high }}
    env:
      CHECKOUT_REF: ${{ needs.prepare-context.outputs.checkout_ref }}
      IMAGE_TAG: ${{ needs.prepare-context.outputs.image_tag }}
      ACR_NAME: ${{ needs.prepare-context.outputs.acr_name }}
      ACR_LOGIN_SERVER: ${{ needs.prepare-context.outputs.acr_login_server }}
      BUILD_REQUIRED: ${{ needs.prepare-context.outputs.build_required }}
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
        uses: actions/checkout@v4
        with:
          ref: ${{ env.CHECKOUT_REF }}

      - name: ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        id: metadata
        run: |
          IMAGE_FULL="$ACR_LOGIN_SERVER/$ADMIN_IMAGE_NAME:$IMAGE_TAG"
          echo "image_tag=$IMAGE_TAG" >> "$GITHUB_OUTPUT"
          echo "admin_image_full=$IMAGE_FULL" >> "$GITHUB_OUTPUT"
          echo "ADMIN_IMAGE_FULL=$IMAGE_FULL" >> "$GITHUB_ENV"

      - name: Azure ã« Service Principal ã§ãƒ­ã‚°ã‚¤ãƒ³
        if: ${{ env.BUILD_REQUIRED == 'true' }}
        uses: azure/login@v2
        with:
          creds: >-
            {"clientId":"${{ vars.AZURE_CLIENT_ID }}","tenantId":"${{ vars.AZURE_TENANT_ID }}","clientSecret":"${{ vars.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}"}

      - name: ACR ç®¡ç†è€…èªè¨¼ã‚’æœ‰åŠ¹åŒ–
        if: ${{ env.BUILD_REQUIRED == 'true' }}
        run: az acr update --name "$ACR_NAME" --admin-enabled true

      - name: ACR ã¸ãƒ­ã‚°ã‚¤ãƒ³
        if: ${{ env.BUILD_REQUIRED == 'true' }}
        run: az acr login --name "$ACR_NAME"

      - name: ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰
        if: ${{ env.BUILD_REQUIRED == 'true' }}
        run: |
          docker build --file app/admin-app/Dockerfile --tag "$ADMIN_IMAGE_FULL" app/admin-app
          docker tag "$ADMIN_IMAGE_FULL" "$ACR_LOGIN_SERVER/$ADMIN_IMAGE_NAME:latest"

      - name: Trivy DB ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¾©å…ƒ
        if: ${{ env.BUILD_REQUIRED == 'true' }}
        uses: actions/cache@v4
        with:
          path: ~/.cache/trivy
          key: trivy-db-${{ runner.os }}-${{ hashFiles('app/admin-app/requirements.txt') }}
          restore-keys: |
            trivy-db-${{ runner.os }}-

      - name: ã‚³ãƒ³ãƒ†ãƒŠ SBOM ç”Ÿæˆ (CycloneDX)
        if: ${{ env.BUILD_REQUIRED == 'true' }}
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.ADMIN_IMAGE_FULL }}
          format: "cyclonedx"
          output: "sbom-admin.cdx.json"
          hide-progress: true
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH"
          exit-code: "0"

      - name: Trivy ã§ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¹ã‚­ãƒ£ãƒ³ (SARIF)
        if: ${{ env.BUILD_REQUIRED == 'true' }}
        uses: aquasecurity/trivy-action@0.28.0
        continue-on-error: true
        with:
          image-ref: ${{ env.ADMIN_IMAGE_FULL }}
          format: "sarif"
          output: "trivy-image-admin.sarif"
          hide-progress: true
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH"
          exit-code: "0"

      - name: Trivy SARIF ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (Image)
        if: ${{ env.BUILD_REQUIRED == 'true' && always() }}
        continue-on-error: true
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-image-admin.sarif

      - name: ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¹ã‚­ãƒ£ãƒ³çµæžœã‚’é›†è¨ˆ
        id: image_scan_summary
        if: ${{ env.BUILD_REQUIRED == 'true' && always() }}
        run: |
          set +e
          # Admin App ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¹ã‚­ãƒ£ãƒ³çµæžœ
          ADMIN_IMAGE_CRITICAL=0
          ADMIN_IMAGE_HIGH=0
          if [ -f trivy-image-admin.sarif ]; then
            ADMIN_IMAGE_CRITICAL=$(jq '[.runs[].results[] | select(.level == "error")] | length' trivy-image-admin.sarif 2>/dev/null || echo "0")
            ADMIN_IMAGE_HIGH=$(jq '[.runs[].results[] | select(.level == "warning")] | length' trivy-image-admin.sarif 2>/dev/null || echo "0")
          fi
          echo "admin_image_critical=$ADMIN_IMAGE_CRITICAL" >> "$GITHUB_OUTPUT"
          echo "admin_image_high=$ADMIN_IMAGE_HIGH" >> "$GITHUB_OUTPUT"

      - name: ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ ACR ã¸ãƒ—ãƒƒã‚·ãƒ¥
        if: ${{ env.BUILD_REQUIRED == 'true' }}
        run: |
          docker push "$ADMIN_IMAGE_FULL"
          docker push "$ACR_LOGIN_SERVER/$ADMIN_IMAGE_NAME:latest"

      - name: æˆæžœãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        if: ${{ env.BUILD_REQUIRED == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: admin-app-image
          path: |
            sbom-admin.cdx.json
            trivy-image-admin.sarif

  deploy:
    runs-on: ubuntu-latest
    needs:
      - prepare-context
      - build-and-push
      - code-security-scans
    if: ${{ needs.prepare-context.result == 'success' && (needs.build-and-push.result == 'success' || needs.build-and-push.result == 'skipped') }}
    env:
      RESOURCE_GROUP_NAME: ${{ needs.prepare-context.outputs.resource_group_name }}
      ACR_NAME: ${{ needs.prepare-context.outputs.acr_name }}
      ACR_LOGIN_SERVER: ${{ needs.prepare-context.outputs.acr_login_server }}
      STORAGE_ACCOUNT_NAME: ${{ needs.prepare-context.outputs.storage_account_name }}
      ACA_ENVIRONMENT_NAME: ${{ needs.prepare-context.outputs.aca_environment_name }}
      DB_ENDPOINT: ${{ needs.prepare-context.outputs.db_endpoint }}
      IMAGE_TAG: ${{ needs.build-and-push.outputs.image_tag || needs.prepare-context.outputs.image_tag }}
      CHECKOUT_REF: ${{ needs.prepare-context.outputs.checkout_ref }}
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
        uses: actions/checkout@v4
        with:
          ref: ${{ env.CHECKOUT_REF }}

      - name: Azure ã« Service Principal ã§ãƒ­ã‚°ã‚¤ãƒ³
        uses: azure/login@v2
        with:
          creds: >-
            {"clientId":"${{ vars.AZURE_CLIENT_ID }}","tenantId":"${{ vars.AZURE_TENANT_ID }}","clientSecret":"${{ vars.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}"}

      - name: Container Apps CLI æ‹¡å¼µã‚’æ›´æ–°
        run: az extension add --name containerapp --upgrade

      - name: Container Apps Environment ã®ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°å®Œäº†ã‚’å¾…æ©Ÿ
        run: |
          set -euo pipefail
          MAX_RETRY=20
          for attempt in $(seq 1 $MAX_RETRY); do
            STATE=$(az containerapp env show --name "$ACA_ENVIRONMENT_NAME" --resource-group "$RESOURCE_GROUP_NAME" --query properties.provisioningState -o tsv || echo "Unknown")
            if [ "$STATE" = "Succeeded" ]; then
              echo "Environment is ready"
              break
            fi
            if [ "$attempt" -eq "$MAX_RETRY" ]; then
              echo "Container Apps Environment ãŒå®‰å®šã—ã¾ã›ã‚“" >&2
              exit 1
            fi
            sleep 30
          done

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ã‚¤ãƒ¡ãƒ¼ã‚¸å‚ç…§ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        run: |
          echo "ADMIN_IMAGE_FULL=$ACR_LOGIN_SERVER/$ADMIN_IMAGE_NAME:$IMAGE_TAG" >> "$GITHUB_ENV"

      - name: ACR èªè¨¼æƒ…å ±ã‚’å–å¾—
        run: |
          az acr update --name "$ACR_NAME" --admin-enabled true
          ACR_USERNAME=$(az acr credential show --name "$ACR_NAME" --query username -o tsv)
          ACR_PASSWORD=$(az acr credential show --name "$ACR_NAME" --query "passwords[0].value" -o tsv)
          echo "ACR_USERNAME=$ACR_USERNAME" >> "$GITHUB_ENV"
          echo "ACR_PASSWORD=$ACR_PASSWORD" >> "$GITHUB_ENV"

      - name: Container App ã‚’ä½œæˆ/æ›´æ–°
        run: |
          set -euo pipefail
          if az containerapp show --name "$CONTAINER_APP_NAME" --resource-group "$RESOURCE_GROUP_NAME" &>/dev/null; then
            az containerapp registry set --name "$CONTAINER_APP_NAME" --resource-group "$RESOURCE_GROUP_NAME" \
              --server "$ACR_LOGIN_SERVER" --username "$ACR_USERNAME" --password "$ACR_PASSWORD"
            az containerapp secret set --name "$CONTAINER_APP_NAME" --resource-group "$RESOURCE_GROUP_NAME" \
              --secrets admin-username="$ACA_ADMIN_USERNAME" admin-password="$ACA_ADMIN_PASSWORD"
            az containerapp update --name "$CONTAINER_APP_NAME" --resource-group "$RESOURCE_GROUP_NAME" \
              --image "$ADMIN_IMAGE_FULL" --revision-suffix "gh-${GITHUB_RUN_NUMBER}" \
              --set-env-vars \
                ADMIN_USERNAME=secretref:admin-username \
                ADMIN_PASSWORD=secretref:admin-password \
                DB_ENDPOINT="$DB_ENDPOINT" \
                DB_APP_USERNAME="$DB_APP_USERNAME" \
                DB_APP_PASSWORD="$DB_APP_PASSWORD" \
                DB_NAME="boardapp" \
                BACKUP_CONTAINER="$BACKUP_CONTAINER" \
                STORAGE_ACCOUNT_NAME="$STORAGE_ACCOUNT_NAME"
          else
            az containerapp create --name "$CONTAINER_APP_NAME" --resource-group "$RESOURCE_GROUP_NAME" \
              --environment "$ACA_ENVIRONMENT_NAME" --image "$ADMIN_IMAGE_FULL" \
              --ingress external --target-port "$ADMIN_TARGET_PORT" \
              --min-replicas 0 --max-replicas 1 \
              --registry-server "$ACR_LOGIN_SERVER" --registry-username "$ACR_USERNAME" --registry-password "$ACR_PASSWORD" \
              --revision-suffix "gh-${GITHUB_RUN_NUMBER}"
            az containerapp secret set --name "$CONTAINER_APP_NAME" --resource-group "$RESOURCE_GROUP_NAME" \
              --secrets admin-username="$ACA_ADMIN_USERNAME" admin-password="$ACA_ADMIN_PASSWORD"
            az containerapp update --name "$CONTAINER_APP_NAME" --resource-group "$RESOURCE_GROUP_NAME" \
              --set-env-vars \
                ADMIN_USERNAME=secretref:admin-username \
                ADMIN_PASSWORD=secretref:admin-password \
                DB_ENDPOINT="$DB_ENDPOINT" \
                DB_APP_USERNAME="$DB_APP_USERNAME" \
                DB_APP_PASSWORD="$DB_APP_PASSWORD" \
                DB_NAME="boardapp" \
                BACKUP_CONTAINER="$BACKUP_CONTAINER" \
                STORAGE_ACCOUNT_NAME="$STORAGE_ACCOUNT_NAME"
          fi
          az containerapp revision set-mode --name "$CONTAINER_APP_NAME" --resource-group "$RESOURCE_GROUP_NAME" --mode single

      - name: Container App ã«ã‚·ã‚¹ãƒ†ãƒ å‰²å½“ ID ã‚’ä»˜ä¸Ž
        run: |
          set -euo pipefail
          az containerapp identity assign --name "$CONTAINER_APP_NAME" --resource-group "$RESOURCE_GROUP_NAME" --system-assigned >/dev/null
          PRINCIPAL=$(az containerapp show --name "$CONTAINER_APP_NAME" --resource-group "$RESOURCE_GROUP_NAME" --query identity.principalId -o tsv)
          if [ -z "$PRINCIPAL" ] || [ "$PRINCIPAL" = "None" ]; then
            echo "system-assigned Managed Identity ã® Principal ID ã‚’å–å¾—ã§ãã¾ã›ã‚“" >&2
            exit 1
          fi
          echo "SYSTEM_IDENTITY_PRINCIPAL_ID=$PRINCIPAL" >> "$GITHUB_ENV"

      - name: Storage ã¸ Managed Identity æ¨©é™ã‚’ä»˜ä¸Ž
        run: |
          set -euo pipefail
          if [ -z "${SYSTEM_IDENTITY_PRINCIPAL_ID:-}" ]; then
            echo "SYSTEM_IDENTITY_PRINCIPAL_ID ãŒæœªè¨­å®šã§ã™" >&2
            exit 1
          fi
          STORAGE_SCOPE=$(az storage account show --name "$STORAGE_ACCOUNT_NAME" --resource-group "$RESOURCE_GROUP_NAME" --query id -o tsv)
          ROLE_DEFINITION_ID='ba92f5b4-2d11-453d-a403-e96b0029c9fe'
          ASSIGNMENT_EXISTS=$(az role assignment list --assignee-object-id "$SYSTEM_IDENTITY_PRINCIPAL_ID" --scope "$STORAGE_SCOPE" --role "$ROLE_DEFINITION_ID" --query "[0]" -o tsv)
          if [ -n "$ASSIGNMENT_EXISTS" ]; then
            echo "Storage Blob Data Contributor ã¯æ—¢ã«ä»˜ä¸Žæ¸ˆã¿"
          else
            az role assignment create --assignee-object-id "$SYSTEM_IDENTITY_PRINCIPAL_ID" --assignee-principal-type ServicePrincipal --role "$ROLE_DEFINITION_ID" --scope "$STORAGE_SCOPE" >/dev/null
            echo "Storage Blob Data Contributor ã‚’ä»˜ä¸Žã—ã¾ã—ãŸ"
          fi

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤ã‚µãƒžãƒªã‚’å‡ºåŠ›
        run: |
          FQDN=$(az containerapp show --name "$CONTAINER_APP_NAME" --resource-group "$RESOURCE_GROUP_NAME" --query properties.configuration.ingress.fqdn -o tsv)
          STATE=$(az containerapp show --name "$CONTAINER_APP_NAME" --resource-group "$RESOURCE_GROUP_NAME" --query properties.provisioningState -o tsv)
          STATUS=$(az containerapp show --name "$CONTAINER_APP_NAME" --resource-group "$RESOURCE_GROUP_NAME" --query properties.runningStatus -o tsv)
          echo "## ðŸŽ¯ ç®¡ç†ã‚¢ãƒ—ãƒª Container Apps ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Container App**: \`$CONTAINER_APP_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: \`$ACA_ENVIRONMENT_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ã‚¤ãƒ¡ãƒ¼ã‚¸**: \`$ACR_LOGIN_SERVER/$ADMIN_IMAGE_NAME:$IMAGE_TAG\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Provisioning**: \`$STATE\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Running Status**: \`$STATUS\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ ã‚¢ã‚¯ã‚»ã‚¹" >> $GITHUB_STEP_SUMMARY
          echo "- https://$FQDN" >> $GITHUB_STEP_SUMMARY
          echo "- Basic èªè¨¼: $ACA_ADMIN_USERNAME / (GitHub Variables)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Gitleaksã‚¹ã‚­ãƒ£ãƒ³çµæžœ
          GITLEAKS_ISSUES="${{ needs.code-security-scans.outputs.gitleaks_issues }}"
          if [ "$GITLEAKS_ISSUES" = "0" ]; then
            echo "- **Gitleaks (ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œå‡º)**: âœ… æ¤œå‡ºãªã—" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Gitleaks (ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œå‡º)**: âš ï¸ $GITLEAKS_ISSUES ä»¶æ¤œå‡º" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Trivy FS ã‚¹ã‚­ãƒ£ãƒ³çµæžœ
          TRIVY_FS_CRITICAL="${{ needs.code-security-scans.outputs.trivy_fs_critical }}"
          TRIVY_FS_HIGH="${{ needs.code-security-scans.outputs.trivy_fs_high }}"
          if [ "$TRIVY_FS_CRITICAL" = "0" ] && [ "$TRIVY_FS_HIGH" = "0" ]; then
            echo "- **Trivy FS (ã‚½ãƒ¼ã‚¹/è¨­å®š)**: âœ… CRITICAL/HIGH æ¤œå‡ºãªã—" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Trivy FS (ã‚½ãƒ¼ã‚¹/è¨­å®š)**: âš ï¸ CRITICAL:$TRIVY_FS_CRITICAL / HIGH:$TRIVY_FS_HIGH" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Trivy Image ã‚¹ã‚­ãƒ£ãƒ³çµæžœ (Admin App)
          ADMIN_IMAGE_CRITICAL="${{ needs.build-and-push.outputs.admin_image_critical }}"
          ADMIN_IMAGE_HIGH="${{ needs.build-and-push.outputs.admin_image_high }}"
          if [ "$ADMIN_IMAGE_CRITICAL" = "0" ] && [ "$ADMIN_IMAGE_HIGH" = "0" ]; then
            echo "- **Trivy Image (Admin App)**: âœ… CRITICAL/HIGH æ¤œå‡ºãªã—" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Trivy Image (Admin App)**: âš ï¸ CRITICAL:$ADMIN_IMAGE_CRITICAL / HIGH:$ADMIN_IMAGE_HIGH" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è©³ç´°ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµæžœã¯ [Security ã‚¿ãƒ–](../../security/code-scanning) ã‚’å‚ç…§ã—ã¦ãã ã•ã„" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Managed Identity" >> $GITHUB_STEP_SUMMARY
          echo "- Principal ID: \`${SYSTEM_IDENTITY_PRINCIPAL_ID:-å–å¾—å¤±æ•—}\`" >> $GITHUB_STEP_SUMMARY
          echo "- ä»˜ä¸Žãƒ­ãƒ¼ãƒ«: Storage Blob Data Contributor (GitHub Actions ã§å†ªç­‰ä»˜ä¸Ž)" >> $GITHUB_STEP_SUMMARY

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# Azure ãƒªã‚½ãƒ¼ã‚¹ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ & è‡ªå‹•å¾©æ—§ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# ç›®çš„: çµ„ç¹”ã® Azure Policy ã«ã‚ˆã‚‹ AKS/VM è‡ªå‹•åœæ­¢ï¼ˆ24æ™‚é–“ï¼‰ã«å¯¾å¿œ
#       - AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®çŠ¶æ…‹ã‚’ç¢ºèªã—ã€åœæ­¢ã—ã¦ã„ã‚Œã°è‡ªå‹•èµ·å‹•
#       - MySQL VM ã®çŠ¶æ…‹ã‚’ç¢ºèªã—ã€åœæ­¢ã—ã¦ã„ã‚Œã°è‡ªå‹•èµ·å‹•
#       - Ingress Controller / Pod ã®æ­£å¸¸æ€§ç¢ºèª
#       - Board App / API ã®ç–é€šç¢ºèª
#
# å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°:
#   - æ‰‹å‹•å®Ÿè¡Œï¼ˆworkflow_dispatchï¼‰
#   - å®šæœŸå®Ÿè¡ŒãŒå¿…è¦ãªå ´åˆã¯ schedule ã‚’æœ‰åŠ¹åŒ–
#
# ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ:
#   - trouble_docs/2025-11-26-aks-24h-auto-stop-full-recovery.md
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
name: ğŸ”„ Azure Health Check & Recovery

on:
  # æ‰‹å‹•å®Ÿè¡Œã®ã¿ï¼ˆå®šæœŸå®Ÿè¡ŒãŒå¿…è¦ãªå ´åˆã¯ schedule ã‚’æœ‰åŠ¹åŒ–ï¼‰
  # schedule:
  #   - cron: "0 * * * *"  # æ¯æ™‚ 0 åˆ†
  workflow_dispatch:

permissions:
  contents: read
  id-token: write
  actions: write # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å‘¼ã³å‡ºã—ã«å¿…è¦

env:
  RESOURCE_GROUP_NAME: ${{ vars.RESOURCE_GROUP_NAME }}
  AKS_CLUSTER_NAME: ${{ vars.AKS_CLUSTER_NAME }}
  ACR_NAME_PREFIX: ${{ vars.ACR_NAME_PREFIX }}
  VM_NAME: ${{ vars.VM_NAME }}

jobs:
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Step 1: AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼çŠ¶æ…‹ç¢ºèª & è‡ªå‹•èµ·å‹•ï¼ˆä¸¦åˆ—å®Ÿè¡Œï¼‰
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  aks-check:
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.aks_check.outputs.status }}
      was_stopped: ${{ steps.aks_check.outputs.was_stopped }}
      node_resource_group: ${{ steps.aks_check.outputs.node_resource_group }}
    steps:
      - name: Azure ã« Service Principal ã§ãƒ­ã‚°ã‚¤ãƒ³
        uses: azure/login@v2
        with:
          creds: >-
            {"clientId":"${{ vars.AZURE_CLIENT_ID }}","tenantId":"${{ vars.AZURE_TENANT_ID }}","clientSecret":"${{ vars.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}"}

      - name: AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼çŠ¶æ…‹ã‚’ç¢ºèª
        id: aks_check
        run: |
          set -euo pipefail

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼çŠ¶æ…‹ç¢ºèª"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼: $AKS_CLUSTER_NAME"
          echo "ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—: $RESOURCE_GROUP_NAME"
          echo ""

          # AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®è©³ç´°æƒ…å ±ã‚’å–å¾—
          AKS_INFO=$(az aks show \
            --resource-group "$RESOURCE_GROUP_NAME" \
            --name "$AKS_CLUSTER_NAME" \
            --query '{
              provisioningState: provisioningState,
              powerState: powerState.code,
              fqdn: fqdn,
              kubernetesVersion: kubernetesVersion,
              nodeResourceGroup: nodeResourceGroup
            }' \
            -o json 2>/dev/null || echo '{"error": "not_found"}')

          if echo "$AKS_INFO" | jq -e '.error' >/dev/null 2>&1; then
            echo "âŒ AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "status=not_found" >> "$GITHUB_OUTPUT"
            echo "was_stopped=false" >> "$GITHUB_OUTPUT"
            exit 1
          fi

          POWER_STATE=$(echo "$AKS_INFO" | jq -r '.powerState')
          PROVISIONING_STATE=$(echo "$AKS_INFO" | jq -r '.provisioningState')
          NODE_RG=$(echo "$AKS_INFO" | jq -r '.nodeResourceGroup')

          echo "ğŸ“Š ç¾åœ¨ã®çŠ¶æ…‹:"
          echo "  - é›»æºçŠ¶æ…‹: $POWER_STATE"
          echo "  - ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°çŠ¶æ…‹: $PROVISIONING_STATE"
          echo "  - ãƒãƒ¼ãƒ‰ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—: $NODE_RG"
          echo ""

          echo "node_resource_group=$NODE_RG" >> "$GITHUB_OUTPUT"

          # åœæ­¢ã—ã¦ã„ã‚‹å ´åˆã¯è‡ªå‹•èµ·å‹•
          if [ "$POWER_STATE" = "Stopped" ]; then
            echo "âš ï¸ AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãŒåœæ­¢ã—ã¦ã„ã¾ã™ï¼ˆAzure Policy ã«ã‚ˆã‚‹è‡ªå‹•åœæ­¢ã®å¯èƒ½æ€§ï¼‰"
            echo "ğŸš€ ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’èµ·å‹•ã—ã¾ã™..."
            echo ""
            
            az aks start \
              --resource-group "$RESOURCE_GROUP_NAME" \
              --name "$AKS_CLUSTER_NAME"
            
            echo "âœ… èµ·å‹•ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œå®Œäº†"
            echo ""
            
            # èµ·å‹•å¾…æ©Ÿï¼ˆæœ€å¤§ 5 åˆ†ã€15ç§’é–“éš”ã§ãƒã‚§ãƒƒã‚¯ï¼‰
            echo "â³ ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼èµ·å‹•ã‚’å¾…æ©Ÿä¸­..."
            for i in {1..20}; do
              sleep 15
              NEW_STATE=$(az aks show \
                --resource-group "$RESOURCE_GROUP_NAME" \
                --name "$AKS_CLUSTER_NAME" \
                --query 'powerState.code' -o tsv 2>/dev/null || echo "Unknown")
              
              echo "[$i/20] é›»æºçŠ¶æ…‹: $NEW_STATE"
              
              if [ "$NEW_STATE" = "Running" ]; then
                echo "âœ… AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãŒèµ·å‹•ã—ã¾ã—ãŸ"
                break
              fi
            done
            
            # èµ·å‹•å¾Œã€DNS ä¼æ’­ã¨ Pod èµ·å‹•ã®ãŸã‚ã«è¿½åŠ å¾…æ©Ÿï¼ˆçŸ­ç¸®ç‰ˆï¼‰
            echo "â³ DNS ä¼æ’­ã¨ Pod èµ·å‹•ã‚’å¾…æ©Ÿä¸­ï¼ˆ30ç§’ï¼‰..."
            sleep 30
            
            echo "status=started" >> "$GITHUB_OUTPUT"
            echo "was_stopped=true" >> "$GITHUB_OUTPUT"
          elif [ "$POWER_STATE" = "Running" ]; then
            echo "âœ… AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã¯ç¨¼åƒä¸­ã§ã™"
            echo "status=running" >> "$GITHUB_OUTPUT"
            echo "was_stopped=false" >> "$GITHUB_OUTPUT"
          else
            echo "âš ï¸ äºˆæœŸã—ãªã„é›»æºçŠ¶æ…‹: $POWER_STATE"
            echo "status=$POWER_STATE" >> "$GITHUB_OUTPUT"
            echo "was_stopped=false" >> "$GITHUB_OUTPUT"
          fi

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Step 2: MySQL VM çŠ¶æ…‹ç¢ºèª & è‡ªå‹•èµ·å‹•ï¼ˆä¸¦åˆ—å®Ÿè¡Œï¼‰
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  vm-check:
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.vm_check.outputs.status }}
      was_stopped: ${{ steps.vm_check.outputs.was_stopped }}
    steps:
      - name: Azure ã« Service Principal ã§ãƒ­ã‚°ã‚¤ãƒ³
        uses: azure/login@v2
        with:
          creds: >-
            {"clientId":"${{ vars.AZURE_CLIENT_ID }}","tenantId":"${{ vars.AZURE_TENANT_ID }}","clientSecret":"${{ vars.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}"}

      - name: MySQL VM çŠ¶æ…‹ã‚’ç¢ºèª
        id: vm_check
        run: |
          set -euo pipefail

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” MySQL VM çŠ¶æ…‹ç¢ºèª"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "VM: $VM_NAME"
          echo "ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—: $RESOURCE_GROUP_NAME"
          echo ""

          # VM ã®è©³ç´°æƒ…å ±ã‚’å–å¾—
          VM_INFO=$(az vm get-instance-view \
            --resource-group "$RESOURCE_GROUP_NAME" \
            --name "$VM_NAME" \
            --query '{
              name: name,
              powerState: instanceView.statuses[?starts_with(code, `PowerState/`)].displayStatus | [0]
            }' \
            -o json 2>/dev/null || echo '{"error": "not_found"}')

          if echo "$VM_INFO" | jq -e '.error' >/dev/null 2>&1; then
            echo "âŒ VM ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "status=not_found" >> "$GITHUB_OUTPUT"
            echo "was_stopped=false" >> "$GITHUB_OUTPUT"
            exit 1
          fi

          POWER_STATE=$(echo "$VM_INFO" | jq -r '.powerState // "Unknown"')

          echo "ğŸ“Š ç¾åœ¨ã®çŠ¶æ…‹:"
          echo "  - é›»æºçŠ¶æ…‹: $POWER_STATE"
          echo ""

          # åœæ­¢/å‰²ã‚Šå½“ã¦è§£é™¤ã®å ´åˆã¯è‡ªå‹•èµ·å‹•
          if [ "$POWER_STATE" = "VM deallocated" ] || [ "$POWER_STATE" = "VM stopped" ]; then
            echo "âš ï¸ MySQL VM ãŒåœæ­¢ã—ã¦ã„ã¾ã™ï¼ˆAzure Policy ã«ã‚ˆã‚‹è‡ªå‹•åœæ­¢ã®å¯èƒ½æ€§ï¼‰"
            echo "ğŸš€ VM ã‚’èµ·å‹•ã—ã¾ã™..."
            echo ""

            az vm start \
              --resource-group "$RESOURCE_GROUP_NAME" \
              --name "$VM_NAME"

            echo "âœ… èµ·å‹•ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œå®Œäº†"
            echo ""

            # èµ·å‹•å¾…æ©Ÿï¼ˆæœ€å¤§ 2.5 åˆ†ã€15ç§’é–“éš”ã§ãƒã‚§ãƒƒã‚¯ï¼‰
            echo "â³ VM èµ·å‹•ã‚’å¾…æ©Ÿä¸­..."
            for i in {1..10}; do
              sleep 15
              NEW_STATE=$(az vm get-instance-view \
                --resource-group "$RESOURCE_GROUP_NAME" \
                --name "$VM_NAME" \
                --query 'instanceView.statuses[?starts_with(code, `PowerState/`)].displayStatus | [0]' \
                -o tsv 2>/dev/null || echo "Unknown")

              echo "[$i/10] é›»æºçŠ¶æ…‹: $NEW_STATE"

              if [ "$NEW_STATE" = "VM running" ]; then
                echo "âœ… VM ãŒèµ·å‹•ã—ã¾ã—ãŸ"
                break
              fi
            done

            # MySQL ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•ã®ãŸã‚ã«è¿½åŠ å¾…æ©Ÿï¼ˆçŸ­ç¸®ç‰ˆï¼‰
            echo "â³ MySQL ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•ã‚’å¾…æ©Ÿä¸­ï¼ˆ15ç§’ï¼‰..."
            sleep 15

            echo "status=started" >> "$GITHUB_OUTPUT"
            echo "was_stopped=true" >> "$GITHUB_OUTPUT"
          elif [ "$POWER_STATE" = "VM running" ]; then
            echo "âœ… MySQL VM ã¯ç¨¼åƒä¸­ã§ã™"
            echo "status=running" >> "$GITHUB_OUTPUT"
            echo "was_stopped=false" >> "$GITHUB_OUTPUT"
          else
            echo "âš ï¸ äºˆæœŸã—ãªã„é›»æºçŠ¶æ…‹: $POWER_STATE"
            echo "status=$POWER_STATE" >> "$GITHUB_OUTPUT"
            echo "was_stopped=false" >> "$GITHUB_OUTPUT"
          fi

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Step 3-6: Kubernetes & App ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆAKS/VM å®Œäº†å¾Œï¼‰
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  health-check:
    runs-on: ubuntu-latest
    needs: [aks-check, vm-check] # AKS ã¨ VM ãƒã‚§ãƒƒã‚¯å®Œäº†å¾Œã«å®Ÿè¡Œ
    outputs:
      aks_status: ${{ needs.aks-check.outputs.status }}
      aks_was_stopped: ${{ needs.aks-check.outputs.was_stopped }}
      vm_status: ${{ needs.vm-check.outputs.status }}
      vm_was_stopped: ${{ needs.vm-check.outputs.was_stopped }}
      ingress_healthy: ${{ steps.ingress_check.outputs.healthy }}
      app_healthy: ${{ steps.app_check.outputs.healthy }}
      lb_ip: ${{ steps.ingress_check.outputs.lb_ip }}
      needs_redeploy: ${{ steps.decision.outputs.needs_redeploy }}
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
        uses: actions/checkout@v4

      - name: Azure ã« Service Principal ã§ãƒ­ã‚°ã‚¤ãƒ³
        uses: azure/login@v2
        with:
          creds: >-
            {"clientId":"${{ vars.AZURE_CLIENT_ID }}","tenantId":"${{ vars.AZURE_TENANT_ID }}","clientSecret":"${{ vars.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}"}

      - name: AKS èªè¨¼æƒ…å ±ã‚’å–å¾—
        run: |
          az aks get-credentials \
            --resource-group "$RESOURCE_GROUP_NAME" \
            --name "$AKS_CLUSTER_NAME" \
            --overwrite-existing

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # Step 4: Ingress Controller çŠ¶æ…‹ç¢ºèª
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: Ingress Controller çŠ¶æ…‹ã‚’ç¢ºèª
        id: ingress_check
        run: |
          set -euo pipefail

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” Ingress Controller çŠ¶æ…‹ç¢ºèª"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Ingress Controller Pod ãŒ Ready ã«ãªã‚‹ã¾ã§å¾…æ©Ÿï¼ˆæœ€å¤§ 3 åˆ†ï¼‰
          echo "â³ Ingress Controller Pod ã® Ready çŠ¶æ…‹ã‚’å¾…æ©Ÿä¸­..."
          if kubectl wait --for=condition=Ready pod \
            -n ingress-nginx \
            -l app.kubernetes.io/component=controller \
            --timeout=180s 2>/dev/null; then
            echo "âœ… Ingress Controller Pod ãŒ Ready ã«ãªã‚Šã¾ã—ãŸ"
          else
            echo "âš ï¸ Ingress Controller Pod ã® Ready å¾…æ©ŸãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ"
          fi
          echo ""

          # Ingress Controller Pod ã®çŠ¶æ…‹ç¢ºèª
          CONTROLLER_PODS=$(kubectl get pods -n ingress-nginx -l app.kubernetes.io/component=controller -o json 2>/dev/null || echo '{"items":[]}')
          RUNNING_PODS=$(echo "$CONTROLLER_PODS" | jq '[.items[] | select(.status.phase == "Running")] | length')
          TOTAL_PODS=$(echo "$CONTROLLER_PODS" | jq '.items | length')

          echo "ğŸ“Š Ingress Controller Pod çŠ¶æ…‹:"
          echo "  - å®Ÿè¡Œä¸­: $RUNNING_PODS / $TOTAL_PODS"

          if [ "$RUNNING_PODS" = "0" ]; then
            echo "âš ï¸ Ingress Controller ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã›ã‚“"
            
            # Pod ã®è©³ç´°çŠ¶æ…‹ã‚’è¡¨ç¤º
            kubectl get pods -n ingress-nginx -o wide || true
            kubectl describe pods -n ingress-nginx -l app.kubernetes.io/component=controller || true
            
            echo "healthy=false" >> "$GITHUB_OUTPUT"
            echo "lb_ip=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # LoadBalancer Service ã®çŠ¶æ…‹ç¢ºèª
          LB_IP=$(kubectl get svc -n ingress-nginx ingress-nginx-controller \
            -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")

          echo ""
          echo "ğŸ“Š LoadBalancer çŠ¶æ…‹:"
          if [ -n "$LB_IP" ]; then
            echo "  - External IP: $LB_IP"
            echo "healthy=true" >> "$GITHUB_OUTPUT"
            echo "lb_ip=$LB_IP" >> "$GITHUB_OUTPUT"
          else
            echo "  - External IP: <pending>"
            echo "âš ï¸ LoadBalancer IP ãŒã¾ã å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã¾ã›ã‚“"
            
            # LoadBalancer IP å–å¾—ã‚’å¾…æ©Ÿï¼ˆæœ€å¤§ 2.5 åˆ†ã€15ç§’é–“éš”ï¼‰
            echo "â³ LoadBalancer IP å‰²ã‚Šå½“ã¦ã‚’å¾…æ©Ÿä¸­..."
            for i in {1..10}; do
              sleep 15
              LB_IP=$(kubectl get svc -n ingress-nginx ingress-nginx-controller \
                -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
              
              if [ -n "$LB_IP" ]; then
                echo "âœ… LoadBalancer IP å–å¾—: $LB_IP"
                echo "healthy=true" >> "$GITHUB_OUTPUT"
                echo "lb_ip=$LB_IP" >> "$GITHUB_OUTPUT"
                break
              fi
              echo "[$i/10] å¾…æ©Ÿä¸­..."
            done
            
            if [ -z "$LB_IP" ]; then
              echo "âŒ LoadBalancer IP ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ"
              echo "healthy=false" >> "$GITHUB_OUTPUT"
              echo "lb_ip=" >> "$GITHUB_OUTPUT"
            fi
          fi

          echo ""
          echo "ğŸ“‹ Service è©³ç´°:"
          kubectl get svc -n ingress-nginx

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # Step 4.5: Kubernetes Service externalTrafficPolicy ç¢ºèªãƒ»è£œæ­£
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: externalTrafficPolicy ã‚’ç¢ºèªãƒ»è£œæ­£
        id: traffic_policy_check
        run: |
          set -euo pipefail

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” Kubernetes Service externalTrafficPolicy ç¢ºèª"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“– externalTrafficPolicy ã®è§£èª¬:"
          echo "  - Cluster: SNAT ã‚ã‚Šã€ã©ã®ãƒãƒ¼ãƒ‰ã‹ã‚‰ã‚‚è¿”ã›ã‚‹ï¼ˆæ¨å¥¨ï¼‰"
          echo "  - Local: SNAT ãªã—ã€åŒä¸€ãƒãƒ¼ãƒ‰ã®ã¿ï¼ˆDSR å‹•ä½œã€æˆ»ã‚Šãƒ‘ã‚±ãƒƒãƒˆå•é¡Œã‚ã‚Šï¼‰"
          echo ""

          # Ingress Controller Service ã® externalTrafficPolicy ã‚’ç¢ºèª
          TRAFFIC_POLICY=$(kubectl get svc -n ingress-nginx ingress-nginx-controller \
            -o jsonpath='{.spec.externalTrafficPolicy}' 2>/dev/null || echo "unknown")

          echo "ğŸ“Š ç¾åœ¨ã® externalTrafficPolicy: $TRAFFIC_POLICY"

          if [ "$TRAFFIC_POLICY" = "Local" ]; then
            echo ""
            echo "âš ï¸ externalTrafficPolicy ãŒ 'Local' ã§ã™ï¼ˆDSR å‹•ä½œï¼‰"
            echo "   GitHub Actions ã‹ã‚‰ã®æˆ»ã‚Šãƒ‘ã‚±ãƒƒãƒˆãŒå±Šã‹ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
            echo ""
            echo "ğŸ”§ externalTrafficPolicy ã‚’ 'Cluster' ã«å¤‰æ›´ä¸­..."
            
            kubectl patch svc -n ingress-nginx ingress-nginx-controller \
              -p '{"spec":{"externalTrafficPolicy":"Cluster"}}'
            
            # healthCheckNodePort ã‚‚å‰Šé™¤ï¼ˆCluster ãƒ¢ãƒ¼ãƒ‰ã§ã¯ä¸è¦ã‹ã¤ã‚¨ãƒ©ãƒ¼ã®åŸå› ï¼‰
            # æ³¨æ„: healthCheckNodePort ã¯ Cluster ãƒ¢ãƒ¼ãƒ‰ã§ã¯è‡ªå‹•å‰Šé™¤ã•ã‚Œãªã„ãŸã‚ã€æ˜ç¤ºçš„ã«nullã«
            kubectl patch svc -n ingress-nginx ingress-nginx-controller \
              --type='json' \
              -p='[{"op": "remove", "path": "/spec/healthCheckNodePort"}]' 2>/dev/null || true
            
            echo "âœ… externalTrafficPolicy ã‚’ 'Cluster' ã«å¤‰æ›´ã—ã¾ã—ãŸ"
            echo ""
            echo "â³ è¨­å®šåæ˜ ã‚’å¾…æ©Ÿä¸­ï¼ˆ15ç§’ï¼‰..."
            sleep 15
            
            # å¤‰æ›´å¾Œã®çŠ¶æ…‹ã‚’ç¢ºèª
            NEW_POLICY=$(kubectl get svc -n ingress-nginx ingress-nginx-controller \
              -o jsonpath='{.spec.externalTrafficPolicy}' 2>/dev/null || echo "unknown")
            echo "ğŸ“Š å¤‰æ›´å¾Œã® externalTrafficPolicy: $NEW_POLICY"
            echo "policy_fixed=true" >> "$GITHUB_OUTPUT"
          elif [ "$TRAFFIC_POLICY" = "Cluster" ]; then
            echo "âœ… externalTrafficPolicy ã¯ 'Cluster' ã§ã™ï¼ˆæ­£å¸¸ï¼‰"
            echo "policy_fixed=false" >> "$GITHUB_OUTPUT"
          else
            echo "âš ï¸ externalTrafficPolicy ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ: $TRAFFIC_POLICY"
            echo "policy_fixed=false" >> "$GITHUB_OUTPUT"
          fi

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # Step 4.6: Azure Load Balancer DSR è¨­å®šç¢ºèªãƒ»è£œæ­£
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: Azure Load Balancer DSR è¨­å®šã‚’ç¢ºèªãƒ»è£œæ­£
        id: lb_dsr_check
        run: |
          set -euo pipefail

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” Azure Load Balancer DSR è¨­å®šç¢ºèª"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # ãƒãƒ¼ãƒ‰ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å–å¾—
          NODE_RG=$(az aks show \
            --resource-group "$RESOURCE_GROUP_NAME" \
            --name "$AKS_CLUSTER_NAME" \
            --query nodeResourceGroup -o tsv)

          echo "ãƒãƒ¼ãƒ‰ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—: $NODE_RG"

          # Load Balancer åã‚’å–å¾—
          LB_NAME=$(az network lb list --resource-group "$NODE_RG" --query "[0].name" -o tsv 2>/dev/null || echo "kubernetes")
          echo "Load Balancer: $LB_NAME"

          # HTTP/HTTPS ãƒ«ãƒ¼ãƒ«ã‚’å–å¾—
          LB_RULES=$(az network lb rule list --resource-group "$NODE_RG" --lb-name "$LB_NAME" \
            --query "[?frontendPort==\`80\` || frontendPort==\`443\`]" -o json 2>/dev/null || echo "[]")

          if [ -z "$LB_RULES" ] || [ "$LB_RULES" = "[]" ]; then
            echo "âš ï¸ LoadBalancer Rule ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "dsr_fixed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo ""
          echo "ğŸ“Š ç¾åœ¨ã® LoadBalancer Rule:"
          echo "$LB_RULES" | jq -r '.[] | "  - \(.name): FloatingIP=\(.enableFloatingIP), DisableOutboundSnat=\(.disableOutboundSnat)"'

          # DSR è¨­å®šã‚’ç¢ºèªãƒ»è£œæ­£
          FIXED_COUNT=0

          for rule in $(echo "$LB_RULES" | jq -r '.[] | @base64'); do
            _jq() {
              echo "$rule" | base64 --decode | jq -r "$1"
            }

            RULE_NAME=$(_jq '.name')
            DISABLE_OUTBOUND_SNAT=$(_jq '.disableOutboundSnat')
            ENABLE_FLOATING_IP=$(_jq '.enableFloatingIP')

            NEEDS_UPDATE=false
            UPDATE_ARGS=()

            # disableOutboundSnat=true ã®å ´åˆã¯ä¿®æ­£ï¼ˆGitHub Actions ã‹ã‚‰ã®å¿œç­”ãŒ DSR ã§ç ´æ£„ã•ã‚Œã‚‹ï¼‰
            if [ "$DISABLE_OUTBOUND_SNAT" = "true" ]; then
              echo ""
              echo "âš ï¸ $RULE_NAME ã¯ disableOutboundSnat=true ã§ã™ï¼ˆDSR æœ‰åŠ¹ï¼‰"
              UPDATE_ARGS+=(--disable-outbound-snat false)
              NEEDS_UPDATE=true
            fi

            # Floating IP (DSR) ãŒæœ‰åŠ¹ãªå ´åˆã¯ç„¡åŠ¹åŒ–
            if [ "$ENABLE_FLOATING_IP" = "true" ]; then
              echo "âš ï¸ $RULE_NAME ã¯ Floating IP (DSR) ãŒæœ‰åŠ¹ã§ã™"
              UPDATE_ARGS+=(--floating-ip false)
              NEEDS_UPDATE=true
            fi

            if [ "$NEEDS_UPDATE" = true ]; then
              echo "ğŸ”§ LoadBalancer Rule ã‚’ä¿®æ­£ä¸­: $RULE_NAME"
              az network lb rule update \
                --resource-group "$NODE_RG" \
                --lb-name "$LB_NAME" \
                --name "$RULE_NAME" \
                "${UPDATE_ARGS[@]}" \
                --output none
              echo "âœ… ä¿®æ­£å®Œäº†: $(printf '%s ' "${UPDATE_ARGS[@]}")"
              FIXED_COUNT=$((FIXED_COUNT + 1))
            fi
          done

          echo ""
          if [ "$FIXED_COUNT" -gt 0 ]; then
            echo "ğŸ”„ $FIXED_COUNT ä»¶ã® LB ãƒ«ãƒ¼ãƒ«ã‚’ä¿®æ­£ã—ã¾ã—ãŸ"
            echo "â³ è¨­å®šåæ˜ ã‚’å¾…æ©Ÿä¸­ï¼ˆ30ç§’ï¼‰..."
            sleep 30
            echo "dsr_fixed=true" >> "$GITHUB_OUTPUT"
          else
            echo "âœ… ã™ã¹ã¦ã® LB ãƒ«ãƒ¼ãƒ«ã¯æ­£å¸¸ãªè¨­å®šã§ã™ï¼ˆDSR ç„¡åŠ¹ï¼‰"
            echo "dsr_fixed=false" >> "$GITHUB_OUTPUT"
          fi

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # Step 4.6.1: Load Balancer BackendPort ç¢ºèªãƒ»è£œæ­£
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # å•é¡Œ: AKS èµ·å‹•å¾Œã« LB Rule ã® BackendPort ãŒ 80/443 ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹
      #       æœ¬æ¥ã¯ Ingress Controller ã® NodePort (ä¾‹: 32573/31489) ãŒå¿…è¦
      # å‚è€ƒ: trouble_docs/2025-11-26-aks-24h-auto-stop-full-recovery.md
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: Load Balancer BackendPort ã‚’ NodePort ã«ä¿®æ­£
        id: lb_backend_port_fix
        run: |
          set -euo pipefail

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” Load Balancer BackendPort ç¢ºèª"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“– èª¬æ˜:"
          echo "  AKS èµ·å‹•å¾Œã« LB Rule ã® BackendPort ãŒ 80/443 ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™"
          echo "  Ingress Controller ã¯ NodePort ã§å…¬é–‹ã•ã‚Œã‚‹ãŸã‚ã€BackendPort ã‚’ NodePort ã«åˆã‚ã›ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™"
          echo ""

          # ãƒãƒ¼ãƒ‰ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å–å¾—
          NODE_RG=$(az aks show \
            --resource-group "$RESOURCE_GROUP_NAME" \
            --name "$AKS_CLUSTER_NAME" \
            --query nodeResourceGroup -o tsv)

          echo "ãƒãƒ¼ãƒ‰ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—: $NODE_RG"

          # Load Balancer åã‚’å–å¾—
          LB_NAME=$(az network lb list --resource-group "$NODE_RG" --query "[0].name" -o tsv 2>/dev/null || echo "kubernetes")
          echo "Load Balancer: $LB_NAME"

          # Kubernetes ã‹ã‚‰å®Ÿéš›ã® NodePort ã‚’å–å¾—
          NODEPORT_HTTP=$(kubectl get svc -n ingress-nginx ingress-nginx-controller \
            -o jsonpath='{.spec.ports[?(@.port==80)].nodePort}' 2>/dev/null || echo "")
          NODEPORT_HTTPS=$(kubectl get svc -n ingress-nginx ingress-nginx-controller \
            -o jsonpath='{.spec.ports[?(@.port==443)].nodePort}' 2>/dev/null || echo "")

          if [ -z "$NODEPORT_HTTP" ] || [ -z "$NODEPORT_HTTPS" ]; then
            echo "âš ï¸ Ingress Controller ã® NodePort ãŒå–å¾—ã§ãã¾ã›ã‚“"
            echo "   Ingress Controller ãŒã¾ã èµ·å‹•ã—ã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
            echo "backend_port_fixed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo ""
          echo "ğŸ“Š Ingress Controller ã® NodePort:"
          echo "  - HTTP  (80)  â†’ NodePort: $NODEPORT_HTTP"
          echo "  - HTTPS (443) â†’ NodePort: $NODEPORT_HTTPS"
          echo ""

          # LB Rule ã‚’å–å¾—
          LB_RULES=$(az network lb rule list --resource-group "$NODE_RG" --lb-name "$LB_NAME" \
            --query "[?frontendPort==\`80\` || frontendPort==\`443\`].{name:name, frontendPort:frontendPort, backendPort:backendPort}" \
            -o json 2>/dev/null || echo "[]")

          if [ -z "$LB_RULES" ] || [ "$LB_RULES" = "[]" ]; then
            echo "âš ï¸ HTTP/HTTPS ã® LoadBalancer Rule ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "backend_port_fixed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "ğŸ“Š ç¾åœ¨ã® LoadBalancer Rule:"
          echo "$LB_RULES" | jq -r '.[] | "  - \(.name): FrontendPort=\(.frontendPort), BackendPort=\(.backendPort)"'
          echo ""

          # BackendPort ã®ä¿®æ­£ãŒå¿…è¦ã‹ãƒã‚§ãƒƒã‚¯
          FIXED_COUNT=0

          for rule in $(echo "$LB_RULES" | jq -r '.[] | @base64'); do
            _jq() {
              echo "$rule" | base64 --decode | jq -r "$1"
            }

            RULE_NAME=$(_jq '.name')
            FRONTEND_PORT=$(_jq '.frontendPort')
            BACKEND_PORT=$(_jq '.backendPort')

            # æœŸå¾…ã•ã‚Œã‚‹ NodePort ã‚’æ±ºå®š
            if [ "$FRONTEND_PORT" = "80" ]; then
              EXPECTED_BACKEND=$NODEPORT_HTTP
            elif [ "$FRONTEND_PORT" = "443" ]; then
              EXPECTED_BACKEND=$NODEPORT_HTTPS
            else
              continue
            fi

            # BackendPort ãŒæœŸå¾…å€¤ã¨ç•°ãªã‚‹å ´åˆã¯ä¿®æ­£
            if [ "$BACKEND_PORT" != "$EXPECTED_BACKEND" ]; then
              echo "âš ï¸ $RULE_NAME: BackendPort ãŒä¸æ­£ã§ã™"
              echo "   ç¾åœ¨: $BACKEND_PORT â†’ æœŸå¾…: $EXPECTED_BACKEND"
              echo "ğŸ”§ BackendPort ã‚’ä¿®æ­£ä¸­..."

              az network lb rule update \
                --resource-group "$NODE_RG" \
                --lb-name "$LB_NAME" \
                --name "$RULE_NAME" \
                --backend-port "$EXPECTED_BACKEND" \
                --output none

              echo "âœ… ä¿®æ­£å®Œäº†: BackendPort=$EXPECTED_BACKEND"
              FIXED_COUNT=$((FIXED_COUNT + 1))
            else
              echo "âœ… $RULE_NAME: BackendPort=$BACKEND_PORT (æ­£å¸¸)"
            fi
          done

          echo ""
          if [ "$FIXED_COUNT" -gt 0 ]; then
            echo "ğŸ”„ $FIXED_COUNT ä»¶ã® LB ãƒ«ãƒ¼ãƒ«ã® BackendPort ã‚’ä¿®æ­£ã—ã¾ã—ãŸ"
            echo "â³ è¨­å®šåæ˜ ã‚’å¾…æ©Ÿä¸­ï¼ˆ15ç§’ï¼‰..."
            sleep 15
            echo "backend_port_fixed=true" >> "$GITHUB_OUTPUT"
          else
            echo "âœ… ã™ã¹ã¦ã® LB ãƒ«ãƒ¼ãƒ«ã® BackendPort ã¯æ­£å¸¸ã§ã™"
            echo "backend_port_fixed=false" >> "$GITHUB_OUTPUT"
          fi

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # Step 4.7: ã‚µãƒ–ãƒãƒƒãƒˆ NSG ç¢ºèªãƒ»è£œæ­£
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: ã‚µãƒ–ãƒãƒƒãƒˆ NSG ã® HTTP/HTTPS è¨±å¯ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªãƒ»è£œæ­£
        id: subnet_nsg_check
        run: |
          set -euo pipefail

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” ã‚µãƒ–ãƒãƒƒãƒˆ NSG ç¢ºèª"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“– èª¬æ˜:"
          echo "  Azure NSG ã¯ NIC ãƒ¬ãƒ™ãƒ«ã¨ã‚µãƒ–ãƒãƒƒãƒˆãƒ¬ãƒ™ãƒ«ã®ä¸¡æ–¹ã‚’é€šéã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™"
          echo "  ã‚µãƒ–ãƒãƒƒãƒˆ NSG ã§ HTTP/HTTPS ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹ã¨å¤–éƒ¨ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“"
          echo ""

          # ã‚µãƒ–ãƒãƒƒãƒˆ ID ã‚’å–å¾—
          SUBNET_ID=$(az aks show \
            --resource-group "$RESOURCE_GROUP_NAME" \
            --name "$AKS_CLUSTER_NAME" \
            --query "agentPoolProfiles[0].vnetSubnetId" -o tsv 2>/dev/null || echo "")

          if [ -z "$SUBNET_ID" ]; then
            echo "âš ï¸ ã‚µãƒ–ãƒãƒƒãƒˆ ID ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ"
            echo "nsg_fixed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # ã‚µãƒ–ãƒãƒƒãƒˆæƒ…å ±ã‚’ãƒ‘ãƒ¼ã‚¹
          VNET_RG=$(echo "$SUBNET_ID" | cut -d'/' -f5)
          VNET_NAME=$(echo "$SUBNET_ID" | cut -d'/' -f9)
          SUBNET_NAME=$(echo "$SUBNET_ID" | cut -d'/' -f11)

          echo "VNet ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—: $VNET_RG"
          echo "VNet å: $VNET_NAME"
          echo "ã‚µãƒ–ãƒãƒƒãƒˆå: $SUBNET_NAME"

          # ã‚µãƒ–ãƒãƒƒãƒˆã«é–¢é€£ä»˜ã‘ã‚‰ã‚ŒãŸ NSG ã‚’å–å¾—
          SUBNET_NSG_ID=$(az network vnet subnet show \
            --resource-group "$VNET_RG" \
            --vnet-name "$VNET_NAME" \
            --name "$SUBNET_NAME" \
            --query "networkSecurityGroup.id" -o tsv 2>/dev/null || echo "")

          if [ -z "$SUBNET_NSG_ID" ] || [ "$SUBNET_NSG_ID" = "null" ]; then
            echo "âœ… ã‚µãƒ–ãƒãƒƒãƒˆã« NSG ãŒé–¢é€£ä»˜ã‘ã‚‰ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆè¨±å¯ä¸è¦ï¼‰"
            echo "nsg_fixed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          NSG_RG=$(echo "$SUBNET_NSG_ID" | cut -d'/' -f5)
          NSG_NAME=$(echo "$SUBNET_NSG_ID" | cut -d'/' -f9)

          echo "ã‚µãƒ–ãƒãƒƒãƒˆ NSG: $NSG_NAME (RG: $NSG_RG)"
          echo ""

          # ç¾åœ¨ã®ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèª
          echo "ğŸ“Š ç¾åœ¨ã®ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰ãƒ«ãƒ¼ãƒ«:"
          RULES=$(az network nsg rule list \
            --resource-group "$NSG_RG" \
            --nsg-name "$NSG_NAME" \
            --query "[?direction=='Inbound'].{name:name, priority:priority, access:access, destinationPortRange:destinationPortRange}" \
            -o json 2>/dev/null || echo "[]")

          echo "$RULES" | jq -r '.[] | "  - \(.name): Priority=\(.priority), Access=\(.access), Port=\(.destinationPortRange)"'

          # HTTP (80) è¨±å¯ãƒ«ãƒ¼ãƒ«ã®ç¢ºèª
          HTTP_RULE=$(echo "$RULES" | jq -r '[.[] | select(.destinationPortRange=="80" and .access=="Allow")] | length')
          HTTPS_RULE=$(echo "$RULES" | jq -r '[.[] | select(.destinationPortRange=="443" and .access=="Allow")] | length')
          NODEPORT_RULE=$(echo "$RULES" | jq -r '[.[] | select(.destinationPortRange=="30000-32767" and .access=="Allow")] | length')

          FIXED_COUNT=0

          # HTTP ãƒ«ãƒ¼ãƒ«ãŒãªã‘ã‚Œã°è¿½åŠ 
          if [ "$HTTP_RULE" = "0" ]; then
            echo ""
            echo "âš ï¸ HTTP (80) è¨±å¯ãƒ«ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“"
            echo "ğŸ”§ HTTP è¨±å¯ãƒ«ãƒ¼ãƒ«ã‚’è¿½åŠ ä¸­..."
            az network nsg rule create \
              --resource-group "$NSG_RG" \
              --nsg-name "$NSG_NAME" \
              --name "Allow-HTTP-Inbound" \
              --priority 100 \
              --direction Inbound \
              --access Allow \
              --protocol Tcp \
              --source-address-prefixes "*" \
              --source-port-ranges "*" \
              --destination-address-prefixes "*" \
              --destination-port-ranges 80 \
              --output none
            echo "âœ… HTTP è¨±å¯ãƒ«ãƒ¼ãƒ«è¿½åŠ å®Œäº†"
            FIXED_COUNT=$((FIXED_COUNT + 1))
          fi

          # HTTPS ãƒ«ãƒ¼ãƒ«ãŒãªã‘ã‚Œã°è¿½åŠ 
          if [ "$HTTPS_RULE" = "0" ]; then
            echo ""
            echo "âš ï¸ HTTPS (443) è¨±å¯ãƒ«ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“"
            echo "ğŸ”§ HTTPS è¨±å¯ãƒ«ãƒ¼ãƒ«ã‚’è¿½åŠ ä¸­..."
            az network nsg rule create \
              --resource-group "$NSG_RG" \
              --nsg-name "$NSG_NAME" \
              --name "Allow-HTTPS-Inbound" \
              --priority 110 \
              --direction Inbound \
              --access Allow \
              --protocol Tcp \
              --source-address-prefixes "*" \
              --source-port-ranges "*" \
              --destination-address-prefixes "*" \
              --destination-port-ranges 443 \
              --output none
            echo "âœ… HTTPS è¨±å¯ãƒ«ãƒ¼ãƒ«è¿½åŠ å®Œäº†"
            FIXED_COUNT=$((FIXED_COUNT + 1))
          fi

          # NodePort ãƒ«ãƒ¼ãƒ«ãŒãªã‘ã‚Œã°è¿½åŠ 
          if [ "$NODEPORT_RULE" = "0" ]; then
            echo ""
            echo "âš ï¸ NodePort (30000-32767) è¨±å¯ãƒ«ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“"
            echo "ğŸ”§ NodePort è¨±å¯ãƒ«ãƒ¼ãƒ«ã‚’è¿½åŠ ä¸­..."
            az network nsg rule create \
              --resource-group "$NSG_RG" \
              --nsg-name "$NSG_NAME" \
              --name "Allow-NodePort-Inbound" \
              --priority 120 \
              --direction Inbound \
              --access Allow \
              --protocol Tcp \
              --source-address-prefixes "*" \
              --source-port-ranges "*" \
              --destination-address-prefixes "*" \
              --destination-port-ranges "30000-32767" \
              --output none
            echo "âœ… NodePort è¨±å¯ãƒ«ãƒ¼ãƒ«è¿½åŠ å®Œäº†"
            FIXED_COUNT=$((FIXED_COUNT + 1))
          fi

          echo ""
          if [ "$FIXED_COUNT" -gt 0 ]; then
            echo "ğŸ”„ $FIXED_COUNT ä»¶ã® NSG ãƒ«ãƒ¼ãƒ«ã‚’è¿½åŠ ã—ã¾ã—ãŸ"
            echo "â³ è¨­å®šåæ˜ ã‚’å¾…æ©Ÿä¸­ï¼ˆ15ç§’ï¼‰..."
            sleep 15
            echo "nsg_fixed=true" >> "$GITHUB_OUTPUT"
          else
            echo "âœ… ã‚µãƒ–ãƒãƒƒãƒˆ NSG ã®è¨­å®šã¯æ­£å¸¸ã§ã™"
            echo "nsg_fixed=false" >> "$GITHUB_OUTPUT"
          fi

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # Step 5: Board App çŠ¶æ…‹ç¢ºèª
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: Board App çŠ¶æ…‹ã‚’ç¢ºèª
        id: app_check
        env:
          LB_IP: ${{ steps.ingress_check.outputs.lb_ip }}
        run: |
          set -euo pipefail

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” Board App çŠ¶æ…‹ç¢ºèª"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          BOARD_NS="board-app"
          HEALTHY=true

          # Pod çŠ¶æ…‹ç¢ºèª
          echo "ğŸ“Š Pod çŠ¶æ…‹:"
          APP_PODS=$(kubectl get pods -n "$BOARD_NS" -l app=board-app -o json 2>/dev/null || echo '{"items":[]}')
          API_PODS=$(kubectl get pods -n "$BOARD_NS" -l app=board-api -o json 2>/dev/null || echo '{"items":[]}')

          APP_RUNNING=$(echo "$APP_PODS" | jq '[.items[] | select(.status.phase == "Running")] | length')
          API_RUNNING=$(echo "$API_PODS" | jq '[.items[] | select(.status.phase == "Running")] | length')

          echo "  - board-app: $APP_RUNNING å€‹ã® Pod ãŒ Running"
          echo "  - board-api: $API_RUNNING å€‹ã® Pod ãŒ Running"

          if [ "$APP_RUNNING" = "0" ]; then
            echo "âš ï¸ board-app Pod ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã›ã‚“"
            HEALTHY=false
          fi

          if [ "$API_RUNNING" = "0" ]; then
            echo "âš ï¸ board-api Pod ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã›ã‚“"
            HEALTHY=false
          fi

          # å¤–éƒ¨ç–é€šç¢ºèªï¼ˆLoadBalancer IP ãŒã‚ã‚‹å ´åˆï¼‰
          if [ -n "$LB_IP" ]; then
            echo ""
            echo "ğŸ“Š å¤–éƒ¨ç–é€šç¢ºèª:"
            
            # HTML ãƒšãƒ¼ã‚¸ç¢ºèª
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 10 "http://$LB_IP/" 2>/dev/null || echo "000")
            echo "  - HTML ãƒšãƒ¼ã‚¸: HTTP $HTTP_STATUS"
            
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "  âœ… HTML é…ä¿¡æˆåŠŸ"
            else
              echo "  âš ï¸ HTML é…ä¿¡å¤±æ•—"
              HEALTHY=false
            fi
            
            # API ç¢ºèª
            API_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 10 "http://$LB_IP/api/posts" 2>/dev/null || echo "000")
            echo "  - API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: HTTP $API_STATUS"
            
            if [ "$API_STATUS" = "200" ] || [ "$API_STATUS" = "304" ]; then
              echo "  âœ… API ç–é€šæˆåŠŸ"
            else
              echo "  âš ï¸ API ç–é€šå¤±æ•—"
              HEALTHY=false
            fi
          else
            echo "âš ï¸ LoadBalancer IP ãŒå–å¾—ã§ãã¦ã„ãªã„ãŸã‚å¤–éƒ¨ç–é€šç¢ºèªã‚’ã‚¹ã‚­ãƒƒãƒ—"
            HEALTHY=false
          fi

          echo ""
          if [ "$HEALTHY" = "true" ]; then
            echo "âœ… Board App ã¯æ­£å¸¸ã§ã™"
            echo "healthy=true" >> "$GITHUB_OUTPUT"
          else
            echo "âš ï¸ Board App ã«å•é¡ŒãŒã‚ã‚Šã¾ã™"
            echo "healthy=false" >> "$GITHUB_OUTPUT"
            
            # ãƒ‡ãƒãƒƒã‚°æƒ…å ±
            echo ""
            echo "ğŸ“‹ ãƒ‡ãƒãƒƒã‚°æƒ…å ±:"
            kubectl get pods -n "$BOARD_NS" -o wide || true
            kubectl get svc -n "$BOARD_NS" || true
            kubectl get ingress -n "$BOARD_NS" || true
          fi

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # Step 6: å†ãƒ‡ãƒ—ãƒ­ã‚¤åˆ¤å®š
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: å†ãƒ‡ãƒ—ãƒ­ã‚¤è¦å¦ã‚’åˆ¤å®š
        id: decision
        env:
          AKS_WAS_STOPPED: ${{ needs.aks-check.outputs.was_stopped }}
          VM_WAS_STOPPED: ${{ needs.vm-check.outputs.was_stopped }}
          INGRESS_HEALTHY: ${{ steps.ingress_check.outputs.healthy }}
          APP_HEALTHY: ${{ steps.app_check.outputs.healthy }}
        run: |
          set -euo pipefail

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯çµæœã‚µãƒãƒª"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "AKS åœæ­¢ã‹ã‚‰ã®å¾©æ—§: $AKS_WAS_STOPPED"
          echo "VM åœæ­¢ã‹ã‚‰ã®å¾©æ—§: $VM_WAS_STOPPED"
          echo "Ingress æ­£å¸¸: $INGRESS_HEALTHY"
          echo "App æ­£å¸¸: $APP_HEALTHY"
          echo ""

          NEEDS_REDEPLOY=false
          NEEDS_POD_RESTART=false

          # AKS åœæ­¢ã‹ã‚‰å¾©æ—§ã—ãŸå ´åˆã¯å¸¸ã«å†ãƒ‡ãƒ—ãƒ­ã‚¤
          if [ "$AKS_WAS_STOPPED" = "true" ]; then
            echo "ğŸ”„ AKS åœæ­¢ã‹ã‚‰å¾©æ—§ã—ãŸãŸã‚å†ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’æ¨å¥¨"
            NEEDS_REDEPLOY=true
          # VM åœæ­¢ã‹ã‚‰å¾©æ—§ã—ãŸå ´åˆã¯ Pod å†èµ·å‹•ãŒå¿…è¦
          elif [ "$VM_WAS_STOPPED" = "true" ]; then
            echo "ğŸ”„ MySQL VM åœæ­¢ã‹ã‚‰å¾©æ—§ã—ãŸãŸã‚ board-api Pod ã®å†èµ·å‹•ã‚’æ¨å¥¨"
            NEEDS_POD_RESTART=true
          # Ingress ã¾ãŸã¯ App ã«å•é¡ŒãŒã‚ã‚‹å ´åˆ
          elif [ "$INGRESS_HEALTHY" = "false" ] || [ "${APP_HEALTHY:-true}" = "false" ]; then
            echo "ğŸ”„ ã‚µãƒ¼ãƒ“ã‚¹ã«å•é¡ŒãŒã‚ã‚‹ãŸã‚å†ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’æ¨å¥¨"
            NEEDS_REDEPLOY=true
          else
            echo "âœ… ã™ã¹ã¦æ­£å¸¸ã§ã™ã€‚å†ãƒ‡ãƒ—ãƒ­ã‚¤ã¯ä¸è¦ã§ã™"
          fi

          echo "needs_redeploy=$NEEDS_REDEPLOY" >> "$GITHUB_OUTPUT"
          echo "needs_pod_restart=$NEEDS_POD_RESTART" >> "$GITHUB_OUTPUT"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # Step 7: VM å¾©æ—§æ™‚ã® Pod å†èµ·å‹•
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: board-api Pod ã‚’å†èµ·å‹•ï¼ˆVM å¾©æ—§æ™‚ï¼‰
        if: needs.vm-check.outputs.was_stopped == 'true'
        run: |
          set -euo pipefail

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”„ board-api Pod ã‚’å†èµ·å‹•"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "MySQL VM ãŒåœæ­¢ã‹ã‚‰å¾©æ—§ã—ãŸãŸã‚ã€board-api Pod ã‚’å†èµ·å‹•ã—ã¾ã™"
          echo ""

          # board-api Pod ã‚’å‰Šé™¤ï¼ˆDeployment ãŒè‡ªå‹•ã§å†ä½œæˆï¼‰
          kubectl delete pod -n board-app -l app=board-api --wait=false || true

          echo "â³ Pod å†èµ·å‹•ã‚’å¾…æ©Ÿä¸­ï¼ˆ30ç§’ï¼‰..."
          sleep 30

          # æ–°ã—ã„ Pod ã®çŠ¶æ…‹ç¢ºèª
          echo "ğŸ“Š å†èµ·å‹•å¾Œã® Pod çŠ¶æ…‹:"
          kubectl get pods -n board-app -o wide

          # API ç–é€šç¢ºèª
          echo ""
          echo "ğŸ“Š API ç–é€šç¢ºèª:"
          API_POD=$(kubectl get pods -n board-app -l app=board-api -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
          if [ -n "$API_POD" ]; then
            POD_STATUS=$(kubectl get pod -n board-app "$API_POD" -o jsonpath='{.status.phase}' 2>/dev/null || echo "Unknown")
            echo "  - Pod: $API_POD"
            echo "  - çŠ¶æ…‹: $POD_STATUS"
            
            if [ "$POD_STATUS" = "Running" ]; then
              echo "  âœ… board-api Pod ãŒæ­£å¸¸ã«å†èµ·å‹•ã—ã¾ã—ãŸ"
            else
              echo "  âš ï¸ Pod ãŒã¾ã èµ·å‹•ä¸­ã§ã™ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰ç¢ºèªã—ã¦ãã ã•ã„"
            fi
          else
            echo "  âš ï¸ board-api Pod ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # Step 8: ã‚µãƒãƒªå‡ºåŠ›
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯çµæœã‚’ã‚µãƒãƒªã«å‡ºåŠ›
        if: always()
        env:
          AKS_STATUS: ${{ needs.aks-check.outputs.status }}
          AKS_WAS_STOPPED: ${{ needs.aks-check.outputs.was_stopped }}
          VM_STATUS: ${{ needs.vm-check.outputs.status }}
          VM_WAS_STOPPED: ${{ needs.vm-check.outputs.was_stopped }}
          INGRESS_HEALTHY: ${{ steps.ingress_check.outputs.healthy }}
          APP_HEALTHY: ${{ steps.app_check.outputs.healthy }}
          LB_IP: ${{ steps.ingress_check.outputs.lb_ip }}
          NEEDS_REDEPLOY: ${{ steps.decision.outputs.needs_redeploy }}
        run: |
          {
            echo "## ğŸ”„ Azure ãƒªã‚½ãƒ¼ã‚¹ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯çµæœ"
            echo ""
            echo "| é …ç›® | çŠ¶æ…‹ |"
            echo "|------|------|"
            
            # AKS çŠ¶æ…‹
            if [ "$AKS_WAS_STOPPED" = "true" ]; then
              echo "| AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ | ğŸ”„ åœæ­¢â†’èµ·å‹• |"
            elif [ "$AKS_STATUS" = "running" ]; then
              echo "| AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ | âœ… ç¨¼åƒä¸­ |"
            else
              echo "| AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ | âš ï¸ $AKS_STATUS |"
            fi
            
            # VM çŠ¶æ…‹
            if [ "$VM_WAS_STOPPED" = "true" ]; then
              echo "| MySQL VM | ğŸ”„ åœæ­¢â†’èµ·å‹• |"
            elif [ "$VM_STATUS" = "running" ]; then
              echo "| MySQL VM | âœ… ç¨¼åƒä¸­ |"
            else
              echo "| MySQL VM | âš ï¸ $VM_STATUS |"
            fi
            
            # Ingress çŠ¶æ…‹
            if [ "$INGRESS_HEALTHY" = "true" ]; then
              echo "| Ingress Controller | âœ… æ­£å¸¸ |"
            else
              echo "| Ingress Controller | âŒ ç•°å¸¸ |"
            fi
            
            # App çŠ¶æ…‹
            if [ "${APP_HEALTHY:-unknown}" = "true" ]; then
              echo "| Board App | âœ… æ­£å¸¸ |"
            elif [ "${APP_HEALTHY:-unknown}" = "false" ]; then
              echo "| Board App | âŒ ç•°å¸¸ |"
            else
              echo "| Board App | â­ï¸ ã‚¹ã‚­ãƒƒãƒ— |"
            fi
            
            # LoadBalancer IP
            if [ -n "$LB_IP" ]; then
              echo "| LoadBalancer IP | \`$LB_IP\` |"
            else
              echo "| LoadBalancer IP | âš ï¸ æœªå‰²å½“ |"
            fi
            
            echo ""
            
            # VM å¾©æ—§æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            if [ "$VM_WAS_STOPPED" = "true" ]; then
              echo "### ğŸ”„ MySQL VM å¾©æ—§å®Œäº†"
              echo ""
              echo "MySQL VM ãŒåœæ­¢ã‹ã‚‰å¾©æ—§ã—ãŸãŸã‚ã€board-api Pod ã‚’è‡ªå‹•å†èµ·å‹•ã—ã¾ã—ãŸã€‚"
              echo ""
            fi
            
            # å†ãƒ‡ãƒ—ãƒ­ã‚¤åˆ¤å®š
            if [ "$NEEDS_REDEPLOY" = "true" ]; then
              echo "### ğŸ”„ è‡ªå‹•å†ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œä¸­"
              echo ""
              echo "AKS/VM ã®å¾©æ—§ã‚’æ¤œçŸ¥ã—ãŸãŸã‚ã€**Board App ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’è‡ªå‹•ãƒˆãƒªã‚¬ãƒ¼**ã—ã¾ã—ãŸã€‚"
              echo ""
              echo "- ğŸ“‹ ãƒ‡ãƒ—ãƒ­ã‚¤çŠ¶æ³ã¯ [Actions](https://github.com/${{ github.repository }}/actions/workflows/2-board-app-build-deploy.yml) ã§ç¢ºèªã§ãã¾ã™"
              echo "- â±ï¸ å®Œäº†ã¾ã§ 10ã€œ15 åˆ†ç¨‹åº¦ã‹ã‹ã‚Šã¾ã™"
            else
              echo "### âœ… ã™ã¹ã¦æ­£å¸¸"
              echo ""
              if [ -n "$LB_IP" ]; then
                echo "- ğŸŒ ã‚¢ãƒ—ãƒª URL: http://$LB_IP"
                echo "- ğŸ” ãƒ€ãƒŸãƒ¼ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ: http://$LB_IP/dummy-secret.txt"
              fi
            fi
            
            echo ""
            echo "---"
            echo "_å®Ÿè¡Œæ™‚åˆ»: $(date -u '+%Y-%m-%d %H:%M:%S UTC')_"
          } >> "$GITHUB_STEP_SUMMARY"

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # è‡ªå‹•å†ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆå•é¡Œæ¤œå‡ºæ™‚ã«è‡ªå‹•å®Ÿè¡Œï¼‰
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  auto-redeploy:
    runs-on: ubuntu-latest
    needs: health-check
    if: needs.health-check.outputs.needs_redeploy == 'true'
    steps:
      - name: Board App ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å‘¼ã³å‡ºã—
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log('ğŸ”„ Board App å†ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹ã—ã¾ã™...');

            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: '2-board-app-build-deploy.yml',
              ref: 'master',
              inputs: {
                // æœ€æ–°ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ç”¨ï¼ˆãƒ“ãƒ«ãƒ‰ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰
                // ç©ºã®å ´åˆã¯æœ€æ–°ã‚³ãƒŸãƒƒãƒˆã‚’ãƒ“ãƒ«ãƒ‰
              }
            });

            console.log('âœ… Board App ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’èµ·å‹•ã—ã¾ã—ãŸ');

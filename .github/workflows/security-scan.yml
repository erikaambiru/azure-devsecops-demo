name: ğŸ” Security Scan (CodeQL + Trivy + Gitleaks)

on:
  push:
    branches: [master]
    paths:
      - "app/board-app/**"
      - "app/admin-app/**"
      - "infra/**"
      - ".github/workflows/security-scan.yml"
  pull_request:
    branches: [master]
    paths:
      - "app/board-app/**"
      - "app/admin-app/**"
      - "infra/**"
      - ".github/workflows/security-scan.yml"
  schedule:
    - cron: "0 3 * * *" # æ¯æ—¥ 03:00 UTC (JST åˆå‰ 12æ™‚) å®šæœŸã‚¹ã‚­ãƒ£ãƒ³
  workflow_dispatch:

permissions:
  # CodeQL ã¨ SARIF ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§å¿…è¦ãªæœ€ä½æ¨©é™
  contents: read
  actions: read # CodeQL ãŒãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œæƒ…å ±å–å¾—æ™‚ã« "Resource not accessible by integration" ã‚’é¿ã‘ã‚‹ãŸã‚è¿½åŠ 
  security-events: write

env:
  CODEQL_LANGUAGES: "javascript,python"

jobs:
  # ä¸¦åˆ—å®Ÿè¡Œã‚°ãƒ«ãƒ¼ãƒ—1: CodeQL (ã‚³ãƒ¼ãƒ‰è§£æ)
  codeql:
    name: CodeQL (JS+Python)
    runs-on: ubuntu-latest
    steps:
      - name: ã‚³ãƒ¼ãƒ‰å–å¾—
        uses: actions/checkout@v4

      - name: CodeQL åˆæœŸåŒ–
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ env.CODEQL_LANGUAGES }}
          queries: security-extended # è¿½åŠ ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ‹¡å¼µã‚¯ã‚¨ãƒª

      - name: è‡ªå‹•ãƒ“ãƒ«ãƒ‰
        uses: github/codeql-action/autobuild@v4

      - name: CodeQL è§£æ
        uses: github/codeql-action/analyze@v4
        continue-on-error: true # Code scanning æœªæœ‰åŠ¹æ™‚ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—ã‚’è¨±å®¹
        with:
          category: "codeql"

      - name: CodeQL SARIF ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆåé›†
        # analyze å®Ÿè¡Œå¾Œã«ç”Ÿæˆã•ã‚ŒãŸ SARIF ã‚’æ¢ç´¢ã—ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆåŒ–
        # ç›®çš„: ä¸Šä½æ¤œå‡ºæŠ½å‡ºå‡¦ç†ã§ CodeQL ã®å€‹åˆ¥çµæœã‚‚çµ±åˆã™ã‚‹ãŸã‚
        run: |
          set -euo pipefail
          mkdir -p codeql-sarif
          # CodeQL ã® SARIF ã¯ ../results/ ã‚„ _temp/ ã«ç”Ÿæˆã•ã‚Œã‚‹ãŸã‚åºƒç¯„å›²ã‚’æ¢ç´¢
          find /home/runner/work -type f -name '*.sarif' 2>/dev/null | while read sarif; do
            echo "ç™ºè¦‹: $sarif"
            cp "$sarif" codeql-sarif/ || true
          done
          echo "åé›†æ¸ˆã¿SARIF:" && ls -1 codeql-sarif || echo "âš ï¸ SARIF ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"

      - name: CodeQL SARIF ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: codeql-sarif
          path: codeql-sarif/*.sarif
          if-no-files-found: warn

  # ä¸¦åˆ—å®Ÿè¡Œã‚°ãƒ«ãƒ¼ãƒ—2: Gitleaks (ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œå‡º)
  gitleaks-scan:
    name: Gitleaks (ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œå‡º)
    runs-on: ubuntu-latest
    steps:
      - name: ã‚³ãƒ¼ãƒ‰å–å¾—
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # å…¨å±¥æ­´ã‚’å–å¾—

      - name: Gitleaks ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¾©å…ƒ
        uses: actions/cache@v4
        with:
          path: ~/.cache/gitleaks
          key: gitleaks-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            gitleaks-${{ runner.os }}-

      - name: Gitleaks ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          set -euo pipefail
          VERSION="8.18.4"
          curl -sSL "https://github.com/gitleaks/gitleaks/releases/download/v${VERSION}/gitleaks_${VERSION}_linux_x64.tar.gz" -o gitleaks.tgz
          tar -xzf gitleaks.tgz gitleaks
          sudo install -m 755 gitleaks /usr/local/bin/gitleaks
          gitleaks version

      - name: Gitleaks ã§ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œå‡º (å…¨ãƒªãƒã‚¸ãƒˆãƒª)
        continue-on-error: true
        run: |
          set +e
          gitleaks detect --no-banner --report-format sarif --report-path gitleaks-repo.sarif
          EXIT_CODE=$?
          if [ $EXIT_CODE -ne 0 ]; then
            echo "âš ï¸ ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œå‡ºã‚ã‚Šï¼ˆè­¦å‘Šï¼‰- Security ã‚¿ãƒ–ã§ç¢ºèªã—ã¦ãã ã•ã„"
          fi
          exit 0

      - name: Gitleaks SARIF ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: github.actor != 'dependabot[bot]'
        uses: github/codeql-action/upload-sarif@v4
        continue-on-error: true
        with:
          sarif_file: gitleaks-repo.sarif
          category: gitleaks

      - name: Gitleaks SARIF ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-sarif
          path: gitleaks-repo.sarif
          if-no-files-found: warn

  # ä¸¦åˆ—å®Ÿè¡Œã‚°ãƒ«ãƒ¼ãƒ—2-B: GitGuardian (ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œå‡ºãƒ»å¼·åŒ–ç‰ˆ)
  gitguardian-scan:
    name: GitGuardian (ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œå‡º)
    runs-on: ubuntu-latest
    outputs:
      gitguardian_issues: ${{ steps.count_issues.outputs.issues }}
      has_key: ${{ steps.check-api-key.outputs.has_key }}
      scan_error: ${{ steps.gg_scan.outputs.scan_error }}
    steps:
      - name: ã‚³ãƒ¼ãƒ‰å–å¾—
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # å…¨å±¥æ­´ã‚’å–å¾—

      - name: GitGuardian API ã‚­ãƒ¼ç¢ºèª
        id: check-api-key
        run: |
          if [ -z "${{ vars.GITGUARDIAN_API_KEY }}" ]; then
            echo "âš ï¸ GitGuardian API ã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆã‚¹ã‚­ãƒ£ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰"
            echo "è¨­å®šæ–¹æ³•:"
            echo "1. https://dashboard.gitguardian.com/api/personal-access-tokens ã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆ"
            echo "2. Settings â†’ Variables â†’ New repository variable"
            echo "3. Name: GITGUARDIAN_API_KEY, Value: <ç”Ÿæˆã—ãŸãƒˆãƒ¼ã‚¯ãƒ³>"
            echo "has_key=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… GitGuardian API ã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™"
            echo "has_key=true" >> $GITHUB_OUTPUT
          fi

      - name: GitGuardian ã‚¹ã‚­ãƒ£ãƒ³
        id: gg_scan
        if: steps.check-api-key.outputs.has_key == 'true'
        continue-on-error: true
        run: |
          set +e
          # ggshield ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          pip install --quiet ggshield

          # JSON å½¢å¼ã§ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œã¨ã‚¨ãƒ©ãƒ¼æ•æ‰
          SCAN_OUTPUT=$(ggshield secret scan repo . --json --output gitguardian-results.json 2>&1)
          SCAN_EXIT_CODE=$?

          # ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒã‚§ãƒƒã‚¯
          if echo "$SCAN_OUTPUT" | grep -q "Token is missing the required scope"; then
            echo "::error::âŒ GitGuardian API Key ã« 'scan' ã‚¹ã‚³ãƒ¼ãƒ—ãŒä¸è¶³ã—ã¦ã„ã¾ã™"
            echo ""
            echo "ğŸ“‹ è§£æ±ºæ‰‹é †:"
            echo "1. https://dashboard.gitguardian.com/api/personal-access-tokens ã«ã‚¢ã‚¯ã‚»ã‚¹"
            echo "2. æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½œæˆã—ã€ä»¥ä¸‹ã®ã‚¹ã‚³ãƒ¼ãƒ—ã‚’é¸æŠ:"
            echo "   âœ… scan (å¿…é ˆ)"
            echo "   âœ… incident:read"
            echo "   âœ… incident:write"
            echo "3. GitHub ãƒªãƒã‚¸ãƒˆãƒªã® Settings â†’ Secrets and variables â†’ Variables"
            echo "4. GITGUARDIAN_API_KEY ã‚’æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã§æ›´æ–°"
            echo ""
            echo "è©³ç´°: trouble_docs/2025-11-24-gitguardian-api-key-scope.md"
            echo "scan_error=scope_missing" >> "$GITHUB_OUTPUT"
            exit 1
          elif echo "$SCAN_OUTPUT" | grep -q -E "(401|403|Unauthorized|Forbidden)"; then
            echo "::error::âŒ GitGuardian API Key ãŒç„¡åŠ¹ã¾ãŸã¯æ¨©é™ä¸è¶³ã§ã™"
            echo ""
            echo "ğŸ“‹ è§£æ±ºæ‰‹é †:"
            echo "1. API Key ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª"
            echo "2. API Key ã« 'scan' ã‚¹ã‚³ãƒ¼ãƒ—ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª"
            echo "3. https://dashboard.gitguardian.com/api/personal-access-tokens ã§æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆ"
            echo "scan_error=auth_failed" >> "$GITHUB_OUTPUT"
            exit 1
          elif [ $SCAN_EXIT_CODE -ne 0 ] && [ ! -f gitguardian-results.json ]; then
            echo "::warning::âš ï¸ GitGuardian ã‚¹ã‚­ãƒ£ãƒ³ãŒå¤±æ•—ã—ã¾ã—ãŸãŒã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ç¶™ç¶šã—ã¾ã™"
            echo "$SCAN_OUTPUT"
            echo "scan_error=unknown" >> "$GITHUB_OUTPUT"
          else
            echo "âœ… GitGuardian ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†"
            echo "scan_error=none" >> "$GITHUB_OUTPUT"
          fi

          # æ¤œå‡ºãŒã‚ã‚‹ã‹ç¢ºèª
          if [ -f gitguardian-results.json ] && [ -s gitguardian-results.json ]; then
            echo "âœ… GitGuardian ã‚¹ã‚­ãƒ£ãƒ³çµæœã‚’å–å¾—"
          else
            echo "âš ï¸ ã‚¹ã‚­ãƒ£ãƒ³çµæœãªã—"
            echo '{"secrets":[]}' > gitguardian-results.json
          fi

          exit 0
        env:
          GITGUARDIAN_API_KEY: ${{ vars.GITGUARDIAN_API_KEY }}

      - name: GitGuardian æœªè¨­å®šæ™‚ã®ç©ºãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
        if: steps.check-api-key.outputs.has_key == 'false'
        run: |
          echo '{"secrets":[]}' > gitguardian-results.json

      - name: GitGuardian çµæœã‚’ SARIF å¤‰æ›
        continue-on-error: true
        run: |
          cat > convert-gg-to-sarif.py << 'PYEOF'
          import json
          import sys
          from datetime import datetime

          # GitGuardian JSON ã‚’èª­ã¿è¾¼ã¿
          try:
              with open('gitguardian-results.json', 'r', encoding='utf-8') as f:
                  gg_data = json.load(f)
          except:
              gg_data = {"scans": []}

          # SARIF ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆç”Ÿæˆ
          sarif = {
              "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
              "version": "2.1.0",
              "runs": [{
                  "tool": {
                      "driver": {
                          "name": "GitGuardian",
                          "version": "1.0",
                          "informationUri": "https://www.gitguardian.com/"
                      }
                  },
                  "results": []
              }]
          }

          # GitGuardian ã®å®Ÿéš›ã® JSON æ§‹é€ ã‚’è§£æ
          # æ§‹é€ : { "scans": [ { "entities_with_incidents": [ { "filename": "...", "incidents": [...] } ] } ] }
          if isinstance(gg_data, dict) and "scans" in gg_data:
              scans = gg_data.get("scans", [])
              for scan in scans:
                  if not isinstance(scan, dict):
                      continue
                  
                  # å„ã‚³ãƒŸãƒƒãƒˆã® entities_with_incidents ã‚’å‡¦ç†
                  entities = scan.get("entities_with_incidents", [])
                  for entity in entities:
                      if not isinstance(entity, dict):
                          continue
                      
                      filename = entity.get("filename", "unknown")
                      incidents = entity.get("incidents", [])
                      
                      # å„ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆã‚’ SARIF ã«å¤‰æ›
                      for incident in incidents:
                          if not isinstance(incident, dict):
                              continue
                          
                          incident_type = incident.get("type", "secret-detected")
                          policy = incident.get("policy", "Secrets detection")
                          occurrences = incident.get("occurrences", [])
                          
                          # æœ€åˆã® occurrence ã‹ã‚‰ä½ç½®æƒ…å ±ã‚’å–å¾—
                          line_start = 1
                          line_end = 1
                          if occurrences and isinstance(occurrences, list) and len(occurrences) > 0:
                              first_occ = occurrences[0]
                              if isinstance(first_occ, dict):
                                  line_start = first_occ.get("line_start", 1)
                                  line_end = first_occ.get("line_end", line_start)
                          
                          # SARIF result ã«è¿½åŠ 
                          sarif["runs"][0]["results"].append({
                              "ruleId": f"gitguardian/{incident_type}",
                              "level": "error",
                              "message": {
                                  "text": f"GitGuardian detected {incident_type} in {filename}"
                              },
                              "locations": [{
                                  "physicalLocation": {
                                      "artifactLocation": {
                                          "uri": filename
                                      },
                                      "region": {
                                          "startLine": line_start,
                                          "endLine": line_end
                                      }
                                  }
                              }],
                              "properties": {
                                  "severity": "HIGH",
                                  "policy": policy
                              }
                          })

          # SARIF ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›
          with open('gitguardian-repo.sarif', 'w', encoding='utf-8') as f:
              json.dump(sarif, f, indent=2, ensure_ascii=False)

          print(f"âœ… SARIF å¤‰æ›å®Œäº†: {len(sarif['runs'][0]['results'])} ä»¶ã®æ¤œå‡º")
          PYEOF

          python convert-gg-to-sarif.py

      - name: GitGuardian SARIF ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: steps.check-api-key.outputs.has_key == 'true' && github.actor != 'dependabot[bot]'
        uses: github/codeql-action/upload-sarif@v4
        continue-on-error: true
        with:
          sarif_file: gitguardian-repo.sarif
          category: gitguardian

      - name: æ¤œå‡ºæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
        id: count_issues
        if: always()
        run: |
          if [ -f gitguardian-repo.sarif ]; then
            ISSUES=$(jq '.runs[0].results | length' gitguardian-repo.sarif 2>/dev/null || echo "0")
          else
            ISSUES=0
          fi
          echo "issues=$ISSUES" >> "$GITHUB_OUTPUT"
          echo "GitGuardian: $ISSUES ä»¶ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œå‡º"

          # ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã‚’ãƒ­ã‚°ã«å‡ºåŠ›ï¼ˆã‚µãƒãƒªã«ã¯æ›¸ãè¾¼ã¾ãªã„ï¼‰
          SCAN_ERROR="${{ steps.gg_scan.outputs.scan_error || 'none' }}"
          HAS_KEY="${{ steps.check-api-key.outputs.has_key }}"

          if [ "$HAS_KEY" != "true" ]; then
            echo "âš ï¸ GitGuardian API Key æœªè¨­å®š - ã‚¹ã‚­ãƒ£ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ"
          elif [ "$SCAN_ERROR" = "scope_missing" ]; then
            echo "âŒ GitGuardian API Key ã« 'scan' ã‚¹ã‚³ãƒ¼ãƒ—ãŒä¸è¶³ã—ã¦ã„ã¾ã™"
          elif [ "$SCAN_ERROR" = "auth_failed" ]; then
            echo "âŒ GitGuardian èªè¨¼ã‚¨ãƒ©ãƒ¼ - API Key ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
          elif [ "$SCAN_ERROR" != "none" ]; then
            echo "âš ï¸ GitGuardian ã‚¹ã‚­ãƒ£ãƒ³ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
          fi

      - name: GitGuardian çµæœã‚’ Artifact ã¨ã—ã¦ä¿å­˜
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gitguardian-results
          path: |
            gitguardian-repo.sarif
            gitguardian-results.json
          retention-days: 7
          if-no-files-found: warn

  # ä¸¦åˆ—å®Ÿè¡Œã‚°ãƒ«ãƒ¼ãƒ—3: Trivy IaC ã‚¹ã‚­ãƒ£ãƒ³ (Bicep/K8s)
  trivy-iac:
    name: Trivy IaC (Bicep/K8s)
    runs-on: ubuntu-latest
    steps:
      - name: ã‚³ãƒ¼ãƒ‰å–å¾—
        uses: actions/checkout@v4

      - name: Trivy DB ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¾©å…ƒ
        uses: actions/cache@v4
        with:
          path: ~/.cache/trivy
          key: trivy-db-${{ runner.os }}-${{ hashFiles('infra/**/*.bicep', 'app/**/k8s/**/*.yaml') }}
          restore-keys: |
            trivy-db-${{ runner.os }}-

      - name: Trivy CLI ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          set -euo pipefail
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
          trivy --version

      - name: Bicep (infra/) è¨­å®š & ç§˜å¯†æƒ…å ± & ãƒŸã‚¹ã‚³ãƒ³ãƒ•ã‚£ã‚° ã‚¹ã‚­ãƒ£ãƒ³ (SARIF)
        continue-on-error: true
        run: |
          set -euo pipefail
          trivy fs infra \
            --scanners config,secret \
            --severity CRITICAL,HIGH,MEDIUM \
            --format sarif --output trivy-infra.sarif \
            --ignore-unfixed

      - name: Kubernetes ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ (board-app/k8s) ã‚¹ã‚­ãƒ£ãƒ³ (SARIF)
        continue-on-error: true
        run: |
          set -euo pipefail
          trivy fs app/board-app/k8s \
            --scanners config,secret \
            --severity CRITICAL,HIGH,MEDIUM \
            --format sarif --output trivy-k8s.sarif \
            --ignore-unfixed

      - name: Trivy SARIF ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (infra)
        if: github.actor != 'dependabot[bot]'
        uses: github/codeql-action/upload-sarif@v4
        continue-on-error: true
        with:
          sarif_file: trivy-infra.sarif
          category: trivy-infra

      - name: Trivy SARIF ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (k8s)
        if: github.actor != 'dependabot[bot]'
        uses: github/codeql-action/upload-sarif@v4
        continue-on-error: true
        with:
          sarif_file: trivy-k8s.sarif
          category: trivy-k8s

      - name: Trivy IaC SARIF ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-iac-sarif
          path: |
            trivy-infra.sarif
            trivy-k8s.sarif
          if-no-files-found: warn

  # ä¸¦åˆ—å®Ÿè¡Œã‚°ãƒ«ãƒ¼ãƒ—4: Trivy FS å…¨ä½“ã‚¹ã‚­ãƒ£ãƒ³
  trivy-filesystem:
    name: Trivy FileSystem (è„†å¼±æ€§ãƒ»ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ)
    runs-on: ubuntu-latest
    steps:
      - name: ã‚³ãƒ¼ãƒ‰å–å¾—
        uses: actions/checkout@v4

      - name: Trivy DB ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¾©å…ƒ
        uses: actions/cache@v4
        with:
          path: ~/.cache/trivy
          key: trivy-db-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            trivy-db-${{ runner.os }}-

      - name: Trivy CLI ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          set -euo pipefail
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
          trivy --version

      - name: Trivy ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã‚’ã‚¹ã‚­ãƒ£ãƒ³ (è„†å¼±æ€§ + ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ + è¨­å®š)
        continue-on-error: true
        run: |
          set -euo pipefail
          trivy fs . \
            --scanners vuln,secret,config \
            --severity CRITICAL,HIGH \
            --format sarif --output trivy-fs-all.sarif \
            --ignore-unfixed || echo "âš ï¸ è„†å¼±æ€§/ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œå‡ºã‚ã‚Šï¼ˆè­¦å‘Šï¼‰"

      - name: Trivy SARIF ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (å…¨ä½“)
        if: github.actor != 'dependabot[bot]'
        uses: github/codeql-action/upload-sarif@v4
        continue-on-error: true
        with:
          sarif_file: trivy-fs-all.sarif
          category: trivy-filesystem

      - name: Trivy FS SARIF ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-fs-sarif
          path: trivy-fs-all.sarif
          if-no-files-found: warn

  # ä¸¦åˆ—å®Ÿè¡Œã‚°ãƒ«ãƒ¼ãƒ—5: ãƒ“ãƒ«ãƒ‰æ¸ˆã¿ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¹ã‚­ãƒ£ãƒ³çµæœã®åé›†
  trivy-images:
    name: Trivy Images (ãƒ“ãƒ«ãƒ‰æ¸ˆã¿)
    runs-on: ubuntu-latest
    steps:
      - name: æœ€æ–°ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’å–å¾— (Board App)
        uses: dawidd6/action-download-artifact@v6
        continue-on-error: true
        with:
          workflow: 2-board-app-build-deploy.yml
          name: board-app-image
          path: build-artifacts/board

      - name: æœ€æ–°ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’å–å¾— (Admin App)
        uses: dawidd6/action-download-artifact@v6
        continue-on-error: true
        with:
          workflow: 2-admin-app-build-deploy.yml
          name: admin-app-image
          path: build-artifacts/admin

      - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã® SARIF ã‚’çµ±åˆ
        run: |
          mkdir -p sarif
          # Board App ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¹ã‚­ãƒ£ãƒ³çµæœã‚’ã‚³ãƒ”ãƒ¼
          if [ -f build-artifacts/board/trivy-image-board.sarif ]; then
            cp build-artifacts/board/trivy-image-board.sarif sarif/
            echo "âœ“ Board App ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¹ã‚­ãƒ£ãƒ³å–å¾—"
          fi
          # Admin App ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¹ã‚­ãƒ£ãƒ³çµæœã‚’ã‚³ãƒ”ãƒ¼
          if [ -f build-artifacts/admin/trivy-image-admin.sarif ]; then
            cp build-artifacts/admin/trivy-image-admin.sarif sarif/
            echo "âœ“ Admin App ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¹ã‚­ãƒ£ãƒ³å–å¾—"
          fi
          ls -la sarif/ || true

      - name: Trivy Images SARIF ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-images-sarif
          path: sarif/*.sarif
          if-no-files-found: ignore

  # çµ±åˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ (å…¨ä¸¦åˆ—ã‚¸ãƒ§ãƒ–å®Œäº†å¾Œã«å®Ÿè¡Œ)
  summary:
    name: ã¾ã¨ã‚ãƒ¬ãƒãƒ¼ãƒˆ
    runs-on: ubuntu-latest
    needs:
      [
        codeql,
        gitleaks-scan,
        gitguardian-scan,
        trivy-iac,
        trivy-filesystem,
        trivy-images,
      ]
    if: always()
    steps:
      - name: ã™ã¹ã¦ã® SARIF ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’å–å¾—
        uses: actions/download-artifact@v4
        with:
          path: all-sarif

      - name: SARIF ãƒ•ã‚¡ã‚¤ãƒ«ã‚’çµ±åˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é›†ç´„
        run: |
          mkdir -p sarif

          # ã™ã¹ã¦ã® SARIF ãƒ•ã‚¡ã‚¤ãƒ«ã‚’çµ±åˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼ï¼ˆã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä¿æŒã—ãªã„ï¼‰
          find all-sarif -type f -name "*.sarif" -exec cp -v {} sarif/ \;

          # ã‚³ãƒ”ãƒ¼çµæœã‚’ç¢ºèª
          echo "=== çµ±åˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª (sarif/) ã® SARIF ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ ==="
          ls -lah sarif/ || echo "âš ï¸ SARIF ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"

          # GitGuardian ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          echo ""
          echo "=== GitGuardian SARIF ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª ==="
          if ls sarif/*gitguardian*.sarif 1> /dev/null 2>&1; then
            echo "âœ… GitGuardian SARIF ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:"
            ls -lh sarif/*gitguardian*.sarif
          else
            echo "âš ï¸ GitGuardian SARIF ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "ğŸ“ all-sarif/ ã® GitGuardian ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¢ç´¢:"
            find all-sarif -type f \( -name "*gitguardian*" -o -name "*guardian*" \) -ls || echo "è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
          fi

      - name: ã‚«ãƒ†ã‚´ãƒªåˆ¥ä¸Šä½æ¤œå‡ºæŠ½å‡º (å„ã‚«ãƒ†ã‚´ãƒªä¸Šä½5ä»¶)
        run: |
          set -euo pipefail
          TOP_FILE=top-findings.md
          JSON_FILE=top-findings.json
          echo "### ğŸ“ ã‚«ãƒ†ã‚´ãƒªåˆ¥ã‚¢ãƒ©ãƒ¼ãƒˆ (å„ä¸Šä½5ä»¶)" > $TOP_FILE
          echo "" >> $TOP_FILE

          # ã‚«ãƒ†ã‚´ãƒªå®šç¾©: ãƒ•ã‚¡ã‚¤ãƒ«åãƒ‘ã‚¿ãƒ¼ãƒ³ â†’ ã‚«ãƒ†ã‚´ãƒªå â†’ ã‚¢ã‚¤ã‚³ãƒ³
          declare -A CATEGORIES=(
            ["codeql"]="ğŸ” CodeQL (JS/Python ã‚³ãƒ¼ãƒ‰å“è³ª)"
            ["gitleaks"]="ğŸ”‘ Gitleaks (ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¼æ´©)"
            ["gitguardian"]="ğŸ›¡ï¸ GitGuardian (ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œè¨¼)"
            ["trivy-image"]="ğŸ³ Trivy Image (ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸è„†å¼±æ€§)"
            ["trivy-fs"]="ğŸ›¡ï¸ Trivy FileSystem (è„†å¼±æ€§ãƒ»ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ)"
            ["trivy-infra"]="ğŸ—ï¸ Trivy Infra (Bicep è¨­å®šãƒŸã‚¹)"
            ["trivy-k8s"]="â˜¸ï¸ Trivy K8s (Kubernetes è¨­å®š)"
          )

          echo '{"categorizedFindings":{' > $JSON_FILE
          FIRST_CAT=1

          MAX_MSG_LEN=300
          for PATTERN in codeql gitleaks gitguardian trivy-image trivy-fs trivy-infra trivy-k8s; do
            CAT_NAME="${CATEGORIES[$PATTERN]}"
            
            # ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆå–å¾—ï¼ˆçµ±åˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰ï¼‰
            # ã‚·ã‚§ãƒ«ã‚°ãƒ­ãƒ–ã‚’ä½¿ç”¨ã—ã¦ã‚ˆã‚Šç¢ºå®Ÿã«ãƒãƒƒãƒãƒ³ã‚°
            shopt -s nullglob
            FILES=(sarif/*${PATTERN}*.sarif)
            shopt -u nullglob
            
            if [ ${#FILES[@]} -eq 0 ]; then
              # ãƒ‡ãƒãƒƒã‚°: ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
              echo "[DEBUG] $PATTERN: ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ" >&2
              echo "[DEBUG] sarif/ ã®å…¨ãƒ•ã‚¡ã‚¤ãƒ«:" >&2
              ls -1 sarif/*.sarif 2>&1 | head -n 10 >&2 || echo "  (SARIFãƒ•ã‚¡ã‚¤ãƒ«ãªã—)" >&2
              continue
            fi
            
            # ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«æ¤œå‡ºæŠ½å‡ºï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åãƒ»è¡Œç•ªå·ã‚‚å–å¾—ï¼‰
            ALL=$(for f in "${FILES[@]}"; do
              jq -r --arg SRC "$f" '
                .runs[]? .results[]? | {
                  rid:(.ruleId // "(ruleä¸æ˜)"),
                  lvl:(.level // "warning"),
                  sev:(.properties.severity // .properties["security-severity"] // .rule.properties.severity // "MEDIUM"),
                  msg:(.message.text // ""),
                  file:(.locations[0].physicalLocation.artifactLocation.uri // "ä¸æ˜"),
                  line:(.locations[0].physicalLocation.region.startLine // 0)
                } | [
                  (if (.sev|ascii_upcase)=="CRITICAL" then 0 elif (.sev|ascii_upcase)=="HIGH" then 1 elif (.sev|ascii_upcase)=="MEDIUM" then 2 elif (.sev|ascii_upcase)=="LOW" then 3 else 4 end),
                  (if .lvl=="error" then 0 elif .lvl=="warning" then 1 else 2 end),
                  (.sev|ascii_upcase),
                  .rid,
                  .file,
                  .line,
                  (.msg | gsub("\n"; " ") | gsub(" {2,}"; " "))
                ] | @tsv' "$f" 2>/dev/null || true
            done)
            
            if [ -n "$ALL" ]; then
              TOP5=$(echo "$ALL" | sort -t$'\t' -k1,1n -k2,2n | head -n 5)
              echo "#### $CAT_NAME" >> $TOP_FILE
              echo "" >> $TOP_FILE
              
              [ $FIRST_CAT -eq 0 ] && echo "," >> $JSON_FILE
              echo "\"$PATTERN\":[" >> $JSON_FILE
              FIRST_CAT=0
              
              COUNT=0
              while IFS=$'\t' read -r SEV_RANK LVL_RANK SEV RULE FILE LINE MSG; do
                COUNT=$((COUNT+1))
                DISPLAY_MSG="$MSG"
                if [ ${#DISPLAY_MSG} -gt $MAX_MSG_LEN ]; then
                  DISPLAY_MSG="${DISPLAY_MSG:0:MAX_MSG_LEN}..."
                fi
                
                # ãƒ•ã‚¡ã‚¤ãƒ«åã‚’çŸ­ç¸®è¡¨ç¤ºï¼ˆãƒ‘ã‚¹ãŒé•·ã„å ´åˆï¼‰
                SHORT_FILE="$FILE"
                if [ ${#FILE} -gt 50 ]; then
                  SHORT_FILE="...${FILE: -47}"
                fi
                
                # è¡Œç•ªå·ãŒã‚ã‚‹å ´åˆã¯è¡¨ç¤º
                LOCATION="$SHORT_FILE"
                if [ "$LINE" != "0" ]; then
                  LOCATION="$SHORT_FILE:$LINE"
                fi
                
                echo "$COUNT. **$SEV** / \`$RULE\`" >> $TOP_FILE
                echo "   - ğŸ“ \`$LOCATION\`" >> $TOP_FILE
                echo "   - ğŸ’¬ $DISPLAY_MSG" >> $TOP_FILE
                echo "" >> $TOP_FILE
                
                ESC_MSG=$(echo "$MSG" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g')
                ESC_FILE=$(echo "$FILE" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g')
                SEP=','; [ $COUNT -eq 1 ] && SEP=''
                echo "${SEP}{\"severity\":\"$SEV\",\"ruleId\":\"$RULE\",\"file\":\"$ESC_FILE\",\"line\":$LINE,\"message\":\"$ESC_MSG\"}" >> $JSON_FILE
              done <<< "$TOP5"
              
              echo "]" >> $JSON_FILE
              echo "" >> $TOP_FILE
            fi
          done

          echo '},"generatedAt":"'$(date -u +'%Y-%m-%dT%H:%M:%SZ')'"}' >> $JSON_FILE

          # ã‚µãƒãƒªãŒãªã„å ´åˆ
          if [ $FIRST_CAT -eq 1 ]; then
            echo "é«˜å„ªå…ˆåº¦æ¤œå‡ºãªã— (error/warning 0ä»¶)" >> $TOP_FILE
          fi

          cat $TOP_FILE >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "(æ©Ÿæ¢°å¯èª­JSON: top-findings.json ã‚’ artifact ã¨ã—ã¦ä¿å­˜)" >> $GITHUB_STEP_SUMMARY

      - name: ä¸Šä½æ¤œå‡ºJSONä¿å­˜ (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: security-top-findings-json
          path: top-findings.json

      - name: ã‚¹ã‚­ãƒ£ãƒ³çµæœã‚µãƒãƒªã‚’å‡ºåŠ›
        run: |
          echo "## ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š å®Ÿè¡Œã•ã‚ŒãŸã‚¹ã‚­ãƒ£ãƒ³" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **CodeQL** - JavaScript & Python ã®ã‚³ãƒ¼ãƒ‰å“è³ªãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æ" >> $GITHUB_STEP_SUMMARY
          echo "2. **Gitleaks** - ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒ»èªè¨¼æƒ…å ±ã®æ¼æ´©æ¤œå‡ºï¼ˆå…¨å±¥æ­´ï¼‰" >> $GITHUB_STEP_SUMMARY

          # GitGuardian çµæœï¼ˆè©³ç´°è¡¨ç¤º + ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼‰
          GG_ISSUES="${{ needs.gitguardian-scan.outputs.gitguardian_issues || '0' }}"
          HAS_KEY="${{ needs.gitguardian-scan.outputs.has_key || 'true' }}"
          SCAN_ERROR="${{ needs.gitguardian-scan.outputs.scan_error || 'none' }}"

          if [ "$HAS_KEY" != "true" ]; then
            echo "3. **GitGuardian** - âš ï¸ API Key æœªè¨­å®šï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰" >> $GITHUB_STEP_SUMMARY
            echo "   - ğŸ’¡ [è¨­å®šæ‰‹é †](https://dashboard.gitguardian.com/api/personal-access-tokens) ã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆã—ã€Variables ã« \`GITGUARDIAN_API_KEY\` ã‚’è¨­å®š" >> $GITHUB_STEP_SUMMARY
            echo "   - å¿…è¦ãªã‚¹ã‚³ãƒ¼ãƒ—: **scan** (å¿…é ˆ), incident:read, incident:write" >> $GITHUB_STEP_SUMMARY
          elif [ "$SCAN_ERROR" = "scope_missing" ]; then
            echo "3. **GitGuardian** - âŒ 'scan' ã‚¹ã‚³ãƒ¼ãƒ—ä¸è¶³" >> $GITHUB_STEP_SUMMARY
            echo "   - API Key ã«å¿…é ˆã® **scan** ã‚¹ã‚³ãƒ¼ãƒ—ãŒä¸è¶³ã—ã¦ã„ã¾ã™" >> $GITHUB_STEP_SUMMARY
            echo "   - ğŸ’¡ [GitGuardian Dashboard](https://dashboard.gitguardian.com/api/personal-access-tokens) ã§æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆ" >> $GITHUB_STEP_SUMMARY
            echo "   - ğŸ“– è©³ç´°: \`trouble_docs/2025-11-24-gitguardian-api-key-scope.md\`" >> $GITHUB_STEP_SUMMARY
          elif [ "$SCAN_ERROR" = "auth_failed" ]; then
            echo "3. **GitGuardian** - âŒ èªè¨¼ã‚¨ãƒ©ãƒ¼" >> $GITHUB_STEP_SUMMARY
            echo "   - API Key ãŒç„¡åŠ¹ã¾ãŸã¯æ¨©é™ä¸è¶³ã§ã™" >> $GITHUB_STEP_SUMMARY
            echo "   - ğŸ’¡ [GitGuardian Dashboard](https://dashboard.gitguardian.com/api/personal-access-tokens) ã§æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆ" >> $GITHUB_STEP_SUMMARY
          elif [ "$SCAN_ERROR" != "none" ]; then
            echo "3. **GitGuardian** - âš ï¸ ã‚¹ã‚­ãƒ£ãƒ³ã‚¨ãƒ©ãƒ¼" >> $GITHUB_STEP_SUMMARY
            echo "   - ã‚¹ã‚­ãƒ£ãƒ³ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼ˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ç¶™ç¶šï¼‰" >> $GITHUB_STEP_SUMMARY
          elif [ "$GG_ISSUES" = "0" ]; then
            echo "3. **GitGuardian** - âœ… ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãªã— (400+ ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œè¨¼)" >> $GITHUB_STEP_SUMMARY
          else
            echo "3. **GitGuardian** - âš ï¸ $GG_ISSUES ä»¶ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œå‡º (400+ ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œè¨¼)" >> $GITHUB_STEP_SUMMARY
            
            # GitGuardian ã®è©³ç´°ã‚’å–å¾—ï¼ˆartifact ã‹ã‚‰ SARIF ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰
            if [ -f all-sarif/gitguardian-results/gitguardian-repo.sarif ]; then
              echo "   **æ¤œå‡ºã•ã‚ŒãŸã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆï¼ˆä¸Šä½5ä»¶ï¼‰:**" >> $GITHUB_STEP_SUMMARY
              jq -r '.runs[0].results[0:5] | .[] | "   - \(.ruleId): \(.message.text) (\(.locations[0].physicalLocation.artifactLocation.uri):\(.locations[0].physicalLocation.region.startLine))"' \
                all-sarif/gitguardian-results/gitguardian-repo.sarif >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "   - (è©³ç´°å–å¾—å¤±æ•—)" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "4. **Trivy (FSå…¨ä½“)** - è„†å¼±æ€§ + ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ + è¨­å®šãƒŸã‚¹æ¤œå‡º" >> $GITHUB_STEP_SUMMARY
          echo "5. **Trivy (Bicep)** - ã‚¤ãƒ³ãƒ•ãƒ©ã‚³ãƒ¼ãƒ‰ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³" >> $GITHUB_STEP_SUMMARY
          echo "6. **Trivy (Kubernetes)** - K8sãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ” çµæœç¢ºèª" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ã™ã¹ã¦ã®æ¤œå‡ºçµæœã¯ä»¥ä¸‹ã§ç¢ºèªã§ãã¾ã™ï¼š" >> $GITHUB_STEP_SUMMARY
          echo "- [Security ã‚¿ãƒ– - Code scanning alerts](/${{ github.repository }}/security/code-scanning)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ ã‚«ãƒ†ã‚´ãƒªåˆ¥ã‚¢ãƒ©ãƒ¼ãƒˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **codeql**: JavaScript/Python ã‚³ãƒ¼ãƒ‰å“è³ª" >> $GITHUB_STEP_SUMMARY
          echo "- **gitleaks**: ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¼æ´©ï¼ˆãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "- **gitguardian**: ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¼æ´©ï¼ˆæœ‰åŠ¹æ€§æ¤œè¨¼ä»˜ãï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "- **trivy-filesystem**: å…¨ä½“çš„ãªè„†å¼±æ€§ãƒ»ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ" >> $GITHUB_STEP_SUMMARY
          echo "- **trivy-infra**: Bicep è¨­å®šãƒŸã‚¹" >> $GITHUB_STEP_SUMMARY
          echo "- **trivy-k8s**: Kubernetes è¨­å®šãƒŸã‚¹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> âš ï¸ Code scanning ãŒæœªæœ‰åŠ¹ã®å ´åˆã€SARIF ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¯è­¦å‘Šæ‰±ã„/ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã™ã€‚ãƒªãƒã‚¸ãƒˆãƒªè¨­å®šã‹ã‚‰æœ‰åŠ¹åŒ–ã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "âœ… ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œæ—¥æ™‚: $(date +'%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”„ æ¬¡å›å®šæœŸå®Ÿè¡Œ: æ¯æ—¥ 12:00 JST" >> $GITHUB_STEP_SUMMARY

# ã‚³ãƒ¡ãƒ³ãƒˆ:
# - CodeQL: JavaScript(React/Vite) ã¨ Python(FastAPI/Flaskç­‰) ã‚’ security-extended ã‚¯ã‚¨ãƒªã§è§£æã€‚
# - IaC: Bicep ã¨ Kubernetes YAML ã‚’ Trivy config+secret ã‚¹ã‚­ãƒ£ãƒŠã§ã‚¹ã‚­ãƒ£ãƒ³ã—ã€ãƒŸã‚¹ã‚³ãƒ³ãƒ•ã‚£ã‚°/ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¼æ´©ã‚’æ¤œå‡ºã€‚
# - SARIF: GitHub Security(Code scanning alerts) ã«é›†ç´„ã—ã€ãƒ¬ãƒ“ãƒ¥ãƒ¼åŠ¹ç‡åŒ–ã€‚
# - å®šæœŸå®Ÿè¡Œ: cron ã«ã‚ˆã‚Šæ—¥æ¬¡ã®ãƒ‰ãƒªãƒ•ãƒˆ/æ–°è¦è„†å¼±æ€§æ¤œçŸ¥ã‚’è‡ªå‹•åŒ–ã€‚
# - å¤±æ•—æ¡ä»¶: ç¾çŠ¶ã¯ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®ã¿ã§ gating ã›ãšã€‚å¿…è¦ãªã‚‰ --exit-code 1 ã‚’è¿½åŠ ã— PR ãƒ–ãƒ­ãƒƒã‚¯å¯èƒ½ã€‚

# AKS DNS è§£æ±ºå¤±æ•—ã®ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

## ğŸ“‹ å•é¡Œã®æ¦‚è¦

Board App Build & Deploy ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ã€ŒAKS æ¥ç¶šã‚’æ¤œè¨¼ã€ã‚¹ãƒ†ãƒƒãƒ—ã§ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿï¼š

```
server can't find aksdemodev-nxzok1nt.hcp.japaneast.azmk8s.io: NXDOMAIN
âŒ DNS è§£æ±ºã«å¤±æ•—ã—ã¾ã—ãŸ
```

## ğŸ” å•é¡Œã®åŸå› 

AKS API ã‚µãƒ¼ãƒãƒ¼ã® DNS åãŒè§£æ±ºã§ããªã„åŸå› ã¯ä»¥ä¸‹ã®ã„ãšã‚Œã‹ï¼š

### 1. **AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãŒåœæ­¢ä¸­** â­ æœ€ã‚‚å¯èƒ½æ€§ãŒé«˜ã„
- AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãŒåœæ­¢çŠ¶æ…‹ï¼ˆ`Stopped`ï¼‰ã®å ´åˆã€API ã‚µãƒ¼ãƒãƒ¼ã® DNS åã¯è§£æ±ºã§ãã¾ã›ã‚“
- Azure Portal ã¾ãŸã¯ Azure CLI ã§åœæ­¢æ“ä½œãŒè¡Œã‚ã‚ŒãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™
- ã‚³ã‚¹ãƒˆå‰Šæ¸›ã®ãŸã‚ã«æ„å›³çš„ã«åœæ­¢ã•ã‚Œã¦ã„ã‚‹å ´åˆã‚‚ã‚ã‚Šã¾ã™

### 2. **DNS ä¼æ’­ã®é…å»¶**
- AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®èµ·å‹•ç›´å¾Œã¯ DNS ãŒå®Œå…¨ã«ä¼æ’­ã—ã¦ã„ãªã„å ´åˆãŒã‚ã‚Šã¾ã™
- é€šå¸¸ã¯èµ·å‹•å¾Œ 1-2 åˆ†ã§è§£æ±ºå¯èƒ½ã«ãªã‚Šã¾ã™

### 3. **AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®å†ä½œæˆ**
- Infrastructure Deploy ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§ AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãŒå‰Šé™¤ãƒ»å†ä½œæˆã•ã‚ŒãŸå ´åˆã€æ–°ã—ã„ FQDN ãŒç”Ÿæˆã•ã‚Œã¾ã™
- å¤ã„ kubeconfig ãŒæ®‹ã£ã¦ã„ã‚‹å ´åˆã€å¤ã„ FQDN ã¸ã®æ¥ç¶šã‚’è©¦ã¿ã¦å¤±æ•—ã—ã¾ã™

### 4. **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹æˆã®å•é¡Œ**
- Private Cluster ã¨ã—ã¦æ§‹æˆã•ã‚Œã¦ã„ã‚‹å ´åˆã€GitHub Actions ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“
- API Server Access Profile ã®è¨­å®šãŒæ­£ã—ããªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™

## âœ… ä¿®æ­£å†…å®¹

### è‡ªå‹•èµ·å‹•æ©Ÿèƒ½ã®è¿½åŠ 

**ä¿®æ­£å‰ï¼š**
- AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãŒåœæ­¢ã—ã¦ã„ã¦ã‚‚æ¤œå‡ºã§ããšã€DNS è§£æ±ºå¤±æ•—ã§çµ‚äº†

**ä¿®æ­£å¾Œï¼š**
1. AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®çŠ¶æ…‹ï¼ˆ`powerState`ï¼‰ã‚’ç¢ºèª
2. `Stopped` çŠ¶æ…‹ã®å ´åˆã¯è‡ªå‹•çš„ã«èµ·å‹•ï¼ˆ`az aks start`ï¼‰
3. èµ·å‹•å®Œäº†ã¾ã§å¾…æ©Ÿï¼ˆæœ€å¤§ 10 åˆ†ï¼‰
4. DNS ä¼æ’­ã‚’å¾…ã¤ãŸã‚ã«è¿½åŠ ã§ 30 ç§’å¾…æ©Ÿ
5. ãã®å¾Œã€é€šå¸¸ã®æ¥ç¶šæ¤œè¨¼ã‚’å®Ÿè¡Œ

### ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ”¹å–„

DNS è§£æ±ºã«å¤±æ•—ã—ãŸå ´åˆã€ä»¥ä¸‹ã®æƒ…å ±ã‚’è¡¨ç¤ºï¼š
- è€ƒãˆã‚‰ã‚Œã‚‹åŸå› ã®ä¸€è¦§
- AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®è©³ç´°æƒ…å ±ï¼ˆçŠ¶æ…‹ã€FQDNã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãªã©ï¼‰
- æ¨å¥¨ã•ã‚Œã‚‹å¯¾å¿œæ‰‹é †

## ğŸ› ï¸ æ‰‹å‹•ã§ã®å¯¾å¿œæ–¹æ³•

### AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®çŠ¶æ…‹ã‚’ç¢ºèª

```bash
az aks show \
  --resource-group RG-BBS-Appzz \
  --name aks-demo-dev \
  --query '{
    provisioningState: provisioningState,
    powerState: powerState.code,
    fqdn: fqdn
  }' \
  -o json
```

### AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’èµ·å‹•

```bash
# èµ·å‹•é–‹å§‹ï¼ˆéåŒæœŸï¼‰
az aks start \
  --resource-group RG-BBS-Appzz \
  --name aks-demo-dev \
  --no-wait

# èµ·å‹•å®Œäº†ã‚’å¾…æ©Ÿ
az aks wait \
  --resource-group RG-BBS-Appzz \
  --name aks-demo-dev \
  --custom "powerState.code=='Running'" \
  --timeout 600
```

### AKS ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’åœæ­¢ï¼ˆã‚³ã‚¹ãƒˆå‰Šæ¸›ï¼‰

```bash
az aks stop \
  --resource-group RG-BBS-Appzz \
  --name aks-demo-dev
```

## ğŸ“Š æƒ³å®šã•ã‚Œã‚‹å‹•ä½œãƒ•ãƒ­ãƒ¼

```mermaid
graph TD
    A[ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼é–‹å§‹] --> B[AKS è³‡æ ¼æƒ…å ±å–å¾—]
    B --> C{AKS çŠ¶æ…‹ç¢ºèª}
    C -->|Running| D[æ¥ç¶šæ¤œè¨¼ã¸]
    C -->|Stopped| E[AKS èµ·å‹•é–‹å§‹]
    E --> F[èµ·å‹•å®Œäº†å¾…æ©Ÿ<br/>æœ€å¤§10åˆ†]
    F --> G[DNSä¼æ’­å¾…æ©Ÿ<br/>30ç§’]
    G --> D
    D --> H[DNSè§£æ±ºãƒ†ã‚¹ãƒˆ]
    H -->|æˆåŠŸ| I[kubectlæ¥ç¶šãƒ†ã‚¹ãƒˆ]
    H -->|å¤±æ•—| J[è©³ç´°ã‚¨ãƒ©ãƒ¼è¡¨ç¤º]
    I -->|æˆåŠŸ| K[ãƒ‡ãƒ—ãƒ­ã‚¤ç¶šè¡Œ]
    I -->|å¤±æ•—| J
```

## ğŸ¯ æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

1. **è‡ªå‹•å¾©æ—§**: AKS ãŒåœæ­¢ã—ã¦ã„ã¦ã‚‚è‡ªå‹•çš„ã«èµ·å‹•ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ç¶™ç¶š
2. **æ˜ç¢ºãªã‚¨ãƒ©ãƒ¼**: å¤±æ•—æ™‚ã«åŸå› ã¨å¯¾å¿œæ–¹æ³•ãŒæ˜ç¤ºã•ã‚Œã‚‹
3. **ã‚³ã‚¹ãƒˆæœ€é©åŒ–**: åœæ­¢æ©Ÿèƒ½ã‚’ä½¿ã£ã¦ã‚³ã‚¹ãƒˆå‰Šæ¸›ã—ã¤ã¤ã€å¿…è¦æ™‚ã«è‡ªå‹•èµ·å‹•

## ğŸ“ é–¢é€£ãƒªãƒ³ã‚¯

- [Azure AKS Start/Stop](https://learn.microsoft.com/ja-jp/azure/aks/start-stop-cluster)
- [AKS Troubleshooting](https://learn.microsoft.com/ja-jp/troubleshoot/azure/azure-kubernetes/welcome-azure-kubernetes)
- [GitHub Issue #64](https://github.com/aktsmm/container-app-demo/issues/64)

## ğŸ”„ æ¤œè¨¼çµæœ

- ä¿®æ­£æ—¥: 2025-11-23
- ä¿®æ­£è€…: Copilot
- ãƒ†ã‚¹ãƒˆçŠ¶æ…‹: æœªæ¤œè¨¼ï¼ˆæ¬¡å›ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œæ™‚ã«ç¢ºèªï¼‰
